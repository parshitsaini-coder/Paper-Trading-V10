<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TradeSim Pro ‚Äî NSE Paper Trading</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Syne:wght@600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet"/>
<!-- Chart.js for sparklines -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<!-- TradingView Lightweight Charts ‚Äî broker-grade candlestick/line chart -->
<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<!-- Firebase SDK v9 Compat (loads synchronously) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#e8e2cc;--surface:rgba(0,0,0,0.055);--card:rgba(255,255,255,0.55);
  --border:rgba(0,0,0,0.09);--text:#1c1f21;--muted:rgba(28,31,33,0.52);
  --faint:rgba(28,31,33,0.34);--accent:#7c6244;--up:#1a6040;--down:#b83025;
  --up-bg:rgba(26,96,64,0.1);--down-bg:rgba(184,48,37,0.1);
  --nav:rgba(232,226,204,0.96);--modal:rgba(240,236,220,0.98);
  --inp:rgba(0,0,0,0.07);--inp-border:rgba(0,0,0,0.14);--sidebar:rgba(242,238,224,0.92);
  --shadow:0 1px 3px rgba(0,0,0,0.08),0 4px 16px rgba(0,0,0,0.06);
  --shadow-lg:0 2px 8px rgba(0,0,0,0.1),0 12px 40px rgba(0,0,0,0.12);
  --radius:12px;--radius-sm:8px;--radius-lg:18px;
}
body.dark{
  --bg:#0d0f14;--surface:#161921;--card:#1a1d28;--border:rgba(255,255,255,0.07);
  --text:#dfe3ec;--muted:rgba(223,227,236,0.48);--faint:rgba(223,227,236,0.28);
  --nav:rgba(13,15,20,0.96);--modal:#1c1f2e;--inp:rgba(255,255,255,0.06);
  --inp-border:rgba(255,255,255,0.1);--sidebar:#111318;--up:#38c98a;--down:#f05070;
  --up-bg:rgba(56,201,138,0.1);--down-bg:rgba(240,80,112,0.1);
  --shadow:0 1px 3px rgba(0,0,0,0.3),0 4px 16px rgba(0,0,0,0.25);
  --shadow-lg:0 2px 8px rgba(0,0,0,0.4),0 12px 40px rgba(0,0,0,0.35);
}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:background .3s,color .3s}

/* Subtle grain texture overlay */
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  opacity:0.025;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(124,98,68,.25);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:rgba(124,98,68,.4)}
.mono{font-family:'JetBrains Mono',monospace;letter-spacing:-0.02em}
.up{color:var(--up)} .down{color:var(--down)}
.sg{font-family:'Syne',sans-serif;letter-spacing:-0.02em}

/* NAV */
nav{background:var(--nav);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-bottom:1px solid var(--border);
  padding:0 20px;height:58px;display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:200;box-shadow:0 1px 0 var(--border)}
.nav-tabs{display:flex;gap:1px;flex-wrap:wrap;background:var(--surface);border-radius:10px;padding:3px}
.nav-btn{background:transparent;border:none;color:var(--muted);padding:6px 11px;border-radius:7px;
  cursor:pointer;font-size:12px;font-weight:500;transition:all .18s ease;font-family:'Outfit',sans-serif;letter-spacing:0.01em}
.nav-btn:hover{background:rgba(124,98,68,.1);color:var(--text)}
.nav-btn.active{background:var(--card);color:var(--accent);font-weight:600;
  box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.logo{display:flex;align-items:center;gap:9px}
.logo-icon{width:30px;height:30px;background:linear-gradient(135deg,#7c6244,#5e4a31);border-radius:9px;
  display:flex;align-items:center;justify-content:center;font-size:14px;
  box-shadow:0 2px 8px rgba(124,98,68,.35)}
.logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:16px;color:var(--text);letter-spacing:-0.03em}

/* SUMMARY BAR */
.summary-bar{background:var(--surface);border-bottom:1px solid var(--border);
  padding:8px 20px;display:flex;gap:0;overflow-x:auto;white-space:nowrap;align-items:stretch}
.stat-item{min-width:110px;padding:4px 20px 4px 0;border-right:1px solid var(--border);margin-right:20px}
.stat-item:last-child{border-right:none;margin-right:0}
.stat-label{font-size:9.5px;color:var(--faint);margin-bottom:3px;font-weight:500;text-transform:uppercase;letter-spacing:0.07em}
.stat-val{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:13px;letter-spacing:-0.02em}

/* MAIN LAYOUT */
.app-body{display:flex;height:calc(100vh - 116px)}
.main-area{flex:1;overflow-y:auto;padding:16px 20px;min-width:0}

/* SIDEBAR */
.sidebar{width:264px;flex-shrink:0;background:var(--sidebar);border-left:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden}
.sidebar-head{padding:12px 14px 10px;border-bottom:1px solid var(--border)}
.sidebar-search{width:100%;padding:8px 12px;background:var(--inp);border:1px solid var(--inp-border);
  border-radius:9px;color:var(--text);font-size:12px;outline:none;font-family:'Outfit',sans-serif;transition:all .2s}
.sidebar-search:focus{border-color:rgba(124,98,68,.5);background:var(--card)}
.sidebar-body{flex:1;overflow-y:auto}
.wl-item{padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer;
  position:relative;transition:background .12s}
.wl-item:hover{background:rgba(0,0,0,0.03)}
body.dark .wl-item:hover{background:rgba(255,255,255,0.03)}
.wl-bar{position:absolute;left:0;top:10px;bottom:10px;width:3px;border-radius:0 3px 3px 0}
.wl-canvas{height:34px;margin:5px 0}
.sidebar-foot{padding:8px 14px;border-top:1px solid var(--border);font-size:10px;
  color:var(--faint);text-align:center}

/* CARDS & TABLES */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;
  box-shadow:var(--shadow);backdrop-filter:blur(8px)}
.tbl-wrap{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;
  box-shadow:var(--shadow)}
.tbl-head{display:grid;padding:9px 16px;border-bottom:1px solid var(--border);background:var(--surface)}
.tbl-head span{font-size:10px;font-weight:700;color:var(--faint);text-transform:uppercase;letter-spacing:.06em}
.tbl-body{overflow-y:auto}
.stock-row{display:grid;padding:10px 16px;border-bottom:1px solid var(--border);cursor:pointer;
  transition:background .12s;align-items:center}
.stock-row:hover{background:rgba(124,98,68,0.05)}
body.dark .stock-row:hover{background:rgba(255,255,255,0.035)}
.badge{padding:2px 8px;border-radius:5px;font-size:10px;font-weight:700;letter-spacing:0.02em}
.badge-buy{background:var(--up-bg);color:var(--up)}
.badge-sell{background:var(--down-bg);color:var(--down)}

/* BUTTONS */
.btn-buy{background:linear-gradient(135deg,#7c6244,#5e4a31);border:none;color:#fff;padding:6px 14px;
  border-radius:var(--radius-sm);font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;font-size:12px;
  transition:all .18s ease;letter-spacing:0.02em}
.btn-buy:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(124,98,68,.45);filter:brightness(1.1)}
.btn-buy:active{transform:translateY(0)}
.btn-sell{background:linear-gradient(135deg,#c0352a,#9e2b22);border:none;color:#fff;padding:6px 14px;
  border-radius:var(--radius-sm);font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;font-size:12px;
  transition:all .18s ease;letter-spacing:0.02em}
.btn-sell:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(192,53,42,.4);filter:brightness(1.1)}
.btn-sell:active{transform:translateY(0)}
.btn-gtt{background:linear-gradient(135deg,#3e7aaa,#2d5e8a);border:none;color:#fff;padding:5px 9px;
  border-radius:var(--radius-sm);font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;font-size:11px;
  transition:all .18s ease}
.btn-gtt:hover{transform:translateY(-1px);filter:brightness(1.1)}
.btn-neutral{padding:7px 14px;background:var(--inp);border:1px solid var(--inp-border);
  border-radius:var(--radius-sm);color:var(--text);font-size:12px;cursor:pointer;font-family:'Outfit',sans-serif;
  transition:all .15s}
.btn-neutral:hover{background:var(--card);border-color:rgba(124,98,68,.3)}
.tag-btn{padding:4px 12px;border-radius:20px;border:1px solid var(--border);background:transparent;
  color:var(--muted);font-size:11px;cursor:pointer;transition:all .18s;font-family:'Outfit',sans-serif;
  white-space:nowrap;font-weight:500}
.tag-btn.active{background:rgba(124,98,68,.14);border-color:rgba(124,98,68,.5);color:var(--accent);font-weight:600}

/* TOGGLE */
.toggle-sw{position:relative;width:42px;height:22px;display:inline-block}
.toggle-sw input{opacity:0;width:0;height:0}
.tog-slider{position:absolute;cursor:pointer;inset:0;background:rgba(124,98,68,.25);border-radius:22px;transition:.28s ease}
.tog-slider:before{position:absolute;content:'';height:16px;width:16px;left:3px;bottom:3px;background:#fff;
  border-radius:50%;transition:.28s ease;box-shadow:0 1px 3px rgba(0,0,0,0.2)}
input:checked+.tog-slider{background:linear-gradient(135deg,#7c6244,#5e4a31)}
input:checked+.tog-slider:before{transform:translateX(20px)}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.72);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  display:flex;align-items:center;justify-content:center;z-index:1000;padding:16px;overflow-y:auto}
.modal{background:var(--modal);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;
  width:100%;max-width:440px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
.inp{width:100%;padding:10px 14px;background:var(--inp);border:1px solid var(--inp-border);
  border-radius:9px;color:var(--text);font-size:13px;outline:none;font-family:'Outfit',sans-serif;transition:all .2s}
.inp:focus{border-color:rgba(124,98,68,.6);background:var(--card);box-shadow:0 0 0 3px rgba(124,98,68,.1)}
.tab-pill{padding:5px 14px;border-radius:20px;border:none;background:transparent;color:var(--muted);
  font-size:12px;font-weight:500;cursor:pointer;font-family:'Outfit',sans-serif;transition:all .18s}
.tab-pill.active{background:rgba(124,98,68,.14);color:var(--accent);font-weight:600}

/* NOTIFICATION */
.notif{position:fixed;top:68px;right:16px;z-index:9999;padding:12px 18px;border-radius:12px;
  font-size:13px;font-weight:500;animation:slideIn .25s cubic-bezier(.34,1.56,.64,1);max-width:320px;
  pointer-events:none;backdrop-filter:blur(16px)}
@keyframes slideIn{from{transform:translateX(110px) scale(0.95);opacity:0}to{transform:translateX(0) scale(1);opacity:1}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* MARKET STATUS */
.mkt-badge{display:flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:0.04em}
.mkt-dot{width:6px;height:6px;border-radius:50%}

/* AUTH */
.auth-wrap{min-height:100vh;background:linear-gradient(145deg,#ccc5a3 0%,#dfd9bc 45%,#e8e3cc 100%);
  display:flex;align-items:center;justify-content:center;padding:20px;position:relative;overflow:hidden}
.auth-wrap::before{content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse at 20% 50%,rgba(124,98,68,.12) 0%,transparent 60%),
             radial-gradient(ellipse at 80% 20%,rgba(94,74,49,.08) 0%,transparent 50%)}
.auth-card{background:rgba(255,255,255,0.45);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border:1px solid rgba(255,255,255,0.6);border-radius:22px;padding:36px;width:100%;max-width:420px;
  box-shadow:0 4px 24px rgba(0,0,0,0.1),0 0 0 1px rgba(255,255,255,0.3) inset}
.auth-inp{width:100%;padding:13px 16px;background:rgba(28,31,33,0.07);border:1px solid rgba(28,31,33,0.15);
  border-radius:11px;color:#1c1f21;font-size:14px;outline:none;font-family:'Outfit',sans-serif;transition:all .2s}
.auth-inp:focus{border-color:rgba(124,98,68,.6);background:rgba(255,255,255,.5);box-shadow:0 0 0 3px rgba(124,98,68,.1)}
.auth-inp::placeholder{color:rgba(28,31,33,.38)}
.auth-btn{width:100%;padding:13px;background:linear-gradient(135deg,#7c6244,#5e4a31);border:none;
  border-radius:11px;color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:'Outfit',sans-serif;
  transition:all .2s;letter-spacing:0.01em}
.auth-btn:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(124,98,68,.4)}
.auth-inp-wrap{position:relative;margin-bottom:14px}
.auth-inp-wrap label{display:block;font-size:11.5px;color:rgba(28,31,33,.55);margin-bottom:6px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em}
.auth-inp-wrap .eye-btn{position:absolute;right:13px;top:38px;background:none;border:none;cursor:pointer;font-size:16px;color:rgba(28,31,33,.35);padding:0}
.auth-strength{height:3px;border-radius:2px;margin-top:5px;transition:all .3s}
.google-btn{width:100%;padding:11px 16px;background:#fff;border:1.5px solid rgba(28,31,33,.15);border-radius:10px;
  display:flex;align-items:center;justify-content:center;gap:10px;font-size:13px;font-weight:600;
  color:#1c1f21;cursor:pointer;font-family:'Outfit',sans-serif;transition:all .18s;
  box-shadow:0 1px 3px rgba(0,0,0,.08)}
.google-btn:hover{background:#f8f6f0;border-color:rgba(124,98,68,.35);box-shadow:0 3px 10px rgba(0,0,0,.12);transform:translateY(-1px)}
.google-btn:active{transform:translateY(0)}
.users-list{max-height:200px;overflow-y:auto;margin-bottom:14px}
.user-chip{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:11px;
  cursor:pointer;border:1px solid rgba(28,31,33,.1);background:rgba(255,255,255,.35);margin-bottom:7px;transition:all .18s}
.user-chip:hover{background:rgba(124,98,68,.1);border-color:rgba(124,98,68,.5)}
.user-avatar-sm{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#7c6244,#5e4a31);
  display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;color:#fff;flex-shrink:0}
.ticker-bar{overflow:hidden;white-space:nowrap;padding:8px 0;border-top:1px solid rgba(28,31,33,.1);margin-top:16px}
.ticker-inner{display:inline-block;animation:ticker 30s linear infinite}
@keyframes ticker{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}

/* POS ROW */
.pos-grid{display:grid;grid-template-columns:1.8fr .6fr .8fr .9fr .9fr 1fr 1fr .8fr;align-items:center;padding:10px 16px;border-bottom:1px solid var(--border);font-size:12px;transition:background .12s}
.pos-grid:hover{background:rgba(124,98,68,.04)}
.ord-grid{display:grid;grid-template-columns:1.5fr .6fr .6fr .8fr .8fr .9fr .8fr .9fr .7fr;align-items:center;padding:10px 16px;border-bottom:1px solid var(--border);font-size:11px;transition:background .12s}
.ord-grid:hover{background:rgba(124,98,68,.04)}
.gtt-grid{display:grid;grid-template-columns:1.4fr .6fr .7fr .8fr .9fr .9fr 1fr .9fr;align-items:center;padding:10px 16px;border-bottom:1px solid var(--border);font-size:11px;transition:background .12s}
.gtt-grid:hover{background:rgba(124,98,68,.04)}

/* Real price status indicator */
.price-fresh{color:var(--up);font-size:9px;font-weight:700;letter-spacing:0.04em}
.price-stale{color:#c07020;font-size:9px;font-weight:500}

/* Analytics grid */
.analytics-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px}
.stat-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}

/* News */
.news-item{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:flex-start;transition:background .12s}
.tf-btn{padding:3px 9px;border-radius:5px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:10px;font-weight:600;cursor:pointer;transition:all .15s;font-family:'Outfit',sans-serif;letter-spacing:0.02em}
.tf-btn:hover{background:var(--card);color:var(--text)}
.tf-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.earn-row{display:grid;grid-template-columns:90px 1fr 100px 80px;padding:10px 16px;border-bottom:1px solid var(--border);align-items:center;transition:background .12s}
.earn-row:hover{background:rgba(124,98,68,.04)}
.earn-today{background:rgba(124,98,68,.07);border-left:3px solid var(--accent)}
.earn-badge{padding:2px 7px;border-radius:4px;font-size:9px;font-weight:700;letter-spacing:.03em}
.earn-today-badge{background:rgba(124,98,68,.18);color:var(--accent)}
.earn-soon-badge{background:rgba(85,145,179,.12);color:#5591b3}
.earn-past-badge{background:var(--surface);color:var(--faint)}
.news-source{display:inline-block;padding:1px 5px;background:rgba(85,145,179,.1);color:#5591b3;border-radius:3px;font-size:9px;font-weight:600}
.price-flash-up{animation:flashUp .4s ease}
.price-flash-dn{animation:flashDn .4s ease}
@keyframes flashUp{0%{background:rgba(45,106,79,.35)}100%{background:transparent}}
@keyframes flashDn{0%{background:rgba(192,57,43,.3)}100%{background:transparent}}
.news-item:hover{background:rgba(124,98,68,.04)}

/* Canvas chart in analytics */
canvas.ana-chart{width:100%!important;height:160px!important}

/* Refresh loader */
.spin{display:inline-block;animation:spin .8s linear infinite;font-size:11px}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

/* Price flash animation */
@keyframes flashUp{0%{background:rgba(26,96,64,.25)}100%{background:transparent}}
@keyframes flashDown{0%{background:rgba(184,48,37,.22)}100%{background:transparent}}
.flash-up{animation:flashUp .6s ease-out}
.flash-down{animation:flashDown .6s ease-out}

input[type=number]::-webkit-inner-spin-button{opacity:1}

/* Improved empty states */
.empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
.empty-state .empty-icon{font-size:40px;margin-bottom:12px;opacity:.7}
.empty-state p{font-size:14px;font-weight:500;margin-bottom:6px}
.empty-state small{font-size:12px;color:var(--faint)}
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen" class="auth-wrap">
  <div style="width:100%;max-width:440px">
    <div style="text-align:center;margin-bottom:28px">
      <div style="display:inline-flex;align-items:center;gap:10px;margin-bottom:8px">
        <div class="logo-icon" style="width:38px;height:38px;border-radius:12px;font-size:18px">üìà</div>
        <span class="sg" style="color:#1c1f21;font-size:28px;font-weight:800;letter-spacing:-0.05em">TradeSim Pro</span>
      </div>
      <p style="color:rgba(0,0,0,.5);font-size:13px;font-weight:500;letter-spacing:0.02em">NSE Real-Price Paper Trading Platform</p>
    </div>

    <!-- FIREBASE STATUS BANNER -->
    <div id="fb-banner" style="display:none;margin-bottom:12px;padding:10px 14px;border-radius:10px;font-size:12px;text-align:center"></div>

    <!-- ACCOUNT PICKER -->
    <div id="account-picker" style="display:none">
      <div class="auth-card">
        <h3 style="font-family:'Space Grotesk',sans-serif;font-weight:700;font-size:17px;color:#2e3132;margin-bottom:4px">üëã Welcome Back!</h3>
        <p style="font-size:12px;color:rgba(46,49,50,.5);margin-bottom:18px">Select your account to continue</p>
        <div class="users-list" id="users-list"></div>
        <div style="text-align:center;margin-top:8px">
          <button onclick="showAuthForm('signup')" style="background:none;border:none;color:var(--accent);font-size:13px;cursor:pointer;font-family:'Outfit',sans-serif;text-decoration:underline">+ Create new account</button>
        </div>
        <!-- Email/Password direct login -->
        <div style="display:flex;align-items:center;gap:10px;margin:14px 0 10px">
          <div style="flex:1;height:1px;background:rgba(28,31,33,.12)"></div>
          <span style="font-size:11px;color:rgba(28,31,33,.38);font-weight:500">ya email se login karein</span>
          <div style="flex:1;height:1px;background:rgba(28,31,33,.12)"></div>
        </div>
        <button onclick="showAuthForm('email-login')" style="width:100%;padding:11px;background:rgba(124,98,68,.08);border:1px solid rgba(124,98,68,.25);border-radius:10px;color:#7c6244;font-size:13px;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;margin-bottom:10px">
          üìß Email & Password se Login
        </button>
        <!-- Google Login divider -->
        <div style="display:flex;align-items:center;gap:10px;margin:4px 0 10px">
          <div style="flex:1;height:1px;background:rgba(28,31,33,.12)"></div>
          <span style="font-size:11px;color:rgba(28,31,33,.38);font-weight:500">ya</span>
          <div style="flex:1;height:1px;background:rgba(28,31,33,.12)"></div>
        </div>
        <button onclick="doGoogleLogin()" id="google-btn-picker" class="google-btn">
          <svg width="16" height="16" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.08 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-3.58-13.46-8.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
          Google se Login karein
        </button>
      </div>
    </div>

    <!-- EMAIL + PASSWORD DIRECT LOGIN FORM -->
    <div id="email-login-form" style="display:none">
      <div class="auth-card">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px">
          <button onclick="backToPicker()" style="background:rgba(46,49,50,.08);border:none;cursor:pointer;border-radius:8px;padding:6px 11px;font-size:15px">‚Üê</button>
          <div>
            <h3 style="font-family:'Space Grotesk',sans-serif;font-weight:700;font-size:17px;color:#2e3132">üîê Login</h3>
            <p style="font-size:11px;color:rgba(46,49,50,.5)">Email aur password se login karein</p>
          </div>
        </div>
        <div class="auth-inp-wrap">
          <label>Email Address</label>
          <input class="auth-inp" type="email" id="el-email" placeholder="aapka@email.com"/>
        </div>
        <div class="auth-inp-wrap">
          <label>Password</label>
          <input class="auth-inp" type="password" id="el-pass" placeholder="Apna password likhein" onkeydown="if(event.key==='Enter')doEmailLogin()"/>
          <button class="eye-btn" onclick="togglePass('el-pass',this)" type="button">üëÅ</button>
        </div>
        <p id="el-err" style="color:#e74c3c;font-size:12px;margin-bottom:12px;display:none"></p>
        <button class="auth-btn" id="el-login-btn" onclick="doEmailLogin()">üîê Login</button>
        <div style="text-align:center;margin-top:12px">
          <button onclick="showForgotPassword()" style="background:none;border:none;color:rgba(124,98,68,.8);font-size:12px;cursor:pointer;font-family:'Outfit',sans-serif;text-decoration:underline">üîë Password bhool gaye?</button>
        </div>
        <!-- Google divider -->
        <div style="display:flex;align-items:center;gap:10px;margin:14px 0 10px">
          <div style="flex:1;height:1px;background:rgba(28,31,33,.12)"></div>
          <span style="font-size:11px;color:rgba(28,31,33,.38);font-weight:500">ya</span>
          <div style="flex:1;height:1px;background:rgba(28,31,33,.12)"></div>
        </div>
        <button onclick="doGoogleLogin()" class="google-btn">
          <svg width="16" height="16" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.08 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-3.58-13.46-8.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
          Google se Login karein
        </button>
      </div>
    </div>

    <!-- LOGIN FORM -->
    <div id="login-form" style="display:none">
      <div class="auth-card">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px">
          <button onclick="backToPicker()" style="background:rgba(46,49,50,.08);border:none;cursor:pointer;border-radius:8px;padding:6px 11px;font-size:15px">‚Üê</button>
          <div>
            <h3 style="font-family:'Space Grotesk',sans-serif;font-weight:700;font-size:17px;color:#2e3132">Login</h3>
            <p style="font-size:11px;color:rgba(46,49,50,.5)">Enter your password to continue</p>
          </div>
        </div>
        <div id="login-user-info" style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(124,98,68,.08);border-radius:11px;border:1px solid rgba(124,98,68,.2);margin-bottom:16px">
          <div id="login-avatar" class="user-avatar-sm"></div>
          <div>
            <div id="login-name" style="font-weight:600;font-size:13px;color:#2e3132"></div>
            <div id="login-email-show" style="font-size:11px;color:rgba(46,49,50,.5)"></div>
          </div>
        </div>
        <div class="auth-inp-wrap">
          <label>Password</label>
          <input class="auth-inp" type="password" id="login-pass" placeholder="Enter your password" onkeydown="if(event.key==='Enter')doLogin()"/>
          <button class="eye-btn" onclick="togglePass('login-pass',this)" type="button">üëÅ</button>
        </div>
        <p id="login-err" style="color:#e74c3c;font-size:12px;margin-bottom:12px;display:none"></p>
        <button class="auth-btn" id="login-btn" onclick="doLogin()">üîê Login to Account</button>
        <div style="text-align:center;margin-top:12px">
          <button onclick="showForgotPassword()" style="background:none;border:none;color:rgba(124,98,68,.8);font-size:12px;cursor:pointer;font-family:'Outfit',sans-serif;text-decoration:underline">üîë Password bhool gaye?</button>
        </div>
        <!-- Google divider -->
        <div style="display:flex;align-items:center;gap:10px;margin:14px 0 10px">
          <div style="flex:1;height:1px;background:rgba(28,31,33,.12)"></div>
          <span style="font-size:11px;color:rgba(28,31,33,.38);font-weight:500">ya</span>
          <div style="flex:1;height:1px;background:rgba(28,31,33,.12)"></div>
        </div>
        <button onclick="doGoogleLogin()" id="google-btn-login" class="google-btn">
          <svg width="16" height="16" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.08 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-3.58-13.46-8.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
          Google se Login karein
        </button>
      </div>
    </div>

    <!-- FORGOT PASSWORD FORM -->
    <div id="forgot-form" style="display:none">
      <div class="auth-card">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px">
          <button onclick="showAuthForm('login')" style="background:rgba(46,49,50,.08);border:none;cursor:pointer;border-radius:8px;padding:6px 11px;font-size:15px">‚Üê</button>
          <div>
            <h3 style="font-family:'Space Grotesk',sans-serif;font-weight:700;font-size:17px;color:#2e3132">Password Reset</h3>
            <p style="font-size:11px;color:rgba(46,49,50,.5)">Email pe reset link bhejenge</p>
          </div>
        </div>
        <div id="forgot-success" style="display:none;background:rgba(45,106,79,.1);border:1px solid rgba(45,106,79,.3);border-radius:10px;padding:12px 14px;margin-bottom:14px;text-align:center">
          <div style="font-size:22px;margin-bottom:4px">üì¨</div>
          <div style="font-size:13px;font-weight:600;color:#2d6a4f">Reset link bhej diya gaya!</div>
          <div id="forgot-success-email" style="font-size:11px;color:rgba(45,106,79,.7);margin-top:3px"></div>
        </div>
        <div id="forgot-fields">
          <div class="auth-inp-wrap">
            <label>Registered Email Address</label>
            <input class="auth-inp" id="forgot-email" placeholder="aapka@email.com" onkeydown="if(event.key==='Enter')doForgotPassword()"/>
          </div>
          <p id="forgot-err" style="color:#e74c3c;font-size:12px;margin-bottom:12px;display:none"></p>
          <button class="auth-btn" id="forgot-btn" onclick="doForgotPassword()">üìß Reset Link Bhejein</button>
        </div>
        <div style="text-align:center;margin-top:12px">
          <button onclick="showAuthForm('login')" style="background:none;border:none;color:rgba(124,98,68,.8);font-size:12px;cursor:pointer;font-family:'Outfit',sans-serif">Login par wapas jaayein</button>
        </div>
      </div>
    </div>

    <!-- SIGNUP FORM -->
    <div id="signup-form" style="display:none">
      <div class="auth-card">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px">
          <button onclick="backToPicker()" style="background:rgba(46,49,50,.08);border:none;cursor:pointer;border-radius:8px;padding:6px 11px;font-size:15px">‚Üê</button>
          <div>
            <h3 style="font-family:'Space Grotesk',sans-serif;font-weight:700;font-size:17px;color:#2e3132">Create Account</h3>
            <p style="font-size:11px;color:rgba(46,49,50,.5)">Start with ‚Çπ10,00,000 virtual capital</p>
          </div>
        </div>
        <div class="auth-inp-wrap">
          <label>Full Name</label>
          <input class="auth-inp" id="su-name" placeholder="Your full name"/>
        </div>
        <div class="auth-inp-wrap">
          <label>Email Address</label>
          <input class="auth-inp" id="su-email" placeholder="you@example.com"/>
        </div>
        <div class="auth-inp-wrap">
          <label>Password</label>
          <input class="auth-inp" type="password" id="su-pass" placeholder="Min 6 characters" oninput="checkPassStrength(this.value)"/>
          <button class="eye-btn" onclick="togglePass('su-pass',this)" type="button">üëÅ</button>
          <div class="auth-strength" id="pass-strength-su" style="background:#e0e0e0;width:0%"></div>
        </div>
        <div class="auth-inp-wrap">
          <label>Confirm Password</label>
          <input class="auth-inp" type="password" id="su-pass2" placeholder="Re-enter password" onkeydown="if(event.key==='Enter')doSignup()"/>
          <button class="eye-btn" onclick="togglePass('su-pass2',this)" type="button">üëÅ</button>
        </div>
        <p id="signup-err" style="color:#e74c3c;font-size:12px;margin-bottom:12px;display:none"></p>
        <button class="auth-btn" id="create-acc-btn" onclick="doSignup()">üöÄ Create Account &amp; Start Trading</button>
        <!-- Google divider -->
        <div style="display:flex;align-items:center;gap:10px;margin:14px 0 10px">
          <div style="flex:1;height:1px;background:rgba(28,31,33,.12)"></div>
          <span style="font-size:11px;color:rgba(28,31,33,.38);font-weight:500">ya</span>
          <div style="flex:1;height:1px;background:rgba(28,31,33,.12)"></div>
        </div>
        <button onclick="doGoogleLogin()" class="google-btn">
          <svg width="16" height="16" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.08 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-3.58-13.46-8.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
          Google se Sign up karein
        </button>
      </div>
    </div>

    <!-- FIRST TIME FORM -->
    <div id="first-time-form" style="display:block">
      <div class="auth-card">
        <div style="text-align:center;margin-bottom:22px">
          <div style="font-size:38px;margin-bottom:8px">üéâ</div>
          <h3 style="font-family:'Space Grotesk',sans-serif;font-weight:700;font-size:18px;color:#2e3132;margin-bottom:4px">Welcome to TradeSim Pro</h3>
          <p style="font-size:12px;color:rgba(46,49,50,.55)">Create your first account to start virtual trading</p>
        </div>
        <div class="auth-inp-wrap">
          <label>Full Name</label>
          <input class="auth-inp" id="ft-name" placeholder="Your full name"/>
        </div>
        <div class="auth-inp-wrap">
          <label>Email Address</label>
          <input class="auth-inp" id="ft-email" placeholder="you@example.com"/>
        </div>
        <div class="auth-inp-wrap">
          <label>Password</label>
          <input class="auth-inp" type="password" id="ft-pass" placeholder="Min 6 characters" oninput="checkPassStrength(this.value,'ft')"/>
          <button class="eye-btn" onclick="togglePass('ft-pass',this)" type="button">üëÅ</button>
          <div class="auth-strength" id="pass-strength-ft" style="background:#e0e0e0;width:0%"></div>
        </div>
        <div class="auth-inp-wrap">
          <label>Confirm Password</label>
          <input class="auth-inp" type="password" id="ft-pass2" placeholder="Re-enter password" onkeydown="if(event.key==='Enter')doFirstSignup()"/>
          <button class="eye-btn" onclick="togglePass('ft-pass2',this)" type="button">üëÅ</button>
        </div>
        <p id="ft-err" style="color:#e74c3c;font-size:12px;margin-bottom:12px;display:none"></p>
        <button class="auth-btn" id="first-acc-btn" onclick="doFirstSignup()">üöÄ Create Account &amp; Start Trading</button>
        <div style="text-align:center;margin-top:10px">
          <button onclick="showAuthForm('email-login')" style="background:none;border:none;color:rgba(124,98,68,.8);font-size:12px;cursor:pointer;font-family:'Outfit',sans-serif;text-decoration:underline">Pehle se account hai? Login karein</button>
        </div>
        <!-- Google divider -->
        <div style="display:flex;align-items:center;gap:10px;margin:14px 0 10px">
          <div style="flex:1;height:1px;background:rgba(28,31,33,.12)"></div>
          <span style="font-size:11px;color:rgba(28,31,33,.38);font-weight:500">ya</span>
          <div style="flex:1;height:1px;background:rgba(28,31,33,.12)"></div>
        </div>
        <button onclick="doGoogleLogin()" class="google-btn">
          <svg width="16" height="16" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.08 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-3.58-13.46-8.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
          Google se Sign up karein
        </button>
      </div>
    </div>

    <div class="ticker-bar" style="margin-top:16px">
      <div class="ticker-inner" id="auth-ticker" style="font-size:11px;color:#555"></div>
    </div>
    <p style="color:rgba(0,0,0,.3);font-size:11px;text-align:center;margin-top:12px">Virtual trading only ‚Ä¢ No real money involved</p>
  </div>
</div>

<!-- PROFILE MODAL -->
<div class="overlay" id="profile-overlay" style="display:none" onclick="if(event.target===this)closeProfile()">
  <div class="modal" style="max-width:380px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h3 class="sg" style="font-weight:700;font-size:17px">My Account</h3>
      <button onclick="closeProfile()" style="background:transparent;border:none;color:var(--muted);font-size:20px;cursor:pointer">‚úï</button>
    </div>
    <div style="text-align:center;margin-bottom:20px">
      <div id="profile-avatar" style="width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#7c6244,#5e4a31);display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:700;color:#fff;margin:0 auto 10px"></div>
      <div id="profile-name" class="sg" style="font-weight:700;font-size:17px"></div>
      <div id="profile-email" style="font-size:12px;color:var(--muted);margin-top:2px"></div>
      <div id="profile-joined" style="font-size:11px;color:var(--faint);margin-top:4px"></div>
    </div>
    <div style="background:var(--surface);border-radius:12px;padding:14px;margin-bottom:16px" id="profile-stats"></div>
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <button onclick="openBalModal();closeProfile()" class="btn-neutral" style="flex:1;padding:10px">‚öô Update Balance</button>
      <button onclick="resetAllData()" style="flex:1;padding:10px;background:rgba(231,76,60,.1);border:1px solid rgba(231,76,60,.3);border-radius:8px;color:#e74c3c;font-family:'Outfit',sans-serif;font-size:12px;cursor:pointer;font-weight:600">üóë Reset Data</button>
    </div>
    <button onclick="doLogout()" style="width:100%;padding:11px;background:linear-gradient(135deg,#e74c3c,#c0392b);border:none;border-radius:10px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:'Outfit',sans-serif">üö™ Logout</button>
  </div>
</div>

<!-- MAIN APP (hidden until login) -->
<div id="app" style="display:none">

  <!-- Live price status banner (hidden by default) -->
  <div id="cors-banner" style="display:none"></div>

  <!-- NOTIFICATION -->
  <div id="notif" class="notif" style="display:none"></div>

  <!-- NAV -->
  <nav>
    <div style="display:flex;align-items:center;gap:20px">
      <div class="logo">
        <div class="logo-icon">üìà</div>
        <span class="logo-text">TradeSim Pro</span>
      </div>
      <div class="nav-tabs">
        <button class="nav-btn active" onclick="switchTab('market',this)">üìä Market</button>
        <button class="nav-btn" onclick="switchTab('positions',this)">üìÇ Positions <span id="nav-pos-cnt">(0)</span></button>
        <button class="nav-btn" onclick="switchTab('orders',this)">üìã Orders <span id="nav-ord-cnt">(0)</span></button>
        <button class="nav-btn" onclick="switchTab('gtt',this)">üéØ GTT <span id="nav-gtt-cnt">(0)</span></button>
        <button class="nav-btn" onclick="switchTab('analytics',this)">üìà Analytics</button>
        <button class="nav-btn" onclick="switchTab('news',this)">üì∞ News</button>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <div id="mkt-status" class="mkt-badge" style="border:1px solid rgba(0,0,0,.08)">
        <div class="mkt-dot" id="mkt-dot"></div>
        <span id="mkt-text"></span>
      </div>
      <!-- Real price fetch status -->
      <div id="price-status" style="font-size:10px;color:var(--faint)">‚ö° AngelOne se live prices...</div>
      <div id="results-today-badge" style="display:none;font-size:10px;font-weight:700;color:var(--down);background:rgba(184,48,37,.1);padding:3px 10px;border-radius:20px;cursor:pointer;align-items:center;gap:4px" onclick="switchTab('news',document.querySelector('.nav-btn[onclick*=\\'news\\']'));setTimeout(()=>switchNewsTab('earnings'),50)">üìÖ <span id="results-today-count">0</span> Results Today ‚Üí</div>
      <button onclick="fetchAllPrices()" 
        class="btn-neutral" style="font-size:10px;padding:4px 9px;border-radius:6px" title="Refresh prices">
        ‚ü≥ Refresh
      </button>
      <div style="width:1px;height:24px;background:var(--border)"></div>
      <div style="text-align:right">
        <div style="font-size:9px;color:var(--faint);font-weight:600;text-transform:uppercase;letter-spacing:0.05em">Available</div>
        <div class="mono" id="nav-balance" style="font-weight:700;font-size:13px"></div>
      </div>
      <button class="btn-neutral" onclick="openBalModal()" style="font-size:11px;padding:5px 10px">‚öô Balance</button>
      <span style="font-size:12px;opacity:.7">‚òÄÔ∏è</span>
      <label class="toggle-sw">
        <input type="checkbox" id="dark-toggle" onchange="toggleDark(this)"/>
        <span class="tog-slider"></span>
      </label>
      <span style="font-size:12px;opacity:.7">üåô</span>
      <div id="user-avatar" style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#7c6244,#2d6a9f);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:#fff;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.2)" onclick="openProfile()" title="My Account"></div>
    </div>
  </nav>

  <!-- SUMMARY BAR -->
  <div class="summary-bar">
    <div class="stat-item" onclick="openNetworthModal()" style="cursor:pointer">
      <div class="stat-label">Net Worth ‚úè</div>
      <div class="stat-val mono" id="s-networth">‚Äî</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Available</div>
      <div class="stat-val mono" id="s-balance">‚Äî</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Portfolio Value</div>
      <div class="stat-val mono" id="s-portval" style="color:#4d9eff">‚Äî</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Total P&L</div>
      <div class="stat-val mono" id="s-pnl">‚Äî</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Open Positions</div>
      <div class="stat-val mono" id="s-positions">0</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Active GTT</div>
      <div class="stat-val mono" id="s-gtt" style="color:#5591b3">0</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Prices Updated</div>
      <div class="stat-val mono" id="s-updated" style="font-size:11px;color:var(--faint)">‚Äî</div>
    </div>
  </div>

  <!-- APP BODY: Main + Sidebar -->
  <div class="app-body">

    <!-- MAIN CONTENT -->
    <div class="main-area">

      <!-- MARKET TAB -->
      <div id="tab-market">
        <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center">
          <input class="inp" style="width:240px;padding:8px 13px" placeholder="üîç Search stocks..." id="mkt-search" oninput="renderMarket()"/>
          <div style="display:flex;gap:5px;overflow-x:auto;flex:1" id="sector-filter"></div>
          <div style="font-size:10px;color:var(--faint);white-space:nowrap;padding:0 4px">Keys 1‚Äì6 to switch tabs ‚Ä¢ Esc to close modals</div>
        </div>
        <div class="tbl-wrap">
          <div class="tbl-head" style="grid-template-columns:2fr 1.3fr 1fr .9fr .9fr .5fr .9fr">
            <span>Stock</span><span>LTP (Real)</span><span>Change</span><span>High</span><span>Low</span><span>WL</span><span>Action</span>
          </div>
          <div class="tbl-body" id="market-table" style="max-height:calc(100vh - 280px);overflow-y:auto"></div>
          <div style="padding:7px 14px;border-top:1px solid var(--border);font-size:10px;color:var(--faint);display:flex;justify-content:space-between">
            <span id="mkt-count"></span>
            <span id="mkt-refresh-info"></span>
          </div>
        </div>
      </div>

      <!-- POSITIONS TAB -->
      <div id="tab-positions" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h2 class="sg" style="font-size:16px;font-weight:600">Open Positions</h2>
          <span id="pos-total-pnl" class="mono" style="font-weight:700;font-size:14px"></span>
        </div>
        <div class="tbl-wrap">
          <div class="pos-grid tbl-head">
            <span>Stock</span><span>Type</span><span>Qty</span><span>Avg Price</span><span>LTP</span><span>Invested</span><span>P&L</span><span>Action</span>
          </div>
          <div id="positions-table" style="max-height:calc(100vh - 260px);overflow-y:auto"></div>
        </div>
      </div>

      <!-- ORDERS TAB -->
      <div id="tab-orders" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h2 class="sg" style="font-size:16px;font-weight:600">Trade History</h2>
          <div style="display:flex;gap:16px" id="orders-summary"></div>
        </div>
        <div class="tbl-wrap">
          <div class="ord-grid tbl-head">
            <span>Stock</span><span>Type</span><span>Seg</span><span>Qty</span><span>Price</span><span>Value</span><span>Charges</span><span>P&L</span><span>Time</span>
          </div>
          <div id="orders-table" style="max-height:calc(100vh - 260px);overflow-y:auto"></div>
        </div>
      </div>

      <!-- GTT TAB -->
      <div id="tab-gtt" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div>
            <h2 class="sg" style="font-size:16px;font-weight:600">üéØ GTT Orders</h2>
            <p style="font-size:11px;color:var(--muted);margin-top:2px">Auto-triggers on SL / Target / Trailing SL</p>
          </div>
          <button class="btn-gtt" style="padding:7px 14px;font-size:12px" onclick="switchTab('market',document.querySelector('.nav-btn'))">+ New GTT</button>
        </div>
        <div class="tbl-wrap">
          <div class="gtt-grid tbl-head">
            <span>Stock</span><span>Type</span><span>Qty</span><span>Entry</span><span>Stop Loss</span><span>Target</span><span>Trailing</span><span>Status</span>
          </div>
          <div id="gtt-table" style="max-height:calc(100vh - 260px);overflow-y:auto"></div>
        </div>
      </div>

      <!-- ANALYTICS TAB -->
      <div id="tab-analytics" style="display:none">
        <h2 class="sg" style="font-size:16px;font-weight:600;margin-bottom:14px">üìà Analytics</h2>
        <div class="analytics-grid">
          <div class="card">
            <h3 class="sg" style="font-size:13px;font-weight:600;margin-bottom:14px">Portfolio by Sector</h3>
            <div id="sector-chart-wrap" style="position:relative;height:180px;display:flex;align-items:center;justify-content:center">
              <canvas id="sector-chart"></canvas>
              <p id="sector-empty" style="color:var(--muted);font-size:13px">No positions yet</p>
            </div>
            <div id="sector-legend" style="margin-top:12px"></div>
          </div>
          <div class="card">
            <h3 class="sg" style="font-size:13px;font-weight:600;margin-bottom:14px">Cumulative P&L</h3>
            <div style="height:180px">
              <canvas id="pnl-chart" class="ana-chart"></canvas>
            </div>
            <p id="pnl-empty" style="color:var(--muted);font-size:12px;text-align:center;margin-top:8px;display:none">Close positions to see P&L chart</p>
          </div>
        </div>
        <div class="stat-cards" id="stats-cards"></div>
      </div>

      <!-- NEWS + EARNINGS TAB -->
      <div id="tab-news" style="display:none">
        <!-- Sub-tabs -->
        <div style="display:flex;gap:6px;margin-bottom:14px;background:var(--surface);border-radius:10px;padding:3px;width:fit-content">
          <button class="tag-btn active" id="sub-news-btn" onclick="switchNewsTab('news')">üì∞ Market News</button>
          <button class="tag-btn" id="sub-earn-btn" onclick="switchNewsTab('earnings')">üìÖ Earnings Calendar</button>
        </div>

        <!-- News Feed -->
        <div id="news-panel">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px">
            <div style="display:flex;gap:4px;flex-wrap:wrap">
              <button class="tag-btn active" id="nsrc-all" onclick="filterNews('all')">All Sources</button>
              <button class="tag-btn" id="nsrc-et" onclick="filterNews('et')">üì∞ ET / BS</button>
              <button class="tag-btn" id="nsrc-google" onclick="filterNews('google')">üíπ MoneyControl</button>
              <button class="tag-btn" id="nsrc-nse" onclick="filterNews('nse')">üèõ NSE</button>
              <button class="tag-btn" id="nsrc-sim" onclick="filterNews('sim')">ü§ñ Simulated</button>
            </div>
            <div style="display:flex;align-items:center;gap:6px">
              <span style="font-size:11px;color:var(--muted)" id="news-count"></span>
              <button onclick="fetchRealNews()" class="btn-neutral" style="font-size:10px;padding:4px 10px;border-radius:6px">üîÑ Refresh</button>
            </div>
          </div>
          <div class="tbl-wrap" style="max-height:calc(100vh - 280px);overflow-y:auto" id="news-feed"></div>
        </div>

        <!-- Earnings Calendar -->
        <div id="earnings-panel" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <span style="font-size:12px;color:var(--muted)">NSE companies ke quarterly results schedule</span>
            <button onclick="fetchEarningsCalendar()" class="btn-neutral" style="font-size:10px;padding:4px 10px;border-radius:6px">üîÑ Refresh</button>
          </div>
          <div id="earnings-feed" class="tbl-wrap" style="max-height:calc(100vh - 260px);overflow-y:auto">
            <div style="padding:40px;text-align:center;color:var(--muted)">
              <div style="font-size:28px;margin-bottom:8px">üìÖ</div>
              <div style="font-size:13px;font-weight:600">Loading earnings calendar...</div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /main-area -->

    <!-- WATCHLIST SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-head">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <span class="sg" style="font-weight:700;font-size:12px">‚≠ê Watchlist <span id="wl-count" style="color:var(--faint);font-weight:400"></span></span>
          <button class="btn-neutral" onclick="switchTab('market',document.querySelector('.nav-btn'))" style="font-size:10px;padding:3px 8px;border-radius:5px">+ Add</button>
        </div>
        <input class="sidebar-search" placeholder="üîç Search..." id="wl-search" oninput="renderWatchlist()"/>
      </div>
      <div class="sidebar-body" id="sidebar-wl"></div>
      <div class="sidebar-foot" id="sidebar-foot"></div>
    </div>

  </div><!-- /app-body -->

</div><!-- /app -->

<!-- ORDER MODAL -->
<div class="overlay" id="order-overlay" style="display:none" onclick="if(event.target===this)closeOrderModal()">
  <div class="modal" style="max-width:960px;width:98vw;padding:0;overflow:hidden">
    <!-- Header -->
    <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--border)">
      <div style="display:flex;align-items:center;gap:12px">
        <div>
          <h3 class="sg" style="font-size:18px;font-weight:700" id="om-symbol"></h3>
          <p style="color:var(--muted);font-size:12px;margin-top:1px" id="om-name"></p>
        </div>
        <div id="om-price-live" style="font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:700;background:var(--surface);padding:4px 10px;border-radius:8px"></div>
      </div>
      <button onclick="closeOrderModal()" style="background:transparent;border:none;color:var(--muted);font-size:22px;cursor:pointer">‚úï</button>
    </div>
    <!-- 2 Column Layout -->
    <div style="display:flex;height:520px">
      <!-- LEFT ‚Äî TradingView Chart -->
      <div style="flex:1;min-width:0;border-right:1px solid var(--border)">
        <div id="tv-chart-container" style="height:100%;width:100%">
          <div id="tradingview-widget-container" style="height:100%;width:100%"></div>
        </div>
      </div>
      <!-- RIGHT ‚Äî Order Form -->
      <div style="width:300px;flex-shrink:0;overflow-y:auto;padding:16px">
        <!-- Trade type tabs -->
        <div style="display:flex;gap:6px;margin-bottom:14px;background:var(--inp);border-radius:10px;padding:4px">
          <button class="tab-pill active" id="tt-equity" onclick="setTradeType('equity')">üìä Equity</button>
          <button class="tab-pill" id="tt-futures" onclick="setTradeType('futures')">‚ö° Futures</button>
        </div>
        <!-- BUY/SELL -->
        <div style="display:flex;gap:6px;margin-bottom:14px">
          <button id="ot-buy" onclick="setOrderType('BUY')" style="flex:1;padding:9px;border:none;border-radius:9px;font-weight:700;cursor:pointer;font-family:'Outfit',sans-serif;font-size:13px;background:linear-gradient(135deg,#7c6244,#5e4a31);color:#fff">BUY</button>
          <button id="ot-sell" onclick="setOrderType('SELL')" style="flex:1;padding:9px;border:none;border-radius:9px;font-weight:700;cursor:pointer;font-family:'Outfit',sans-serif;font-size:13px;background:var(--inp);color:var(--muted)">SELL</button>
        </div>
        <!-- Current price -->
        <div class="card" style="padding:11px 14px;margin-bottom:13px;display:flex;justify-content:space-between;align-items:center">
          <span style="color:var(--muted);font-size:12px">Current Price</span>
          <div style="text-align:right">
            <div class="mono" id="om-price" style="font-size:19px;font-weight:700"></div>
            <div id="om-change" style="font-size:11px"></div>
          </div>
        </div>
        <!-- Qty/Lots -->
        <div id="qty-section" style="margin-bottom:13px"></div>
        <!-- Charges -->
        <div class="card" style="padding:12px 14px;margin-bottom:13px">
          <div style="font-size:10px;color:var(--faint);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:7px">Charges Breakdown</div>
          <div id="charges-rows"></div>
          <div style="border-top:1px solid var(--border);margin-top:7px;padding-top:7px;display:flex;justify-content:space-between;font-weight:600;font-size:12px">
            <span>Total <span id="cost-label">Cost</span></span>
            <span class="mono" id="total-cost"></span>
          </div>
        </div>
        <button id="place-btn" onclick="placeOrder()" style="width:100%;padding:12px;border:none;border-radius:11px;font-weight:700;font-size:14px;cursor:pointer;font-family:'Outfit',sans-serif;background:linear-gradient(135deg,#7c6244,#5e4a31);color:#fff">
          ‚ñ≤ Place BUY Order
        </button>
      </div>
    </div>
  </div>
</div>

<!-- GTT MODAL -->
<div class="overlay" id="gtt-overlay" style="display:none" onclick="if(event.target===this)closeGttModal()">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div>
        <h3 class="sg" style="font-size:17px;font-weight:700">üéØ GTT ‚Äî <span id="gm-symbol"></span></h3>
        <p style="font-size:11px;color:var(--muted);margin-top:2px">Good Till Triggered ‚Ä¢ Auto-executes on conditions</p>
      </div>
      <button onclick="closeGttModal()" style="background:transparent;border:none;color:var(--muted);font-size:20px;cursor:pointer">‚úï</button>
    </div>
    <div class="card" style="padding:10px 14px;margin-bottom:14px;display:flex;justify-content:space-between">
      <span style="color:var(--muted);font-size:12px" id="gm-name"></span>
      <div class="mono" style="font-weight:700" id="gm-price"></div>
    </div>
    <!-- BUY/SELL -->
    <div style="display:flex;gap:6px;margin-bottom:14px">
      <button id="gt-buy" onclick="setGttType('BUY')" style="flex:1;padding:8px;border:none;border-radius:9px;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;font-size:12px;background:linear-gradient(135deg,#7c6244,#5e4a31);color:#fff">BUY</button>
      <button id="gt-sell" onclick="setGttType('SELL')" style="flex:1;padding:8px;border:none;border-radius:9px;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;font-size:12px;background:var(--inp);color:var(--muted)">SELL</button>
    </div>
    <div style="margin-bottom:12px">
      <label style="color:var(--muted);font-size:12px;display:block;margin-bottom:5px">Quantity</label>
      <input class="inp" type="number" min="1" id="gm-qty" placeholder="Enter quantity" value="1"/>
    </div>
    <div style="margin-bottom:12px">
      <label style="color:var(--down);font-size:12px;display:block;margin-bottom:5px">üî¥ Stop Loss Price</label>
      <input class="inp" type="number" id="gm-sl" placeholder="e.g. ‚Çπ2700 (leave blank to skip)"/>
      <p style="font-size:10px;color:var(--faint);margin-top:3px" id="gm-sl-hint"></p>
    </div>
    <div style="margin-bottom:12px">
      <label style="color:var(--up);font-size:12px;display:block;margin-bottom:5px">üü¢ Target Price</label>
      <input class="inp" type="number" id="gm-tgt" placeholder="e.g. ‚Çπ3100 (leave blank to skip)"/>
    </div>
    <div class="card" style="padding:12px;margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div style="font-size:12px;font-weight:600">üîÑ Trailing Stop Loss</div>
          <div style="font-size:10px;color:var(--faint)">SL follows price automatically</div>
        </div>
        <label class="toggle-sw">
          <input type="checkbox" id="gm-trail-toggle" onchange="toggleTrail(this)"/>
          <span class="tog-slider"></span>
        </label>
      </div>
      <div id="gm-trail-input" style="display:none">
        <label style="color:#5591b3;font-size:11px;display:block;margin-bottom:5px">Trailing Offset (‚Çπ distance from LTP)</label>
        <input class="inp" type="number" id="gm-trail" placeholder="e.g. 50"/>
      </div>
    </div>
    <button onclick="placeGtt()" style="width:100%;padding:11px;border:none;border-radius:11px;background:linear-gradient(135deg,#5591b3,#4477a0);color:#fff;font-weight:700;font-size:14px;cursor:pointer;font-family:'Outfit',sans-serif">
      üéØ Set GTT Order
    </button>
  </div>
</div>

<!-- BALANCE MODAL -->
<div class="overlay" id="bal-overlay" style="display:none" onclick="if(event.target===this)closeBalModal()">
  <div class="modal" style="max-width:340px">
    <div style="display:flex;justify-content:space-between;margin-bottom:16px">
      <h3 class="sg" style="font-weight:700">Update Balance</h3>
      <button onclick="closeBalModal()" style="background:transparent;border:none;color:var(--muted);font-size:20px;cursor:pointer">‚úï</button>
    </div>
    <div style="margin-bottom:8px;color:var(--muted);font-size:12px">Current: <span class="mono" id="bal-cur" style="font-weight:600;color:var(--accent)"></span></div>
    <input class="inp" type="number" id="bal-input" placeholder="Enter new balance" style="margin-bottom:14px"/>
    <button class="btn-buy" style="width:100%;padding:11px" onclick="updateBalance()">Update Balance</button>
  </div>
</div>

<!-- NETWORTH MODAL -->
<div class="overlay" id="nw-overlay" style="display:none" onclick="if(event.target===this)closeNetworthModal()">
  <div class="modal" style="max-width:340px">
    <div style="display:flex;justify-content:space-between;margin-bottom:16px">
      <h3 class="sg" style="font-weight:700">Set Net Worth</h3>
      <button onclick="closeNetworthModal()" style="background:transparent;border:none;color:var(--muted);font-size:20px;cursor:pointer">‚úï</button>
    </div>
    <div style="margin-bottom:6px;color:var(--muted);font-size:12px">Current: <span class="mono" id="nw-cur" style="font-weight:600"></span></div>
    <p style="font-size:11px;color:var(--faint);margin-bottom:12px">Sets available balance (portfolio value excluded)</p>
    <input class="inp" type="number" id="nw-input" placeholder="Enter desired net worth" style="margin-bottom:14px"/>
    <button class="btn-buy" style="width:100%;padding:11px" onclick="updateNetworth()">Update Net Worth</button>
  </div>
</div>

<script>
// ============================================================
// NSE STOCK MASTER DATA
// ============================================================
const NSE_MASTER = [
  // ‚îÄ‚îÄ NIFTY 50 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {symbol:"RELIANCE",yf:"RELIANCE.NS",name:"Reliance Industries",sector:"Energy",lotSize:250},
  {symbol:"TCS",yf:"TCS.NS",name:"Tata Consultancy Services",sector:"IT",lotSize:150},
  {symbol:"HDFCBANK",yf:"HDFCBANK.NS",name:"HDFC Bank",sector:"Banking",lotSize:550},
  {symbol:"BHARTIARTL",yf:"BHARTIARTL.NS",name:"Bharti Airtel",sector:"Telecom",lotSize:475},
  {symbol:"ICICIBANK",yf:"ICICIBANK.NS",name:"ICICI Bank",sector:"Banking",lotSize:700},
  {symbol:"INFOSYS",yf:"INFY.NS",name:"Infosys",sector:"IT",lotSize:400},
  {symbol:"SBIN",yf:"SBIN.NS",name:"State Bank of India",sector:"Banking",lotSize:1500},
  {symbol:"HINDUNILVR",yf:"HINDUNILVR.NS",name:"Hindustan Unilever",sector:"FMCG",lotSize:300},
  {symbol:"BAJFINANCE",yf:"BAJFINANCE.NS",name:"Bajaj Finance",sector:"Finance",lotSize:125},
  {symbol:"ITC",yf:"ITC.NS",name:"ITC Limited",sector:"FMCG",lotSize:1600},
  {symbol:"AXISBANK",yf:"AXISBANK.NS",name:"Axis Bank",sector:"Banking",lotSize:625},
  {symbol:"LT",yf:"LT.NS",name:"Larsen & Toubro",sector:"Infrastructure",lotSize:175},
  {symbol:"WIPRO",yf:"WIPRO.NS",name:"Wipro",sector:"IT",lotSize:1500},
  {symbol:"HCLTECH",yf:"HCLTECH.NS",name:"HCL Technologies",sector:"IT",lotSize:350},
  {symbol:"KOTAKBANK",yf:"KOTAKBANK.NS",name:"Kotak Mahindra Bank",sector:"Banking",lotSize:400},
  {symbol:"MARUTI",yf:"MARUTI.NS",name:"Maruti Suzuki",sector:"Auto",lotSize:100},
  {symbol:"TITAN",yf:"TITAN.NS",name:"Titan Company",sector:"Consumer",lotSize:175},
  {symbol:"SUNPHARMA",yf:"SUNPHARMA.NS",name:"Sun Pharma",sector:"Pharma",lotSize:350},
  {symbol:"ASIANPAINT",yf:"ASIANPAINT.NS",name:"Asian Paints",sector:"Consumer",lotSize:300},
  {symbol:"ULTRACEMCO",yf:"ULTRACEMCO.NS",name:"UltraTech Cement",sector:"Cement",lotSize:100},
  {symbol:"ONGC",yf:"ONGC.NS",name:"Oil & Natural Gas Corp",sector:"Energy",lotSize:3850},
  {symbol:"NTPC",yf:"NTPC.NS",name:"NTPC Limited",sector:"Power",lotSize:2875},
  {symbol:"POWERGRID",yf:"POWERGRID.NS",name:"Power Grid Corp",sector:"Power",lotSize:2875},
  {symbol:"COALINDIA",yf:"COALINDIA.NS",name:"Coal India",sector:"Mining",lotSize:1400},
  {symbol:"HDFCLIFE",yf:"HDFCLIFE.NS",name:"HDFC Life Insurance",sector:"Insurance",lotSize:1100},
  {symbol:"BAJAJFINSV",yf:"BAJAJFINSV.NS",name:"Bajaj Finserv",sector:"Finance",lotSize:500},
  {symbol:"ADANIPORTS",yf:"ADANIPORTS.NS",name:"Adani Ports",sector:"Infrastructure",lotSize:625},
  {symbol:"TECHM",yf:"TECHM.NS",name:"Tech Mahindra",sector:"IT",lotSize:600},
  {symbol:"TATASTEEL",yf:"TATASTEEL.NS",name:"Tata Steel",sector:"Metal",lotSize:5500},
  {symbol:"DRREDDY",yf:"DRREDDY.NS",name:"Dr Reddys Laboratories",sector:"Pharma",lotSize:125},
  {symbol:"CIPLA",yf:"CIPLA.NS",name:"Cipla",sector:"Pharma",lotSize:650},
  {symbol:"EICHERMOT",yf:"EICHERMOT.NS",name:"Eicher Motors",sector:"Auto",lotSize:175},
  {symbol:"HEROMOTOCO",yf:"HEROMOTOCO.NS",name:"Hero MotoCorp",sector:"Auto",lotSize:300},
  {symbol:"SBILIFE",yf:"SBILIFE.NS",name:"SBI Life Insurance",sector:"Insurance",lotSize:750},
  {symbol:"NESTLEIND",yf:"NESTLEIND.NS",name:"Nestle India",sector:"FMCG",lotSize:400},
  {symbol:"BAJAJ-AUTO",yf:"BAJAJ-AUTO.NS",name:"Bajaj Auto",sector:"Auto",lotSize:75},
  {symbol:"M&M",yf:"M%26M.NS",name:"Mahindra & Mahindra",sector:"Auto",lotSize:175},
  {symbol:"APOLLOHOSP",yf:"APOLLOHOSP.NS",name:"Apollo Hospitals",sector:"Healthcare",lotSize:125},
  {symbol:"JSWSTEEL",yf:"JSWSTEEL.NS",name:"JSW Steel",sector:"Metal",lotSize:675},
  {symbol:"HINDALCO",yf:"HINDALCO.NS",name:"Hindalco Industries",sector:"Metal",lotSize:1075},
  {symbol:"GRASIM",yf:"GRASIM.NS",name:"Grasim Industries",sector:"Diversified",lotSize:475},
  {symbol:"INDUSINDBK",yf:"INDUSINDBK.NS",name:"IndusInd Bank",sector:"Banking",lotSize:500},
  {symbol:"TATACONSUM",yf:"TATACONSUM.NS",name:"Tata Consumer Products",sector:"FMCG",lotSize:1100},
  {symbol:"SHRIRAMFIN",yf:"SHRIRAMFIN.NS",name:"Shriram Finance",sector:"Finance",lotSize:600},
  {symbol:"BRITANNIA",yf:"BRITANNIA.NS",name:"Britannia Industries",sector:"FMCG",lotSize:125},
  {symbol:"ADANIENT",yf:"ADANIENT.NS",name:"Adani Enterprises",sector:"Conglomerate",lotSize:250},
  {symbol:"BPCL",yf:"BPCL.NS",name:"Bharat Petroleum Corp",sector:"Energy",lotSize:3250},
  {symbol:"DIVISLAB",yf:"DIVISLAB.NS",name:"Divi's Laboratories",sector:"Pharma",lotSize:150},
  {symbol:"TRENT",yf:"TRENT.NS",name:"Trent Limited",sector:"Retail",lotSize:200},
  // ‚îÄ‚îÄ NIFTY NEXT 50 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {symbol:"LICI",yf:"LICI.NS",name:"Life Insurance Corp of India",sector:"Insurance",lotSize:700},
  {symbol:"ADANIGREEN",yf:"ADANIGREEN.NS",name:"Adani Green Energy",sector:"Power",lotSize:500},
  {symbol:"ADANIPOWER",yf:"ADANIPOWER.NS",name:"Adani Power",sector:"Power",lotSize:2750},
  {symbol:"AMBUJACEM",yf:"AMBUJACEM.NS",name:"Ambuja Cements",sector:"Cement",lotSize:2000},
  {symbol:"NYKAA",yf:"NYKAA.NS",name:"FSN E-Commerce (Nykaa)",sector:"Retail",lotSize:5000},
  {symbol:"VEDL",yf:"VEDL.NS",name:"Vedanta Limited",sector:"Metal",lotSize:2750},
  {symbol:"SIEMENS",yf:"SIEMENS.NS",name:"Siemens India",sector:"Capital Goods",lotSize:250},
  {symbol:"HAVELLS",yf:"HAVELLS.NS",name:"Havells India",sector:"Capital Goods",lotSize:750},
  {symbol:"PIDILITIND",yf:"PIDILITIND.NS",name:"Pidilite Industries",sector:"Chemical",lotSize:375},
  {symbol:"CHOLAFIN",yf:"CHOLAFIN.NS",name:"Cholamandalam Investment",sector:"Finance",lotSize:1000},
  {symbol:"BANKBARODA",yf:"BANKBARODA.NS",name:"Bank of Baroda",sector:"Banking",lotSize:3750},
  {symbol:"DABUR",yf:"DABUR.NS",name:"Dabur India",sector:"FMCG",lotSize:2750},
  {symbol:"BERGEPAINT",yf:"BERGEPAINT.NS",name:"Berger Paints India",sector:"Consumer",lotSize:1100},
  {symbol:"GODREJCP",yf:"GODREJCP.NS",name:"Godrej Consumer Products",sector:"FMCG",lotSize:500},
  {symbol:"TORNTPHARM",yf:"TORNTPHARM.NS",name:"Torrent Pharmaceuticals",sector:"Pharma",lotSize:250},
  {symbol:"MARICO",yf:"MARICO.NS",name:"Marico Limited",sector:"FMCG",lotSize:1200},
  {symbol:"MUTHOOTFIN",yf:"MUTHOOTFIN.NS",name:"Muthoot Finance",sector:"Finance",lotSize:750},
  {symbol:"MAXHEALTH",yf:"MAXHEALTH.NS",name:"Max Healthcare Institute",sector:"Healthcare",lotSize:1450},
  {symbol:"CUMMINSIND",yf:"CUMMINSIND.NS",name:"Cummins India",sector:"Capital Goods",lotSize:600},
  {symbol:"ICICIPRULI",yf:"ICICIPRULI.NS",name:"ICICI Prudential Life Insurance",sector:"Insurance",lotSize:1500},
  {symbol:"ICICIGI",yf:"ICICIGI.NS",name:"ICICI Lombard General Insurance",sector:"Insurance",lotSize:200},
  {symbol:"INDHOTEL",yf:"INDHOTEL.NS",name:"Indian Hotels (Taj)",sector:"Hotels",lotSize:1500},
  {symbol:"COLPAL",yf:"COLPAL.NS",name:"Colgate-Palmolive India",sector:"FMCG",lotSize:350},
  {symbol:"MCDOWELL-N",yf:"MCDOWELL-N.NS",name:"United Spirits",sector:"FMCG",lotSize:500},
  {symbol:"BOSCHLTD",yf:"BOSCHLTD.NS",name:"Bosch Limited",sector:"Auto",lotSize:25},
  {symbol:"DMART",yf:"DMART.NS",name:"Avenue Supermarts (DMart)",sector:"Retail",lotSize:175},
  {symbol:"LODHA",yf:"LODHA.NS",name:"Macrotech Developers (Lodha)",sector:"Real Estate",lotSize:1050},
  {symbol:"NAUKRI",yf:"NAUKRI.NS",name:"Info Edge (Naukri)",sector:"Internet",lotSize:100},
  {symbol:"LTIM",yf:"LTIM.NS",name:"LTIMindtree",sector:"IT",lotSize:250},
  {symbol:"PERSISTENT",yf:"PERSISTENT.NS",name:"Persistent Systems",sector:"IT",lotSize:175},
  // ‚îÄ‚îÄ NIFTY MIDCAP 150 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {symbol:"RECLTD",yf:"RECLTD.NS",name:"REC Limited",sector:"Finance",lotSize:1900},
  {symbol:"PFC",yf:"PFC.NS",name:"Power Finance Corp",sector:"Finance",lotSize:2300},
  {symbol:"HAL",yf:"HAL.NS",name:"Hindustan Aeronautics",sector:"Defence",lotSize:275},
  {symbol:"BEL",yf:"BEL.NS",name:"Bharat Electronics",sector:"Defence",lotSize:7500},
  {symbol:"DLF",yf:"DLF.NS",name:"DLF Limited",sector:"Real Estate",lotSize:825},
  {symbol:"TATAPOWER",yf:"TATAPOWER.NS",name:"Tata Power",sector:"Power",lotSize:1875},
  {symbol:"TATACHEM",yf:"TATACHEM.NS",name:"Tata Chemicals",sector:"Chemical",lotSize:800},
  {symbol:"GAIL",yf:"GAIL.NS",name:"GAIL India",sector:"Energy",lotSize:5775},
  {symbol:"IOC",yf:"IOC.NS",name:"Indian Oil Corp",sector:"Energy",lotSize:6750},
  {symbol:"INDIGO",yf:"INDIGO.NS",name:"IndiGo (InterGlobe Aviation)",sector:"Aviation",lotSize:325},
  {symbol:"IRCTC",yf:"IRCTC.NS",name:"IRCTC Limited",sector:"Travel",lotSize:875},
  {symbol:"ZOMATO",yf:"ZOMATO.NS",name:"Zomato Limited",sector:"Internet",lotSize:4650},
  {symbol:"DELHIVERY",yf:"DELHIVERY.NS",name:"Delhivery Limited",sector:"Logistics",lotSize:2300},
  {symbol:"ANGELONE",yf:"ANGELONE.NS",name:"Angel One",sector:"Finance",lotSize:250},
  {symbol:"YESBANK",yf:"YESBANK.NS",name:"Yes Bank",sector:"Banking",lotSize:70000},
  {symbol:"IDEA",yf:"IDEA.NS",name:"Vodafone Idea",sector:"Telecom",lotSize:175000},
  {symbol:"SUZLON",yf:"SUZLON.NS",name:"Suzlon Energy",sector:"Energy",lotSize:14700},
  {symbol:"IRFC",yf:"IRFC.NS",name:"Indian Railway Finance Corp",sector:"Finance",lotSize:7500},
  {symbol:"NHPC",yf:"NHPC.NS",name:"NHPC Limited",sector:"Power",lotSize:9000},
  {symbol:"SJVN",yf:"SJVN.NS",name:"SJVN Limited",sector:"Power",lotSize:10000},
  {symbol:"CONCOR",yf:"CONCOR.NS",name:"Container Corporation of India",sector:"Logistics",lotSize:1000},
  {symbol:"SAIL",yf:"SAIL.NS",name:"Steel Authority of India",sector:"Metal",lotSize:7500},
  {symbol:"NMDC",yf:"NMDC.NS",name:"NMDC Limited",sector:"Mining",lotSize:4350},
  {symbol:"ALKEM",yf:"ALKEM.NS",name:"Alkem Laboratories",sector:"Pharma",lotSize:150},
  {symbol:"AUROPHARMA",yf:"AUROPHARMA.NS",name:"Aurobindo Pharma",sector:"Pharma",lotSize:650},
  {symbol:"LUPIN",yf:"LUPIN.NS",name:"Lupin Limited",sector:"Pharma",lotSize:425},
  {symbol:"BIOCON",yf:"BIOCON.NS",name:"Biocon Limited",sector:"Pharma",lotSize:2300},
  {symbol:"ZYDUSLIFE",yf:"ZYDUSLIFE.NS",name:"Zydus Lifesciences",sector:"Pharma",lotSize:700},
  {symbol:"IPCALAB",yf:"IPCALAB.NS",name:"IPCA Laboratories",sector:"Pharma",lotSize:400},
  {symbol:"TORNTPOWER",yf:"TORNTPOWER.NS",name:"Torrent Power",sector:"Power",lotSize:1125},
  {symbol:"TATACOMM",yf:"TATACOMM.NS",name:"Tata Communications",sector:"Telecom",lotSize:575},
  {symbol:"MPHASIS",yf:"MPHASIS.NS",name:"Mphasis Limited",sector:"IT",lotSize:400},
  {symbol:"COFORGE",yf:"COFORGE.NS",name:"Coforge Limited",sector:"IT",lotSize:200},
  {symbol:"KPITTECH",yf:"KPITTECH.NS",name:"KPIT Technologies",sector:"IT",lotSize:750},
  {symbol:"LTTS",yf:"LTTS.NS",name:"L&T Technology Services",sector:"IT",lotSize:275},
  {symbol:"TATAELXSI",yf:"TATAELXSI.NS",name:"Tata Elxsi",sector:"IT",lotSize:175},
  {symbol:"EXIDEIND",yf:"EXIDEIND.NS",name:"Exide Industries",sector:"Auto",lotSize:3600},
  {symbol:"BHARATFORG",yf:"BHARATFORG.NS",name:"Bharat Forge",sector:"Auto",lotSize:1125},
  {symbol:"MOTHERSON",yf:"MOTHERSON.NS",name:"Samvardhana Motherson",sector:"Auto",lotSize:5000},
  {symbol:"ASHOKLEY",yf:"ASHOKLEY.NS",name:"Ashok Leyland",sector:"Auto",lotSize:5000},
  {symbol:"BALKRISIND",yf:"BALKRISIND.NS",name:"Balkrishna Industries",sector:"Auto",lotSize:400},
  {symbol:"APOLLOTYRE",yf:"APOLLOTYRE.NS",name:"Apollo Tyres",sector:"Auto",lotSize:3250},
  {symbol:"MRF",yf:"MRF.NS",name:"MRF Limited",sector:"Auto",lotSize:15},
  {symbol:"TATAMTRDVR",yf:"TATAMTRDVR.NS",name:"Tata Motors DVR",sector:"Auto",lotSize:7950},
  {symbol:"TATAMOTORS",yf:"TATAMOTORS.NS",name:"Tata Motors",sector:"Auto",lotSize:1375},
  {symbol:"M&MFIN",yf:"M%26MFIN.NS",name:"Mahindra & Mahindra Financial",sector:"Finance",lotSize:3000},
  {symbol:"BAJAJHLDNG",yf:"BAJAJHLDNG.NS",name:"Bajaj Holdings & Investment",sector:"Finance",lotSize:125},
  {symbol:"SUNDARMFIN",yf:"SUNDARMFIN.NS",name:"Sundaram Finance",sector:"Finance",lotSize:400},
  {symbol:"PNBHOUSING",yf:"PNBHOUSING.NS",name:"PNB Housing Finance",sector:"Finance",lotSize:900},
  {symbol:"LICIHSGFIN",yf:"LICIHSGFIN.NS",name:"LIC Housing Finance",sector:"Finance",lotSize:2000},
  {symbol:"KARURVYSYA",yf:"KARURVYSYA.NS",name:"Karur Vysya Bank",sector:"Banking",lotSize:4000},
  {symbol:"FEDERALBNK",yf:"FEDERALBNK.NS",name:"Federal Bank",sector:"Banking",lotSize:5000},
  {symbol:"PNB",yf:"PNB.NS",name:"Punjab National Bank",sector:"Banking",lotSize:16000},
  {symbol:"CANBK",yf:"CANBK.NS",name:"Canara Bank",sector:"Banking",lotSize:5000},
  {symbol:"UNIONBANK",yf:"UNIONBANK.NS",name:"Union Bank of India",sector:"Banking",lotSize:10000},
  {symbol:"BANDHANBNK",yf:"BANDHANBNK.NS",name:"Bandhan Bank",sector:"Banking",lotSize:5000},
  {symbol:"RBLBANK",yf:"RBLBANK.NS",name:"RBL Bank",sector:"Banking",lotSize:5000},
  {symbol:"AUBANK",yf:"AUBANK.NS",name:"AU Small Finance Bank",sector:"Banking",lotSize:1000},
  {symbol:"EQUITASBNK",yf:"EQUITASBNK.NS",name:"Equitas Small Finance Bank",sector:"Banking",lotSize:10000},
  {symbol:"UJJIVANSFB",yf:"UJJIVANSFB.NS",name:"Ujjivan Small Finance Bank",sector:"Banking",lotSize:10000},
  {symbol:"SWIGGY",yf:"SWIGGY.NS",name:"Swiggy",sector:"Internet",lotSize:3500},
  {symbol:"PAYTM",yf:"PAYTM.NS",name:"One97 Communications (Paytm)",sector:"Fintech",lotSize:3475},
  {symbol:"POLICYBZR",yf:"POLICYBZR.NS",name:"PB Fintech (PolicyBazaar)",sector:"Fintech",lotSize:1150},
  {symbol:"CARTRADE",yf:"CARTRADE.NS",name:"CarTrade Tech",sector:"Internet",lotSize:1500},
  {symbol:"CAMPUS",yf:"CAMPUS.NS",name:"Campus Activewear",sector:"Consumer",lotSize:3500},
  {symbol:"KFINTECH",yf:"KFINTECH.NS",name:"KFin Technologies",sector:"Fintech",lotSize:1200},
  {symbol:"CAMS",yf:"CAMS.NS",name:"Computer Age Management Services",sector:"Fintech",lotSize:375},
  {symbol:"BSE",yf:"BSE.NS",name:"BSE Limited",sector:"Finance",lotSize:1000},
  {symbol:"MCX",yf:"MCX.NS",name:"Multi Commodity Exchange",sector:"Finance",lotSize:800},
  {symbol:"CDSL",yf:"CDSL.NS",name:"Central Depository Services",sector:"Finance",lotSize:1500},
  {symbol:"IREDA",yf:"IREDA.NS",name:"Indian Renewable Energy Dev Agency",sector:"Finance",lotSize:5000},
  {symbol:"HUDCO",yf:"HUDCO.NS",name:"Housing & Urban Dev Corp",sector:"Finance",lotSize:5000},
  {symbol:"RVNL",yf:"RVNL.NS",name:"Rail Vikas Nigam Limited",sector:"Infrastructure",lotSize:4000},
  {symbol:"NHAI",yf:"NHAI.NS",name:"NHPC Limited",sector:"Infrastructure",lotSize:9000},
  {symbol:"NBCC",yf:"NBCC.NS",name:"NBCC India Limited",sector:"Infrastructure",lotSize:10000},
  {symbol:"RPOWER",yf:"RPOWER.NS",name:"Reliance Power",sector:"Power",lotSize:15000},
  {symbol:"CESC",yf:"CESC.NS",name:"CESC Limited",sector:"Power",lotSize:1750},
  {symbol:"JSWENERGY",yf:"JSWENERGY.NS",name:"JSW Energy",sector:"Power",lotSize:2200},
  {symbol:"RENUKA",yf:"RENUKA.NS",name:"Shree Renuka Sugars",sector:"FMCG",lotSize:12500},
  {symbol:"EMAMILTD",yf:"EMAMILTD.NS",name:"Emami Limited",sector:"FMCG",lotSize:1600},
  {symbol:"GODREJIND",yf:"GODREJIND.NS",name:"Godrej Industries",sector:"Diversified",lotSize:850},
  {symbol:"GODREJPROP",yf:"GODREJPROP.NS",name:"Godrej Properties",sector:"Real Estate",lotSize:475},
  {symbol:"OBEROIRLTY",yf:"OBEROIRLTY.NS",name:"Oberoi Realty",sector:"Real Estate",lotSize:700},
  {symbol:"PRESTIGE",yf:"PRESTIGE.NS",name:"Prestige Estates Projects",sector:"Real Estate",lotSize:1500},
  {symbol:"PHOENIXLTD",yf:"PHOENIXLTD.NS",name:"Phoenix Mills",sector:"Real Estate",lotSize:400},
  {symbol:"SOBHA",yf:"SOBHA.NS",name:"Sobha Limited",sector:"Real Estate",lotSize:1000},
  {symbol:"BRIGADE",yf:"BRIGADE.NS",name:"Brigade Enterprises",sector:"Real Estate",lotSize:1200},
  {symbol:"SUNTV",yf:"SUNTV.NS",name:"Sun TV Network",sector:"Media",lotSize:1250},
  {symbol:"ZEEL",yf:"ZEEL.NS",name:"Zee Entertainment",sector:"Media",lotSize:5000},
  {symbol:"PVRINOX",yf:"PVRINOX.NS",name:"PVR INOX Limited",sector:"Media",lotSize:750},
  {symbol:"NETWORK18",yf:"NETWORK18.NS",name:"Network18 Media",sector:"Media",lotSize:7500},
  {symbol:"TV18BRDCST",yf:"TV18BRDCST.NS",name:"TV18 Broadcast",sector:"Media",lotSize:15000},
  {symbol:"PAGEIND",yf:"PAGEIND.NS",name:"Page Industries (Jockey)",sector:"Consumer",lotSize:30},
  {symbol:"VBL",yf:"VBL.NS",name:"Varun Beverages",sector:"FMCG",lotSize:1250},
  {symbol:"RADICO",yf:"RADICO.NS",name:"Radico Khaitan",sector:"FMCG",lotSize:1000},
  {symbol:"UBL",yf:"UBL.NS",name:"United Breweries",sector:"FMCG",lotSize:650},
  {symbol:"TTKPRESTIG",yf:"TTKPRESTIG.NS",name:"TTK Prestige",sector:"Consumer",lotSize:600},
  {symbol:"VSTIND",yf:"VSTIND.NS",name:"VST Industries",sector:"FMCG",lotSize:300},
  {symbol:"DEVYANI",yf:"DEVYANI.NS",name:"Devyani International",sector:"Food & Bev",lotSize:5000},
  {symbol:"JUBLFOOD",yf:"JUBLFOOD.NS",name:"Jubilant FoodWorks (Dominos)",sector:"Food & Bev",lotSize:1250},
  {symbol:"WESTLIFE",yf:"WESTLIFE.NS",name:"Westlife Foodworld (McDonalds)",sector:"Food & Bev",lotSize:1500},
  {symbol:"SAPPHIRE",yf:"SAPPHIRE.NS",name:"Sapphire Foods India (KFC)",sector:"Food & Bev",lotSize:1500},
  {symbol:"KALYANKJIL",yf:"KALYANKJIL.NS",name:"Kalyan Jewellers",sector:"Jewellery",lotSize:2250},
  {symbol:"SENCO",yf:"SENCO.NS",name:"Senco Gold",sector:"Jewellery",lotSize:1500},
  {symbol:"PCJEWELLER",yf:"PCJEWELLER.NS",name:"PC Jeweller",sector:"Jewellery",lotSize:6000},
  // ‚îÄ‚îÄ NIFTY SMALLCAP / NSE 500 REST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {symbol:"LALPATHLAB",yf:"LALPATHLAB.NS",name:"Dr Lal PathLabs",sector:"Healthcare",lotSize:350},
  {symbol:"METROPOLIS",yf:"METROPOLIS.NS",name:"Metropolis Healthcare",sector:"Healthcare",lotSize:400},
  {symbol:"THYROCARE",yf:"THYROCARE.NS",name:"Thyrocare Technologies",sector:"Healthcare",lotSize:800},
  {symbol:"KRSNAA",yf:"KRSNAA.NS",name:"Krsnaa Diagnostics",sector:"Healthcare",lotSize:1000},
  {symbol:"FORTIS",yf:"FORTIS.NS",name:"Fortis Healthcare",sector:"Healthcare",lotSize:1875},
  {symbol:"NARAYAHLT",yf:"NARAYANHLT.NS",name:"Narayana Hrudayalaya",sector:"Healthcare",lotSize:900},
  {symbol:"RAINBOW",yf:"RAINBOW.NS",name:"Rainbow Children's Medicare",sector:"Healthcare",lotSize:1500},
  {symbol:"VIJAYA",yf:"VIJAYABANK.NS",name:"Vijaya Diagnostics",sector:"Healthcare",lotSize:1500},
  {symbol:"SUVENPHAR",yf:"SUVENPHAR.NS",name:"Suven Pharmaceuticals",sector:"Pharma",lotSize:1250},
  {symbol:"GLENMARK",yf:"GLENMARK.NS",name:"Glenmark Pharmaceuticals",sector:"Pharma",lotSize:1125},
  {symbol:"NATCOPHARM",yf:"NATCOPHARM.NS",name:"Natco Pharma",sector:"Pharma",lotSize:1000},
  {symbol:"GRANULES",yf:"GRANULES.NS",name:"Granules India",sector:"Pharma",lotSize:2850},
  {symbol:"LAURUSLABS",yf:"LAURUSLABS.NS",name:"Laurus Labs",sector:"Pharma",lotSize:2250},
  {symbol:"DISHTV",yf:"DISHTV.NS",name:"Dish TV India",sector:"Telecom",lotSize:30000},
  {symbol:"VODAFONEIN",yf:"IDEA.NS",name:"Vodafone Idea",sector:"Telecom",lotSize:175000},
  {symbol:"HFCL",yf:"HFCL.NS",name:"HFCL Limited",sector:"Telecom",lotSize:9000},
  {symbol:"IIFL",yf:"IIFL.NS",name:"IIFL Finance",sector:"Finance",lotSize:1875},
  {symbol:"JMFINANCIL",yf:"JMFINANCIL.NS",name:"JM Financial",sector:"Finance",lotSize:7500},
  {symbol:"MOTILALOFS",yf:"MOTILALOFS.NS",name:"Motilal Oswal Financial Services",sector:"Finance",lotSize:1000},
  {symbol:"NUVOCO",yf:"NUVOCO.NS",name:"Nuvoco Vistas Corporation",sector:"Cement",lotSize:2000},
  {symbol:"RAMCOCEM",yf:"RAMCOCEM.NS",name:"The Ramco Cements",sector:"Cement",lotSize:850},
  {symbol:"JKCEMENT",yf:"JKCEMENT.NS",name:"JK Cement",sector:"Cement",lotSize:350},
  {symbol:"DALMIACEM",yf:"DALMIACEM.NS",name:"Dalmia Bharat",sector:"Cement",lotSize:375},
  {symbol:"HEIDELBERG",yf:"HEIDELBERG.NS",name:"HeidelbergCement India",sector:"Cement",lotSize:2750},
  {symbol:"BIRLACORPN",yf:"BIRLACORPN.NS",name:"Birla Corporation",sector:"Cement",lotSize:500},
  {symbol:"SHREECEM",yf:"SHREECEM.NS",name:"Shree Cement",sector:"Cement",lotSize:25},
  {symbol:"JKPAPER",yf:"JKPAPER.NS",name:"JK Paper",sector:"Paper",lotSize:3200},
  {symbol:"TNPL",yf:"TNPL.NS",name:"Tamil Nadu Newsprint",sector:"Paper",lotSize:2750},
  {symbol:"WINDLAS",yf:"WINDLAS.NS",name:"Windlas Biotech",sector:"Pharma",lotSize:2000},
  {symbol:"SANOFI",yf:"SANOFI.NS",name:"Sanofi India",sector:"Pharma",lotSize:200},
  {symbol:"ABBOTINDIA",yf:"ABBOTINDIA.NS",name:"Abbott India",sector:"Pharma",lotSize:50},
  {symbol:"PFIZER",yf:"PFIZER.NS",name:"Pfizer India",sector:"Pharma",lotSize:175},
  {symbol:"GLAXO",yf:"GLAXO.NS",name:"GlaxoSmithKline Pharma",sector:"Pharma",lotSize:600},
  {symbol:"ERIS",yf:"ERIS.NS",name:"Eris Lifesciences",sector:"Pharma",lotSize:900},
  {symbol:"MARKSANS",yf:"MARKSANS.NS",name:"Marksans Pharma",sector:"Pharma",lotSize:6250},
  {symbol:"AJANTPHARM",yf:"AJANTPHARM.NS",name:"Ajanta Pharma",sector:"Pharma",lotSize:375},
  {symbol:"FINEORG",yf:"FINEORG.NS",name:"Fine Organic Industries",sector:"Chemical",lotSize:250},
  {symbol:"NAVINFLUOR",yf:"NAVINFLUOR.NS",name:"Navin Fluorine International",sector:"Chemical",lotSize:250},
  {symbol:"DEEPAKNTR",yf:"DEEPAKNTR.NS",name:"Deepak Nitrite",sector:"Chemical",lotSize:850},
  {symbol:"GALAXYSURF",yf:"GALAXYSURF.NS",name:"Galaxy Surfactants",sector:"Chemical",lotSize:175},
  {symbol:"VINDHYATEL",yf:"VINDHYATEL.NS",name:"Vindhya Telelinks",sector:"Telecom",lotSize:500},
  {symbol:"POLYCAB",yf:"POLYCAB.NS",name:"Polycab India",sector:"Capital Goods",lotSize:300},
  {symbol:"KEI",yf:"KEI.NS",name:"KEI Industries",sector:"Capital Goods",lotSize:500},
  {symbol:"FINOLEX",yf:"FINOLEXCAB.NS",name:"Finolex Cables",sector:"Capital Goods",lotSize:1750},
  {symbol:"ABB",yf:"ABB.NS",name:"ABB India",sector:"Capital Goods",lotSize:200},
  {symbol:"GRINDWELL",yf:"GRINDWELL.NS",name:"Grindwell Norton",sector:"Capital Goods",lotSize:600},
  {symbol:"THERMAX",yf:"THERMAX.NS",name:"Thermax Limited",sector:"Capital Goods",lotSize:300},
  {symbol:"BHEL",yf:"BHEL.NS",name:"Bharat Heavy Electricals",sector:"Capital Goods",lotSize:7500},
  {symbol:"TIINDIA",yf:"TIINDIA.NS",name:"Tube Investments of India",sector:"Capital Goods",lotSize:500},
  {symbol:"TIMKEN",yf:"TIMKEN.NS",name:"Timken India",sector:"Capital Goods",lotSize:450},
  {symbol:"SKFINDIA",yf:"SKFINDIA.NS",name:"SKF India",sector:"Capital Goods",lotSize:400},
  {symbol:"SCHAEFFLER",yf:"SCHAEFFLER.NS",name:"Schaeffler India",sector:"Auto",lotSize:250},
  {symbol:"MINDA",yf:"MINDA.NS",name:"Uno Minda",sector:"Auto",lotSize:1750},
  {symbol:"SUPRAJIT",yf:"SUPRAJIT.NS",name:"Suprajit Engineering",sector:"Auto",lotSize:3000},
  {symbol:"MINDAIND",yf:"MINDAIND.NS",name:"Minda Industries",sector:"Auto",lotSize:1750},
  {symbol:"GABRIEL",yf:"GABRIEL.NS",name:"Gabriel India",sector:"Auto",lotSize:4500},
  {symbol:"SHARDACROP",yf:"SHARDACROP.NS",name:"Sharda Cropchem",sector:"Agriculture",lotSize:1500},
  {symbol:"PIIND",yf:"PIIND.NS",name:"PI Industries",sector:"Agriculture",lotSize:375},
  {symbol:"DHANUKA",yf:"DHANUKA.NS",name:"Dhanuka Agritech",sector:"Agriculture",lotSize:600},
  {symbol:"COROMANDEL",yf:"COROMANDEL.NS",name:"Coromandel International",sector:"Agriculture",lotSize:875},
  {symbol:"UPL",yf:"UPL.NS",name:"UPL Limited",sector:"Agriculture",lotSize:2000},
  {symbol:"BAYER",yf:"BAYERCROPS.NS",name:"Bayer CropScience",sector:"Agriculture",lotSize:350},
  {symbol:"SUMICHEM",yf:"SUMICHEM.NS",name:"Sumitomo Chemical India",sector:"Agriculture",lotSize:3000},
  {symbol:"NATIONALUM",yf:"NATIONALUM.NS",name:"National Aluminium Company",sector:"Metal",lotSize:7500},
  {symbol:"WELCORP",yf:"WELCORP.NS",name:"Welspun Corp",sector:"Metal",lotSize:2000},
  {symbol:"GRAPHITE",yf:"GRAPHITE.NS",name:"Graphite India",sector:"Metal",lotSize:2250},
  {symbol:"HINDCOPPER",yf:"HINDCOPPER.NS",name:"Hindustan Copper",sector:"Metal",lotSize:6000},
  {symbol:"MOIL",yf:"MOIL.NS",name:"MOIL Limited",sector:"Mining",lotSize:3000},
  {symbol:"GMRINFRA",yf:"GMRINFRA.NS",name:"GMR Airports Infrastructure",sector:"Infrastructure",lotSize:7500},
  {symbol:"IRB",yf:"IRB.NS",name:"IRB Infrastructure Developers",sector:"Infrastructure",lotSize:6000},
  {symbol:"NCC",yf:"NCC.NS",name:"NCC Limited",sector:"Infrastructure",lotSize:5000},
  {symbol:"HGINFRA",yf:"HGINFRA.NS",name:"H.G. Infra Engineering",sector:"Infrastructure",lotSize:1500},
  {symbol:"KNRCON",yf:"KNRCON.NS",name:"KNR Constructions",sector:"Infrastructure",lotSize:2000},
  {symbol:"JSWINFRA",yf:"JSWINFRA.NS",name:"JSW Infrastructure",sector:"Infrastructure",lotSize:4000},
  {symbol:"PATELENG",yf:"PATELENG.NS",name:"Patel Engineering",sector:"Infrastructure",lotSize:6000},
  {symbol:"MANAPPURAM",yf:"MANAPPURAM.NS",name:"Manappuram Finance",sector:"Finance",lotSize:5000},
  {symbol:"CREDITACC",yf:"CREDITACC.NS",name:"CreditAccess Grameen",sector:"Finance",lotSize:900},
  {symbol:"SPANDANA",yf:"SPANDANA.NS",name:"Spandana Sphoorty Financial",sector:"Finance",lotSize:1500},
  {symbol:"UGROCAP",yf:"UGROCAP.NS",name:"Ugro Capital",sector:"Finance",lotSize:4000},
  {symbol:"ARMAN",yf:"ARMAN.NS",name:"Arman Financial Services",sector:"Finance",lotSize:500},
  {symbol:"SUNDPHARMA",yf:"SUNPHARMA.NS",name:"Sun Pharmaceutical",sector:"Pharma",lotSize:350},
  {symbol:"GUJGASLTD",yf:"GUJGASLTD.NS",name:"Gujarat Gas",sector:"Energy",lotSize:1500},
  {symbol:"MGL",yf:"MGL.NS",name:"Mahanagar Gas",sector:"Energy",lotSize:500},
  {symbol:"IGL",yf:"IGL.NS",name:"Indraprastha Gas",sector:"Energy",lotSize:2750},
  {symbol:"PETRONET",yf:"PETRONET.NS",name:"Petronet LNG",sector:"Energy",lotSize:3000},
  {symbol:"CASTROLIND",yf:"CASTROLIND.NS",name:"Castrol India",sector:"Energy",lotSize:4500},
  {symbol:"GUJARATGAS",yf:"GUJARATGAS.NS",name:"Gujarat Gas (GGL)",sector:"Energy",lotSize:1500},
  {symbol:"AEGISCHEM",yf:"AEGISCHEM.NS",name:"Aegis Logistics",sector:"Logistics",lotSize:2500},
  {symbol:"MAHLOG",yf:"MAHLOG.NS",name:"Mahindra Logistics",sector:"Logistics",lotSize:1500},
  {symbol:"BLUEDART",yf:"BLUEDART.NS",name:"Blue Dart Express",sector:"Logistics",lotSize:125},
  {symbol:"TCI",yf:"TCIL.NS",name:"TCI Developers",sector:"Logistics",lotSize:1500},
  {symbol:"GESHIP",yf:"GESHIP.NS",name:"Great Eastern Shipping",sector:"Logistics",lotSize:800},
  {symbol:"SCI",yf:"SCI.NS",name:"Shipping Corp of India",sector:"Logistics",lotSize:5000},
  {symbol:"COCHINSHIP",yf:"COCHINSHIP.NS",name:"Cochin Shipyard",sector:"Defence",lotSize:2000},
  {symbol:"MAZAGON",yf:"MAZDOCK.NS",name:"Mazagon Dock Shipbuilders",sector:"Defence",lotSize:750},
  {symbol:"MIDHANI",yf:"MIDHANI.NS",name:"Mishra Dhatu Nigam",sector:"Defence",lotSize:3500},
  {symbol:"PARAS",yf:"PARAS.NS",name:"Paras Defence and Space Tech",sector:"Defence",lotSize:750},
  {symbol:"DATAPATTNS",yf:"DATAPATTNS.NS",name:"Data Patterns India",sector:"Defence",lotSize:350},
  {symbol:"IDEAFORGE",yf:"IDEAFORGE.NS",name:"ideaForge Technology",sector:"Defence",lotSize:1250},
  {symbol:"ASTRAL",yf:"ASTRAL.NS",name:"Astral Limited",sector:"Building Materials",lotSize:500},
  {symbol:"SUPREMEIND",yf:"SUPREMEIND.NS",name:"Supreme Industries",sector:"Building Materials",lotSize:400},
  {symbol:"PRINCEPIPE",yf:"PRINCEPIPE.NS",name:"Prince Pipes and Fittings",sector:"Building Materials",lotSize:2500},
  {symbol:"HATSUN",yf:"HATSUN.NS",name:"Hatsun Agro Product",sector:"FMCG",lotSize:1500},
  {symbol:"AVANTIFEED",yf:"AVANTIFEED.NS",name:"Avanti Feeds",sector:"Food & Bev",lotSize:2000},
  {symbol:"ZYDUSWELL",yf:"ZYDUSWELL.NS",name:"Zydus Wellness",sector:"FMCG",lotSize:400},
  {symbol:"JYOTHYLAB",yf:"JYOTHYLAB.NS",name:"Jyothy Labs",sector:"FMCG",lotSize:2500},
  {symbol:"HONASA",yf:"HONASA.NS",name:"Honasa Consumer (Mamaearth)",sector:"FMCG",lotSize:1500},
  {symbol:"NIFTYIT",yf:"NIFTYIT.NS",name:"Nifty IT",sector:"IT",lotSize:175},
  {symbol:"HEXAWARE",yf:"HEXAWARE.NS",name:"Hexaware Technologies",sector:"IT",lotSize:2000},
  {symbol:"CYIENT",yf:"CYIENT.NS",name:"Cyient Limited",sector:"IT",lotSize:1000},
  {symbol:"ZENSAR",yf:"ZENSAR.NS",name:"Zensar Technologies",sector:"IT",lotSize:2000},
  {symbol:"NIIT",yf:"NIIT.NS",name:"NIIT Limited",sector:"IT",lotSize:5000},
  {symbol:"MASTEK",yf:"MASTEK.NS",name:"Mastek Limited",sector:"IT",lotSize:500},
  {symbol:"RATEGAIN",yf:"RATEGAIN.NS",name:"RateGain Travel Technologies",sector:"IT",lotSize:1000},
  {symbol:"JUSTDIAL",yf:"JUSTDIAL.NS",name:"Just Dial",sector:"Internet",lotSize:1000},
  {symbol:"INDIAMART",yf:"INDIAMART.NS",name:"IndiaMART InterMESH",sector:"Internet",lotSize:350},
  {symbol:"MAPMYINDIA",yf:"MAPMYINDIA.NS",name:"CE Info Systems (MapMyIndia)",sector:"Internet",lotSize:750},
  {symbol:"NAZARA",yf:"NAZARA.NS",name:"Nazara Technologies",sector:"Internet",lotSize:1250},
  {symbol:"EASEMYTRIP",yf:"EASEMYTRIP.NS",name:"Easy Trip Planners",sector:"Travel",lotSize:10000},
  {symbol:"SPICEJET",yf:"SPICEJET.NS",name:"SpiceJet",sector:"Aviation",lotSize:10000},
  {symbol:"EIDPARRY",yf:"EIDPARRY.NS",name:"EID Parry India",sector:"Agriculture",lotSize:2750},
  {symbol:"BALRAMCHIN",yf:"BALRAMCHIN.NS",name:"Balrampur Chini Mills",sector:"Agriculture",lotSize:2000},
  {symbol:"TRIVENI",yf:"TRIVENI.NS",name:"Triveni Engineering",sector:"Agriculture",lotSize:3000},
  {symbol:"SHAKTIPUMP",yf:"SHAKTIPUMP.NS",name:"Shakti Pumps India",sector:"Capital Goods",lotSize:750},
  {symbol:"KIRLOSKAR",yf:"KIRLOSKAR.NS",name:"Kirloskar Brothers",sector:"Capital Goods",lotSize:1000},
  {symbol:"VOLTAS",yf:"VOLTAS.NS",name:"Voltas Limited",sector:"Consumer",lotSize:1000},
  {symbol:"BLUESTAR",yf:"BLUESTAR.NS",name:"Blue Star Limited",sector:"Consumer",lotSize:500},
  {symbol:"WHIRLPOOL",yf:"WHIRLPOOL.NS",name:"Whirlpool of India",sector:"Consumer",lotSize:500},
  {symbol:"DIXON",yf:"DIXON.NS",name:"Dixon Technologies India",sector:"Consumer",lotSize:250},
  {symbol:"AMBER",yf:"AMBER.NS",name:"Amber Enterprises India",sector:"Consumer",lotSize:250},
  {symbol:"KAJARIACER",yf:"KAJARIACER.NS",name:"Kajaria Ceramics",sector:"Building Materials",lotSize:700},
  {symbol:"CERA",yf:"CERA.NS",name:"Cera Sanitaryware",sector:"Building Materials",lotSize:150},
  {symbol:"ORIENTELEC",yf:"ORIENTELEC.NS",name:"Orient Electric",sector:"Consumer",lotSize:4000},
  {symbol:"SYMPHONY",yf:"SYMPHONY.NS",name:"Symphony Limited",sector:"Consumer",lotSize:500},
  {symbol:"CROMPTON",yf:"CROMPTON.NS",name:"Crompton Greaves Consumer",sector:"Consumer",lotSize:3000},
  {symbol:"VIP",yf:"VIPIND.NS",name:"V.I.P. Industries",sector:"Consumer",lotSize:2000},
  {symbol:"SAFARI",yf:"SAFARI.NS",name:"Safari Industries India",sector:"Consumer",lotSize:350},
  {symbol:"KANSAINER",yf:"KANSAINER.NS",name:"Kansai Nerolac Paints",sector:"Consumer",lotSize:2250},
  {symbol:"AKZONOBEL",yf:"AKZOINDIA.NS",name:"Akzo Nobel India",sector:"Consumer",lotSize:200},
  {symbol:"SHEELA",yf:"SHEELADHA.NS",name:"Sheela Foam",sector:"Consumer",lotSize:500},
  {symbol:"RELAXO",yf:"RELAXO.NS",name:"Relaxo Footwears",sector:"Consumer",lotSize:1500},
  {symbol:"BATA",yf:"BATAINDIA.NS",name:"Bata India",sector:"Consumer",lotSize:750},
  {symbol:"AETHER",yf:"AETHER.NS",name:"Aether Industries",sector:"Chemical",lotSize:750},
  {symbol:"CLEAN",yf:"CLEAN.NS",name:"Clean Science and Technology",sector:"Chemical",lotSize:700},
  {symbol:"FLUOROCHEM",yf:"FLUOROCHEM.NS",name:"Gujarat Fluorochemicals",sector:"Chemical",lotSize:500},
  {symbol:"IGPL",yf:"IGPL.NS",name:"IG Petrochemicals",sector:"Chemical",lotSize:900},
  {symbol:"ALKYLAMINE",yf:"ALKYLAMINE.NS",name:"Alkyl Amines Chemicals",sector:"Chemical",lotSize:350},
  {symbol:"VSBL",yf:"VSBL.NS",name:"Vishnu Solvents and Biofuels",sector:"Chemical",lotSize:2000},
  {symbol:"AAVAS",yf:"AAVAS.NS",name:"Aavas Financiers",sector:"Finance",lotSize:400},
  {symbol:"HOMEFIRST",yf:"HOMEFIRST.NS",name:"Home First Finance",sector:"Finance",lotSize:750},
  {symbol:"APTUS",yf:"APTUS.NS",name:"Aptus Value Housing Finance",sector:"Finance",lotSize:1750},
  {symbol:"GPIL",yf:"GPIL.NS",name:"Godawari Power & Ispat",sector:"Metal",lotSize:1250},
  {symbol:"RATNAMANI",yf:"RATNAMANI.NS",name:"Ratnamani Metals & Tubes",sector:"Metal",lotSize:250},
  {symbol:"JINDALSAW",yf:"JINDALSAW.NS",name:"Jindal Saw",sector:"Metal",lotSize:3500},
  {symbol:"APL",yf:"APLAPOLLO.NS",name:"APL Apollo Tubes",sector:"Metal",lotSize:1250},
  {symbol:"STLTECH",yf:"STLTECH.NS",name:"Sterlite Technologies",sector:"Telecom",lotSize:3500},
  {symbol:"HEXTAWARE",yf:"HEXAWARE.NS",name:"Hexaware Technologies",sector:"IT",lotSize:2000},
  {symbol:"TANLA",yf:"TANLA.NS",name:"Tanla Platforms",sector:"IT",lotSize:900},
  {symbol:"ROUTE",yf:"ROUTE.NS",name:"Route Mobile",sector:"IT",lotSize:600},
  {symbol:"INTELLECT",yf:"INTELLECT.NS",name:"Intellect Design Arena",sector:"IT",lotSize:1250},
  {symbol:"MTAR",yf:"MTAR.NS",name:"MTAR Technologies",sector:"Defence",lotSize:350},
  {symbol:"DYNAMATECH",yf:"DYNAMATECH.NS",name:"Dynamatic Technologies",sector:"Defence",lotSize:200},
  {symbol:"BEML",yf:"BEML.NS",name:"BEML Limited",sector:"Defence",lotSize:500},
  {symbol:"GLND",yf:"GLND.NS",name:"Glenmark Life Sciences",sector:"Pharma",lotSize:1500},
  {symbol:"VIJAYABANK",yf:"VIJAYABANK.NS",name:"Vijaya Diagnostics Centre",sector:"Healthcare",lotSize:1500},
  {symbol:"CRISIL",yf:"CRISIL.NS",name:"CRISIL Limited",sector:"Finance",lotSize:200},
  {symbol:"ICRA",yf:"ICRA.NS",name:"ICRA Limited",sector:"Finance",lotSize:125},
  {symbol:"SPORTKING",yf:"SPORTKING.NS",name:"Sportking India",sector:"Textile",lotSize:750},
  {symbol:"VARDHMAN",yf:"VTL.NS",name:"Vardhman Textiles",sector:"Textile",lotSize:600},
  {symbol:"RAYMOND",yf:"RAYMOND.NS",name:"Raymond Limited",sector:"Textile",lotSize:500},
  {symbol:"KPR",yf:"KPRMILL.NS",name:"K.P.R. Mill",sector:"Textile",lotSize:1250},
  {symbol:"NIITLTD",yf:"NIITLTD.NS",name:"NIIT Technologies",sector:"IT",lotSize:1000},
  {symbol:"NESCO",yf:"NESCO.NS",name:"NESCO Limited",sector:"Real Estate",lotSize:500},
  {symbol:"CAPACITE",yf:"CAPACITE.NS",name:"Capacit'e Infraprojects",sector:"Infrastructure",lotSize:3500},
  {symbol:"PSP",yf:"PSPPROJECT.NS",name:"PSP Projects",sector:"Infrastructure",lotSize:500},
  {symbol:"AHLUWALIA",yf:"AHLUCONT.NS",name:"Ahluwalia Contracts",sector:"Infrastructure",lotSize:1500},
  {symbol:"JTLIND",yf:"JTLIND.NS",name:"JTL Industries",sector:"Metal",lotSize:4000},
  {symbol:"SUYOG",yf:"SUYOG.NS",name:"Suyog Telematics",sector:"Infrastructure",lotSize:500},
  {symbol:"MAZDOCK",yf:"MAZDOCK.NS",name:"Mazagon Dock Shipbuilders",sector:"Defence",lotSize:750},
  {symbol:"MTARTECH",yf:"MTARTECH.NS",name:"MTAR Technologies",sector:"Defence",lotSize:350},
  {symbol:"PGHL",yf:"PGHL.NS",name:"Procter & Gamble Health",sector:"FMCG",lotSize:100},
  {symbol:"HINDPETRO",yf:"HINDPETRO.NS",name:"HPCL (Hindustan Petroleum)",sector:"Energy",lotSize:2875},
  {symbol:"OIL",yf:"OIL.NS",name:"Oil India Limited",sector:"Energy",lotSize:1900},
  {symbol:"OLECTRA",yf:"OLECTRA.NS",name:"Olectra Greentech",sector:"Auto",lotSize:750},
  {symbol:"TVSMOTOR",yf:"TVSMOTOR.NS",name:"TVS Motor Company",sector:"Auto",lotSize:375},
  {symbol:"ESCORTS",yf:"ESCORTS.NS",name:"Escorts Kubota",sector:"Auto",lotSize:375},
  {symbol:"ATUL",yf:"ATUL.NS",name:"Atul Limited",sector:"Chemical",lotSize:125},
  {symbol:"BALAMINES",yf:"BALAMINES.NS",name:"Balaji Amines",sector:"Chemical",lotSize:500},
  {symbol:"CHEMPLASTS",yf:"CHEMPLASTS.NS",name:"Chemplast Sanmar",sector:"Chemical",lotSize:1000},
  {symbol:"NOCIL",yf:"NOCIL.NS",name:"NOCIL Limited",sector:"Chemical",lotSize:3500},
  {symbol:"SUDARSCHEM",yf:"SUDARSCHEM.NS",name:"Sudarshan Chemical Industries",sector:"Chemical",lotSize:1500},
  {symbol:"LSIL",yf:"LSIL.NS",name:"Lloyds Steels Industries",sector:"Metal",lotSize:12500},
  {symbol:"WELSPUNLIV",yf:"WELSPUNLIV.NS",name:"Welspun Living",sector:"Textile",lotSize:5000},
  {symbol:"TRIDENT",yf:"TRIDENT.NS",name:"Trident Limited",sector:"Textile",lotSize:15000},
  {symbol:"NITIN",yf:"NITINFIRE.NS",name:"Nitin Fire Protection",sector:"Capital Goods",lotSize:5000},
  {symbol:"NUVAMA",yf:"NUVAMA.NS",name:"Nuvama Wealth Management",sector:"Finance",lotSize:300},
  {symbol:"360ONE",yf:"360ONE.NS",name:"360 ONE WAM",sector:"Finance",lotSize:550},
  {symbol:"UTIAMC",yf:"UTIAMC.NS",name:"UTI Asset Management Company",sector:"Finance",lotSize:750},
  {symbol:"ABSLAMC",yf:"ABSLAMC.NS",name:"Aditya Birla Sun Life AMC",sector:"Finance",lotSize:600},
  {symbol:"HDFCAMC",yf:"HDFCAMC.NS",name:"HDFC Asset Management",sector:"Finance",lotSize:300},
  {symbol:"NIPPONLIFE",yf:"NIPPONLIFE.NS",name:"Nippon Life India AMC",sector:"Finance",lotSize:1250},
  {symbol:"AIAENG",yf:"AIAENG.NS",name:"AIA Engineering",sector:"Capital Goods",lotSize:225},
  {symbol:"ELGIEQUIP",yf:"ELGIEQUIP.NS",name:"Elgi Equipments",sector:"Capital Goods",lotSize:2000},
  {symbol:"GREENPANEL",yf:"GREENPANEL.NS",name:"Greenpanel Industries",sector:"Building Materials",lotSize:3000},
  {symbol:"CENTURYPLY",yf:"CENTURYPLY.NS",name:"Century Plyboards India",sector:"Building Materials",lotSize:2500},
  {symbol:"GREENPLY",yf:"GREENPLY.NS",name:"Greenply Industries",sector:"Building Materials",lotSize:4000},
  {symbol:"GMRAIRPORT",yf:"GMRAIRPORT.NS",name:"GMR Airports Ltd",sector:"Infrastructure",lotSize:7500},
  {symbol:"ADANIENSOL",yf:"ADANIENSOL.NS",name:"Adani Energy Solutions",sector:"Power",lotSize:1375},
  {symbol:"ADANITRANS",yf:"ADANITRANS.NS",name:"Adani Transmission",sector:"Power",lotSize:400},
  {symbol:"ATGL",yf:"ATGL.NS",name:"Adani Total Gas",sector:"Energy",lotSize:1100},
  {symbol:"KIOCL",yf:"KIOCL.NS",name:"KIOCL Limited",sector:"Mining",lotSize:3500},
];

// ============================================================
// FIREBASE CONFIG ‚Äî APNA CONFIG YAHAN PASTE KAREIN
// Firebase Console: https://console.firebase.google.com
// ============================================================
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyDMtUZ11q9KpDLdX1dc21-7fPzCyVgwL5o",
  authDomain: "lakshit-2f0c8.firebaseapp.com",
  projectId: "lakshit-2f0c8",
  storageBucket: "lakshit-2f0c8.firebasestorage.app",
  messagingSenderId: "759147271385",
  appId: "1:759147271385:web:425d87dc419c7530b71ac8",
  measurementId: "G-N3XNE4H7C8"
};

// Firebase init
let fbApp, fbAuth, fbDb, fbReady = false;
function initFirebase(){
  try{
    // Check if Firebase SDK loaded
    if(typeof firebase === 'undefined'){
      console.warn("Firebase SDK not loaded yet ‚Äî retrying in 500ms");
      setTimeout(initFirebase, 500);
      return false;
    }
    if(firebase.apps && firebase.apps.length === 0){
      fbApp = firebase.initializeApp(FIREBASE_CONFIG);
    } else {
      fbApp = firebase.apps[0];
    }
    fbAuth = firebase.auth();
    fbDb   = firebase.firestore();
    fbReady = true;
    console.log("‚úÖ Firebase ready");

    // Handle Google redirect result (for localhost popup-blocked case)
    fbAuth.getRedirectResult().then(async (result) => {
      if(result && result.user && !user){
        try{ await handleGoogleUser(result.user); }
        catch(e){ console.warn("Redirect result error:", e); }
      }
    }).catch(e => console.warn("getRedirectResult error:", e));

    // Auth state listener ‚Äî auto-login agar session hai
    fbAuth.onAuthStateChanged(async (fbUser) => {
      if(fbUser && !user){
        try{
          const snap = await fbDb.collection("users").doc(fbUser.uid).get();
          if(snap.exists){
            const ud = snap.data();
            user = { name: ud.name, email: fbUser.email, avatar: ud.avatar || fbUser.email[0].toUpperCase(), createdAt: ud.createdAt, uid: fbUser.uid };
            await loadUserDataFromServer(fbUser.uid);
            document.getElementById("auth-screen").style.display="none";
            document.getElementById("app").style.display="block";
            document.getElementById("user-avatar").textContent = user.avatar;
            initApp();
          }
        }catch(e){ console.warn("Auto-login failed:", e); }
      }
    });
    return true;
  }catch(e){ console.warn("Firebase init error:",e); return false; }
}

// ============================================================
// FIREBASE ‚Äî USER DATA FUNCTIONS
// ============================================================
async function loadUserDataFromServer(uid){
  try{
    const snap = await fbDb.collection("userData").doc(uid).get();
    if(snap.exists){
      const data = snap.data();
      balance    = data.balance    ?? 1000000;
      usedMargin = data.usedMargin ?? 0;
      positions  = data.positions  ?? [];
      orders     = data.orders     ?? [];
      gttOrders  = data.gttOrders  ?? [];
      watchlist  = data.watchlist  ?? ["RELIANCE","TCS","HDFCBANK","INFOSYS","SBIN"];
    }
  }catch(e){ console.warn("loadUserData error:",e); }
}

async function saveUserDataToServer(uid, data){
  if(!fbReady || !uid) return;
  try{
    await fbDb.collection("userData").doc(uid).set(data, {merge:true});
  }catch(e){ console.warn("saveUserData error:",e); }
}

// ============================================================
// MULTI-USER ACCOUNT SYSTEM (Firebase-powered)
// ============================================================
let pendingLoginUser = null;

// Local fallback helpers (cache)
const LOCAL_KEY = "tradesim_localcache";
function getLocalCache(){ try{return JSON.parse(localStorage.getItem(LOCAL_KEY))||{users:[]}}catch(e){return{users:[]}} }
function setLocalCache(d){ localStorage.setItem(LOCAL_KEY, JSON.stringify(d)); }
function getAllUsers(){
  const c = getLocalCache();
  return c.users || [];
}
function saveAllUsers(users){
  const c = getLocalCache(); c.users = users; setLocalCache(c);
}
function getUserData(email){ return null; }     // not used ‚Äî Firebase handles it
function saveUserData(email, data){}            // not used ‚Äî Firebase handles it
function getSession(){ return null; }
function saveSession(email){}
function clearSession(){}

function showFbError(id1, id2, msg){
  [id1,id2].forEach(id=>{ const el=document.getElementById(id); if(el){ el.textContent=msg; el.style.display='block'; } });
}
function showLoadingBtn(id, text){ const el=document.getElementById(id); if(el){el.textContent=text; el.disabled=true;} }
function resetLoadingBtn(id, text){ const el=document.getElementById(id); if(el){el.textContent=text; el.disabled=false;} }

// Password strength checker
function checkPassStrength(val, suffix='su'){
  const bar = document.getElementById('pass-strength-'+(suffix||'su'));
  if(!bar) return;
  let strength=0, color='#e74c3c', width='20%';
  if(val.length>=6) strength++;
  if(val.length>=10) strength++;
  if(/[A-Z]/.test(val)) strength++;
  if(/[0-9]/.test(val)) strength++;
  if(/[^A-Za-z0-9]/.test(val)) strength++;
  if(strength<=1){ color='#e74c3c'; width='20%'; }
  else if(strength===2){ color='#e67e22'; width='40%'; }
  else if(strength===3){ color='#f1c40f'; width='65%'; }
  else { color='#2d6a4f'; width='100%'; }
  bar.style.background=color; bar.style.width=width;
}

// Toggle password visibility
function togglePass(inputId, btn){
  const inp = document.getElementById(inputId);
  if(!inp) return;
  inp.type = inp.type==='password' ? 'text' : 'password';
  btn.textContent = inp.type==='password' ? 'üëÅ' : 'üôà';
}

// Show correct auth form
function showAuthForm(form){
  document.getElementById('account-picker').style.display='none';
  document.getElementById('login-form').style.display='none';
  document.getElementById('signup-form').style.display='none';
  document.getElementById('first-time-form').style.display='none';
  document.getElementById('forgot-form').style.display='none';
  document.getElementById('email-login-form').style.display='none';
  if(form==='picker') document.getElementById('account-picker').style.display='block';
  else if(form==='login') document.getElementById('login-form').style.display='block';
  else if(form==='signup') document.getElementById('signup-form').style.display='block';
  else if(form==='first') document.getElementById('first-time-form').style.display='block';
  else if(form==='forgot') document.getElementById('forgot-form').style.display='block';
  else if(form==='email-login'){ document.getElementById('email-login-form').style.display='block'; setTimeout(()=>document.getElementById('el-email').focus(),100); }
  else if(form==='login-picker'){ document.getElementById('account-picker').style.display='block'; }
}

function backToPicker(){
  const users=getAllUsers();
  if(users.length===0) showAuthForm('first');
  else buildAccountPicker();
}

// Build the account picker list
async function buildAccountPicker(){
  try{
    let users = getAllUsers();

    // If Firebase ready and real config, also fetch from Firestore (just local cache for now)
    // Users are cached locally after first signup
    if(users.length===0){ showAuthForm('first'); return; }
    showAuthForm('picker');
    const list=document.getElementById('users-list');
    list.innerHTML=users.map(u=>`
      <div class="user-chip" onclick="selectUser('${u.email}')">
        <div class="user-avatar-sm">${u.avatar}</div>
        <div style="flex:1">
          <div style="font-weight:600;font-size:13px;color:#2e3132">${u.name}</div>
          <div style="font-size:11px;color:rgba(46,49,50,.5)">${u.email}</div>
        </div>
        <div style="font-size:11px;color:rgba(124,98,68,.8);font-weight:500">‚Üí</div>
      </div>`).join('');
  }catch(e){ console.error('buildAccountPicker error:',e); showAuthForm('first'); }
}

function selectUser(email){
  const users=getAllUsers();
  const u=users.find(x=>x.email===email);
  if(!u) return;
  pendingLoginUser=u;
  document.getElementById('login-avatar').textContent=u.avatar;
  document.getElementById('login-name').textContent=u.name;
  document.getElementById('login-email-show').textContent=u.email;
  document.getElementById('login-pass').value='';
  document.getElementById('login-err').style.display='none';
  showAuthForm('login');
  setTimeout(()=>document.getElementById('login-pass').focus(), 100);
}

// First-time signup
function doFirstSignup(){
  const name=document.getElementById('ft-name').value.trim();
  const email=document.getElementById('ft-email').value.trim();
  const pass=document.getElementById('ft-pass').value;
  const pass2=document.getElementById('ft-pass2').value;
  const errEl=document.getElementById('ft-err');
  errEl.style.display='none';
  if(!name){ errEl.textContent='Name likhna zaroori hai'; errEl.style.display='block'; return; }
  if(!email||!email.includes('@')){ errEl.textContent='Valid email address likhein'; errEl.style.display='block'; return; }
  if(pass.length<6){ errEl.textContent='Password kam se kam 6 characters ka hona chahiye'; errEl.style.display='block'; return; }
  if(pass!==pass2){ errEl.textContent='Dono passwords match nahi kar rahe'; errEl.style.display='block'; return; }
  showLoadingBtn('first-acc-btn','‚è≥ Account ban raha hai...');
  createAccount(name, email, pass);
}

// Additional account signup
function doSignup(){
  const name=document.getElementById('su-name').value.trim();
  const email=document.getElementById('su-email').value.trim();
  const pass=document.getElementById('su-pass').value;
  const pass2=document.getElementById('su-pass2').value;
  const errEl=document.getElementById('signup-err');
  errEl.style.display='none';
  const users=getAllUsers();
  if(!name){ errEl.textContent='Name likhna zaroori hai'; errEl.style.display='block'; return; }
  if(!email||!email.includes('@')){ errEl.textContent='Valid email address likhein'; errEl.style.display='block'; return; }
  if(!fbReady && users.find(u=>u.email===email)){ errEl.textContent='Is email se account pehle se exist karta hai'; errEl.style.display='block'; return; }
  if(pass.length<6){ errEl.textContent='Password kam se kam 6 characters ka hona chahiye'; errEl.style.display='block'; return; }
  if(pass!==pass2){ errEl.textContent='Dono passwords match nahi kar rahe'; errEl.style.display='block'; return; }
  showLoadingBtn('create-acc-btn','‚è≥ Account ban raha hai...');
  createAccount(name, email, pass);
}

function createAccount(name, email, pass){
  if(!fbReady){
    // Fallback to localStorage if Firebase not configured
    const users=getAllUsers();
    if(users.find(u=>u.email===email)){
      const u=users.find(x=>x.email===email);
      if(u.password!==btoa(pass)){ showFbError('ft-err','signup-err','Account already exists. Password galat hai.'); return; }
      loginAsUser(u,'LOCAL'); return;
    }
    const avatar=name[0].toUpperCase();
    const newUser={ name, email, avatar, password: btoa(pass), createdAt: new Date().toLocaleDateString('en-IN'), uid: 'local_'+Date.now() };
    users.push(newUser); saveAllUsers(users);
    loginAsUser(newUser,'LOCAL');
    return;
  }
  // Firebase signup
  const errId = document.getElementById('ft-err') ? 'ft-err' : 'signup-err';
  showLoadingBtn('create-acc-btn', '‚è≥ Account ban raha hai...');
  fbAuth.createUserWithEmailAndPassword(email, pass)
    .then(async (cred) => {
      const uid = cred.user.uid;
      const avatar = name[0].toUpperCase();
      const newUser = { name, email, avatar, uid, createdAt: new Date().toLocaleDateString('en-IN') };
      // Save user profile in Firestore
      await fbDb.collection("users").doc(uid).set(newUser);
      // Save initial trading data
      const initData = { balance:1000000, usedMargin:0, positions:[], orders:[], gttOrders:[], watchlist:["RELIANCE","TCS","HDFCBANK","INFOSYS","SBIN"], savedAt: Date.now() };
      await fbDb.collection("userData").doc(uid).set(initData);
      // Cache locally
      const users = getAllUsers();
      users.push({...newUser, uid});
      saveAllUsers(users);
      // Login
      user = { name, email, avatar, createdAt: newUser.createdAt };
      balance=1000000; usedMargin=0; positions=[]; orders=[]; gttOrders=[];
      watchlist=["RELIANCE","TCS","HDFCBANK","INFOSYS","SBIN"];
      launchApp();
    })
    .catch(e => {
      resetLoadingBtn('create-acc-btn','üöÄ Create Account & Start Trading');
      resetLoadingBtn('first-acc-btn','üöÄ Create Account & Start Trading');
      const msg = e.code === 'auth/email-already-in-use' ? 'Yeh email pehle se registered hai. Login karein.' :
                  e.code === 'auth/weak-password' ? 'Password kam se kam 6 characters ka hona chahiye.' :
                  e.code === 'auth/invalid-email' ? 'Invalid email address.' : e.message;
      showFbError('ft-err', 'signup-err', msg);
    });
}

// Login existing user
function doLogin(){
  if(!pendingLoginUser){ backToPicker(); return; }
  const pass=document.getElementById('login-pass').value;
  const errEl=document.getElementById('login-err');
  errEl.style.display='none';
  if(!pass){ errEl.textContent='Password enter karein'; errEl.style.display='block'; return; }

  if(!fbReady){
    // Fallback localStorage
    if(pendingLoginUser.password !== btoa(pass)){
      errEl.textContent='Password galat hai. Dobara try karein.'; errEl.style.display='block';
      document.getElementById('login-pass').value='';
      document.getElementById('login-pass').focus();
      return;
    }
    loginAsUser(pendingLoginUser,'LOCAL');
    return;
  }

  // Firebase login
  showLoadingBtn('login-btn','‚è≥ Login ho raha hai...');
  fbAuth.signInWithEmailAndPassword(pendingLoginUser.email, pass)
    .then(async (cred) => {
      const uid = cred.user.uid;
      const snap = await fbDb.collection("users").doc(uid).get();
      const ud = snap.exists ? snap.data() : { name: pendingLoginUser.name, avatar: pendingLoginUser.avatar, createdAt: '‚Äî' };
      user = { name: ud.name, email: pendingLoginUser.email, avatar: ud.avatar, createdAt: ud.createdAt, uid };
      await loadUserDataFromServer(uid);
      pendingLoginUser=null;
      launchApp();
    })
    .catch(e => {
      resetLoadingBtn('login-btn','üîê Login to Account');
      errEl.textContent = e.code === 'auth/wrong-password' || e.code === 'auth/invalid-credential'
        ? 'Password galat hai. Dobara try karein.'
        : 'Login failed: ' + e.message;
      errEl.style.display='block';
      document.getElementById('login-pass').value='';
      document.getElementById('login-pass').focus();
    });
}

// ‚îÄ‚îÄ DIRECT EMAIL + PASSWORD LOGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doEmailLogin(){
  const email = document.getElementById('el-email').value.trim();
  const pass  = document.getElementById('el-pass').value;
  const errEl = document.getElementById('el-err');
  errEl.style.display = 'none';

  if(!email || !email.includes('@')){ errEl.textContent='Valid email likhein'; errEl.style.display='block'; return; }
  if(!pass){ errEl.textContent='Password likhein'; errEl.style.display='block'; return; }

  if(!fbReady){
    // localStorage fallback
    const users = getAllUsers();
    const u = users.find(x => x.email === email);
    if(!u){ errEl.textContent='Yeh email registered nahi hai. Pehle account banayein.'; errEl.style.display='block'; return; }
    if(u.password !== btoa(pass)){ errEl.textContent='Password galat hai. Dobara try karein.'; errEl.style.display='block'; document.getElementById('el-pass').value=''; document.getElementById('el-pass').focus(); return; }
    loginAsUser(u,'LOCAL');
    return;
  }

  // Firebase email/password login
  showLoadingBtn('el-login-btn','‚è≥ Login ho raha hai...');
  fbAuth.signInWithEmailAndPassword(email, pass)
    .then(async (cred) => {
      const uid  = cred.user.uid;
      const snap = await fbDb.collection("users").doc(uid).get();
      const ud   = snap.exists ? snap.data() : { name: email.split('@')[0], avatar: email[0].toUpperCase(), createdAt: '‚Äî' };
      user = { name: ud.name, email: email, avatar: ud.avatar, createdAt: ud.createdAt, uid };
      await loadUserDataFromServer(uid);
      // Cache locally
      const users = getAllUsers();
      if(!users.find(u=>u.uid===uid)){
        users.push({name:ud.name, email, avatar:ud.avatar, uid, createdAt:ud.createdAt});
        saveAllUsers(users);
      }
      launchApp();
    })
    .catch(e => {
      resetLoadingBtn('el-login-btn','üîê Login');
      errEl.textContent = (e.code==='auth/wrong-password'||e.code==='auth/invalid-credential')
        ? 'Password galat hai. Dobara try karein.'
        : e.code==='auth/user-not-found'
        ? 'Yeh email registered nahi hai. Pehle account banayein.'
        : e.code==='auth/invalid-email'
        ? 'Invalid email address.'
        : 'Login failed: ' + e.message;
      errEl.style.display='block';
      document.getElementById('el-pass').value='';
      document.getElementById('el-pass').focus();
    });
}

// ============================================================
// GOOGLE LOGIN (OAuth)
// ============================================================
var GOOGLE_SVG = `<svg width="16" height="16" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.08 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-3.58-13.46-8.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>`;

function resetGoogleBtns(label='Google se Login karein'){
  document.querySelectorAll('.google-btn').forEach(b=>{
    b.innerHTML = GOOGLE_SVG + ' ' + label;
    b.disabled = false;
  });
}

async function handleGoogleUser(fbUser){
  let snap = await fbDb.collection('users').doc(fbUser.uid).get();
  let ud;
  if(!snap.exists){
    const name = fbUser.displayName || fbUser.email.split('@')[0];
    const avatar = name[0].toUpperCase();
    ud = { name, email: fbUser.email, avatar, uid: fbUser.uid, createdAt: new Date().toLocaleDateString('en-IN'), provider: 'google' };
    await fbDb.collection('users').doc(fbUser.uid).set(ud);
    await fbDb.collection('userData').doc(fbUser.uid).set({
      balance:1000000, usedMargin:0, positions:[], orders:[], gttOrders:[],
      watchlist:['RELIANCE','TCS','HDFCBANK','INFOSYS','SBIN'], savedAt: Date.now()
    });
    balance=1000000; usedMargin=0; positions=[]; orders=[]; gttOrders=[];
    watchlist=['RELIANCE','TCS','HDFCBANK','INFOSYS','SBIN'];
  } else {
    ud = snap.data();
    await loadUserDataFromServer(fbUser.uid);
  }
  const users = getAllUsers();
  if(!users.find(u=>u.uid===fbUser.uid)){
    users.push({name:ud.name, email:fbUser.email, avatar:ud.avatar, uid:fbUser.uid, createdAt:ud.createdAt});
    saveAllUsers(users);
  }
  user = { name: ud.name, email: fbUser.email, avatar: ud.avatar, createdAt: ud.createdAt, uid: fbUser.uid };
  launchApp();
}

async function doGoogleLogin(){
  // Wait for Firebase if not ready yet
  if(!fbReady){
    document.querySelectorAll('.google-btn').forEach(b=>{ b.innerHTML='‚è≥ Firebase load ho raha hai...'; b.disabled=true; });
    let waited = 0;
    while(!fbReady && waited < 5000){
      await new Promise(r=>setTimeout(r,200));
      waited += 200;
    }
    if(!fbReady){
      resetGoogleBtns();
      alert('Firebase load nahi hua. Page refresh karo (F5) aur dobara try karo.');
      return;
    }
    resetGoogleBtns();
  }

  document.querySelectorAll('.google-btn').forEach(b=>{ b.innerHTML='‚è≥ Google se login ho raha hai...'; b.disabled=true; });

  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });

    let result = null;
    try {
      // First try popup
      result = await fbAuth.signInWithPopup(provider);
    } catch(popupErr) {
      console.warn('Popup failed:', popupErr.code);
      if(
        popupErr.code === 'auth/popup-blocked' ||
        popupErr.code === 'auth/unauthorized-domain' ||
        popupErr.code === 'auth/operation-not-supported-in-this-environment'
      ){
        // Use redirect as fallback
        document.querySelectorAll('.google-btn').forEach(b=>{ b.innerHTML='‚è≥ Redirect ho raha hai...'; });
        await fbAuth.signInWithRedirect(provider);
        return; // Page reload hoga, getRedirectResult handle karega
      }
      if(popupErr.code === 'auth/popup-closed-by-user'){
        resetGoogleBtns(); return;
      }
      throw popupErr;
    }

    if(result && result.user){
      await handleGoogleUser(result.user);
    }

  }catch(e){
    console.error('Google login error:', e);
    resetGoogleBtns();
    const msg = e.code === 'auth/account-exists-with-different-credential'
      ? 'Is email se pehle se account hai. Email/password se login karein.'
      : e.code === 'auth/network-request-failed'
      ? 'Network error. Internet connection check karo.'
      : `Google login failed: ${e.message || e.code}`;
    alert(msg);
  }
}

// ============================================================
// FORGOT PASSWORD
// ============================================================
function showForgotPassword(){
  document.getElementById('forgot-success').style.display='none';
  document.getElementById('forgot-fields').style.display='block';
  document.getElementById('forgot-email').value = pendingLoginUser ? pendingLoginUser.email : '';
  document.getElementById('forgot-err').style.display='none';
  showAuthForm('forgot');
  setTimeout(()=>document.getElementById('forgot-email').focus(),100);
}

async function doForgotPassword(){
  const email = document.getElementById('forgot-email').value.trim();
  const errEl = document.getElementById('forgot-err');
  errEl.style.display='none';
  if(!email || !email.includes('@')){ errEl.textContent='Valid email address likhein'; errEl.style.display='block'; return; }
  if(!fbReady){
    const users = getAllUsers();
    if(!users.find(u=>u.email===email)){ errEl.textContent='Is email se koi account nahi mila.'; errEl.style.display='block'; return; }
    document.getElementById('forgot-success-email').textContent = email + ' pe (local mode ‚Äî actual email nahi jaayega)';
    document.getElementById('forgot-success').style.display='block';
    document.getElementById('forgot-fields').style.display='none';
    return;
  }
  showLoadingBtn('forgot-btn','‚è≥ Email bheja ja raha hai...');
  try{
    await fbAuth.sendPasswordResetEmail(email);
    document.getElementById('forgot-success-email').textContent = email + ' pe reset link bhej diya';
    document.getElementById('forgot-success').style.display='block';
    document.getElementById('forgot-fields').style.display='none';
  }catch(e){
    resetLoadingBtn('forgot-btn','üìß Reset Link Bhejein');
    const msg = e.code === 'auth/user-not-found' ? 'Is email se koi account register nahi hai.' :
                e.code === 'auth/invalid-email' ? 'Invalid email address.' : e.message;
    errEl.textContent = msg; errEl.style.display='block';
  }
}


function loginAsUser(u, mode='FIREBASE'){
  user={ name:u.name, email:u.email, avatar:u.avatar, createdAt:u.createdAt };
  if(mode==='LOCAL'){
    // Load from localStorage cache
    try{
      const c = getLocalCache();
      const d = c['data_'+u.email];
      if(d){ balance=d.balance??1000000; usedMargin=d.usedMargin??0; positions=d.positions??[]; orders=d.orders??[]; gttOrders=d.gttOrders??[]; watchlist=d.watchlist??["RELIANCE","TCS","HDFCBANK","INFOSYS","SBIN"]; }
      else { balance=1000000; usedMargin=0; positions=[]; orders=[]; gttOrders=[]; watchlist=["RELIANCE","TCS","HDFCBANK","INFOSYS","SBIN"]; }
    }catch(e){ balance=1000000; usedMargin=0; positions=[]; orders=[]; gttOrders=[]; }
  }
  pendingLoginUser=null;
  launchApp();
}

// ============================================================
// SAVE / LOAD PER-USER STATE
// ============================================================
function saveState(){
  if(!user) return;
  const data={ balance, usedMargin, positions, orders, gttOrders, watchlist, savedAt: Date.now() };
  // Save to Firebase if available
  const fbUser = fbReady && fbAuth.currentUser;
  if(fbUser){
    saveUserDataToServer(fbUser.uid, data);
  } else {
    // Fallback ‚Äî save to localStorage cache
    const c = getLocalCache();
    c['data_'+user.email] = data;
    setLocalCache(c);
  }
}

function loadState(){
  // Firebase auth state is handled via onAuthStateChanged listener in initFirebase()
  // This function just returns false; auto-login happens via Firebase listener
  return false;
}

function resetAllData(){
  if(!confirm("‚ö†Ô∏è Sab kuch reset ho jaayega ‚Äî balance, positions, orders, watchlist. Sure ho?"))return;
  balance=1000000; usedMargin=0; positions=[]; orders=[]; gttOrders=[];
  watchlist=["RELIANCE","TCS","HDFCBANK","INFOSYS","SBIN"];
  showNotif("Data reset kar diya gaya ‚úì","success");
  saveState();
  closeProfile();
  renderAll();
}

// Logout
function doLogout(){
  if(!confirm("Kya aap logout karna chahte hain?")) return;
  saveState();
  if(fbReady && fbAuth.currentUser){ fbAuth.signOut(); }
  clearSession();
  user=null; balance=1000000; usedMargin=0; positions=[]; orders=[]; gttOrders=[];
  closeProfile();
  document.getElementById("app").style.display="none";
  document.getElementById("auth-screen").style.display="flex";
  buildAccountPicker();
}

// ============================================================
// PROFILE MODAL
// ============================================================
function openProfile(){
  if(!user) return;
  document.getElementById('profile-avatar').textContent=user.avatar;
  document.getElementById('profile-name').textContent=user.name;
  document.getElementById('profile-email').textContent=user.email;
  document.getElementById('profile-joined').textContent=`Account created: ${user.createdAt||'‚Äî'}`;
  const portVal=positions.reduce((a,p)=>a+(getPrice(p.symbol)*p.qty),0);
  const totalPnL=positions.reduce((a,p)=>{const cp=getPrice(p.symbol);return a+(p.type==="BUY"?(cp-p.avgPrice):(p.avgPrice-cp))*p.qty},0);
  const closed=orders.filter(o=>o.pnl!==undefined);
  const realisedPnL=closed.reduce((a,o)=>a+o.pnl,0);
  const wins=closed.filter(o=>o.pnl>0).length;
  document.getElementById('profile-stats').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div style="text-align:center;padding:10px;background:var(--card);border-radius:8px">
        <div style="font-size:10px;color:var(--faint);margin-bottom:4px">Net Worth</div>
        <div class="mono" style="font-weight:700;font-size:13px;color:var(--accent)">${fmtC(balance+portVal)}</div>
      </div>
      <div style="text-align:center;padding:10px;background:var(--card);border-radius:8px">
        <div style="font-size:10px;color:var(--faint);margin-bottom:4px">Available</div>
        <div class="mono" style="font-weight:700;font-size:13px">${fmtC(balance)}</div>
      </div>
      <div style="text-align:center;padding:10px;background:var(--card);border-radius:8px">
        <div style="font-size:10px;color:var(--faint);margin-bottom:4px">Open P&L</div>
        <div class="mono" style="font-weight:700;font-size:13px;color:${totalPnL>=0?'var(--up)':'var(--down)'}">${totalPnL>=0?'+':''}${fmtC(totalPnL)}</div>
      </div>
      <div style="text-align:center;padding:10px;background:var(--card);border-radius:8px">
        <div style="font-size:10px;color:var(--faint);margin-bottom:4px">Realised P&L</div>
        <div class="mono" style="font-weight:700;font-size:13px;color:${realisedPnL>=0?'var(--up)':'var(--down)'}">${realisedPnL>=0?'+':''}${fmtC(realisedPnL)}</div>
      </div>
      <div style="text-align:center;padding:10px;background:var(--card);border-radius:8px">
        <div style="font-size:10px;color:var(--faint);margin-bottom:4px">Total Trades</div>
        <div class="mono" style="font-weight:700;font-size:13px">${orders.length}</div>
      </div>
      <div style="text-align:center;padding:10px;background:var(--card);border-radius:8px">
        <div style="font-size:10px;color:var(--faint);margin-bottom:4px">Win Rate</div>
        <div class="mono" style="font-weight:700;font-size:13px;color:var(--up)">${closed.length>0?((wins/closed.length)*100).toFixed(0):0}%</div>
      </div>
    </div>`;
  document.getElementById('profile-overlay').style.display='flex';
}
function closeProfile(){
  document.getElementById('profile-overlay').style.display='none';
}

// ============================================================
// AUTH (old stubs replaced)
// ============================================================
let authMode="login";
function switchAuthTab(mode,btn){ authMode=mode; }

// ============================================================
// REALISTIC BASE PRICES (Feb 2025 approximate NSE closing prices)
// ============================================================
const BASE_PRICES = {
  // Nifty 50
  "RELIANCE":1405,"TCS":3158,"HDFCBANK":925,"BHARTIARTL":2018,"ICICIBANK":1370,
  "INFOSYS":1677,"SBIN":1040,"HINDUNILVR":2397,"BAJFINANCE":969,"ITC":330,
  "AXISBANK":1301,"LT":3839,"WIPRO":305,"HCLTECH":1705,"KOTAKBANK":427,
  "MARUTI":16128,"TITAN":4150,"SUNPHARMA":1679,"ASIANPAINT":2380,"ULTRACEMCO":12359,
  "ONGC":243,"NTPC":342,"POWERGRID":295,"COALINDIA":445,"HDFCLIFE":620,
  "BAJAJFINSV":2011,"ADANIPORTS":1400,"TECHM":1640,"TATASTEEL":145,"DRREDDY":1210,
  "CIPLA":1490,"EICHERMOT":4900,"HEROMOTOCO":4650,"SBILIFE":1580,"NESTLEIND":2250,
  "BAJAJ-AUTO":9200,"M&M":3641,"APOLLOHOSP":6900,"JSWSTEEL":920,"HINDALCO":660,
  "GRASIM":2680,"INDUSINDBK":985,"TATACONSUM":1025,"SHRIRAMFIN":670,"BRITANNIA":4850,
  "ADANIENT":2480,"BPCL":305,"DIVISLAB":5450,"TRENT":5800,
  // Nifty Next 50
  "LICI":810,"ADANIGREEN":1050,"ADANIPOWER":555,"AMBUJACEM":565,"NYKAA":185,
  "VEDL":490,"SIEMENS":7200,"HAVELLS":1620,"PIDILITIND":2820,"CHOLAFIN":1285,
  "BANKBARODA":235,"DABUR":540,"BERGEPAINT":565,"GODREJCP":1285,"TORNTPHARM":3450,
  "MARICO":640,"MUTHOOTFIN":1950,"MAXHEALTH":935,"CUMMINSIND":3250,"ICICIPRULI":650,
  "ICICIGI":1850,"INDHOTEL":740,"COLPAL":2820,"MCDOWELL-N":1140,"BOSCHLTD":32000,
  "DMART":3750,"LODHA":1280,"NAUKRI":8200,"LTIM":4850,"PERSISTENT":6200,
  // Midcap
  "RECLTD":485,"PFC":445,"HAL":4250,"BEL":285,"DLF":815,
  "TATAPOWER":405,"TATACHEM":1020,"GAIL":195,"IOC":145,"INDIGO":4150,
  "IRCTC":820,"ZOMATO":215,"DELHIVERY":355,"ANGELONE":2950,"YESBANK":21,
  "IDEA":9.5,"SUZLON":56,"IRFC":195,"NHPC":85,"SJVN":115,
  "CONCOR":855,"SAIL":115,"NMDC":210,"ALKEM":5800,"AUROPHARMA":1100,
  "LUPIN":2150,"BIOCON":315,"ZYDUSLIFE":920,"IPCALAB":1680,"TORNTPOWER":1420,
  "TATACOMM":1850,"MPHASIS":2900,"COFORGE":7500,"KPITTECH":1450,"LTTS":5100,
  "TATAELXSI":6800,"EXIDEIND":450,"BHARATFORG":1250,"MOTHERSON":145,"ASHOKLEY":215,
  "BALKRISIND":2700,"APOLLOTYRE":445,"MRF":135000,"TATAMOTORS":725,"M&MFIN":310,
  "BAJAJHLDNG":9800,"SUNDARMFIN":4200,"PNBHOUSING":1050,"LICIHSGFIN":670,
  "KARURVYSYA":215,"FEDERALBNK":195,"IDFCFIRSTB":75,"PNB":105,"CANBK":105,
  "UNIONBANK":125,"BANDHANBNK":175,"RBLBANK":195,"AUBANK":680,"EQUITASBNK":82,
  "UJJIVANSFB":44,"SWIGGY":465,"PAYTM":840,"POLICYBZR":1850,"CARTRADE":950,
  "KFINTECH":680,"CAMS":3700,"BSE":5100,"MCX":5800,"CDSL":1450,
  "IREDA":195,"HUDCO":240,"RVNL":420,"NBCC":95,"RPOWER":18,
  "CESC":185,"JSWENERGY":580,"EMAMILTD":785,"GODREJIND":940,"GODREJPROP":2680,
  "OBEROIRLTY":1950,"PRESTIGE":1680,"PHOENIXLTD":1650,"SOBHA":1850,"BRIGADE":1100,
  "SUNTV":620,"ZEEL":125,"PVRINOX":1350,"PAGEIND":47000,"VBL":680,
  "RADICO":1450,"UBL":1650,"DEVYANI":185,"JUBLFOOD":650,"WESTLIFE":720,
  // Healthcare
  "LALPATHLAB":2450,"METROPOLIS":1850,"FORTIS":685,"KRSNAA":480,
  // Pharma
  "GLENMARK":1350,"NATCOPHARM":1250,"GRANULES":485,"LAURUSLABS":540,
  "SANOFI":9500,"ABBOTINDIA":27500,"PFIZER":5600,"GLAXO":2400,"ERIS":1150,
  "AJANTPHARM":2850,"WINDLAS":950,
  // Chemical
  "FINEORG":5200,"NAVINFLUOR":3200,"DEEPAKNTR":2450,"GALAXYSURF":2900,
  "ALKYLAMINE":1950,"ATUL":7800,"BALAMINES":2200,"SUDARSCHEM":920,"CHEMPLASTS":650,
  "AETHER":950,"CLEAN":1550,"FLUOROCHEM":3100,"IGPL":680,"NOCIL":285,
  // Capital Goods / Industrials
  "POLYCAB":5800,"KEI":4200,"ABB":8100,"GRINDWELL":2200,"THERMAX":4800,
  "BHEL":250,"TIINDIA":3700,"TIMKEN":3800,"SKFINDIA":5500,"SIEMENS":7200,
  "AIAENG":3600,"ELGIEQUIP":695,
  // Auto
  "TATAMTRDVR":485,"SCHAEFFLER":4200,"MINDA":965,"SUPRAJIT":285,"GABRIELBDA":165,
  "GABRIEL":165,"OLECTRA":1450,"TVSMOTOR":2250,"ESCORTS":3400,
  "BALKRISIND":2700,"MINDAIND":965,
  // Telecom
  "TATACOMM":1850,"HFCL":95,"DISHTV":12,"STLTECH":185,
  // Logistics
  "AEGISCHEM":760,"BLUEDART":7800,"GESHIP":1050,"SCI":255,"CONCOR":855,
  "MAHLOG":520,"TCI":525,
  // Defence
  "COCHINSHIP":1550,"MAZAGON":2500,"MAZDOCK":2500,"MIDHANI":380,"DATAPATTNS":2200,
  "IDEAFORGE":595,"MTAR":2050,"MTARTECH":2050,"BEML":4200,"DYNAMATECH":2450,
  // Real Estate
  "NESCO":985,"OBEROIRLTY":1950,"BRIGADE":1100,
  // Building Materials
  "ASTRAL":1800,"SUPREMEIND":4200,"PRINCEPIPE":685,"KAJARIACER":1250,
  "CERA":7400,"GREENPANEL":375,"CENTURYPLY":680,"GREENPLY":265,
  // Finance/AMC
  "CRISIL":4900,"ICRA":5800,"BSE":5100,"MCX":5800,"CDSL":1450,
  "NUVAMA":3850,"360ONE":825,"UTIAMC":1150,"ABSLAMC":520,"HDFCAMC":4100,
  "NIPPONLIFE":680,"MOTILALOFS":685,"JMFINANCIL":95,"IIFL":495,
  "MANAPPURAM":185,"CREDITACC":1350,"MUTHOOTFIN":1950,"ANGELONE":2950,
  "AAVAS":1650,"HOMEFIRST":985,"APTUS":320,"ARMAN":1500,
  // IT
  "MPHASIS":2900,"COFORGE":7500,"KPITTECH":1450,"LTTS":5100,"TATAELXSI":6800,
  "CYIENT":1850,"ZENSAR":680,"NIIT":145,"MASTEK":2950,"RATEGAIN":650,
  "JUSTDIAL":985,"INDIAMART":2850,"MAPMYINDIA":1650,"NAZARA":885,
  "TANLA":980,"ROUTE":1650,"INTELLECT":850,"HEXAWARE":750,
  // Metal/Mining
  "NATIONALUM":185,"WELCORP":680,"GRAPHITE":580,"HINDCOPPER":285,
  "MOIL":400,"GPIL":850,"RATNAMANI":2950,"JINDALSAW":780,"JTLIND":185,
  "LSIL":85,"KIOCL":280,
  // Agriculture
  "PIIND":3650,"DHANUKA":1350,"COROMANDEL":1250,"UPL":485,
  "SHARDACROP":750,"BALRAMCHIN":395,"TRIVENI":385,"EIDPARRY":540,
  // Textile
  "RAYMOND":2150,"WELSPUNLIV":165,"TRIDENT":38,"KPR":820,"VARDHMAN":430,
  // Food & Bev
  "AVANTIFEED":480,"HATSUN":950,"VSTIND":3950,"RENUKA":42,
  // Consumer
  "VOLTAS":1550,"BLUESTAR":1650,"WHIRLPOOL":1750,"DIXON":14500,"AMBER":5800,
  "SYMPHONY":1150,"CROMPTON":285,"VIP":685,"SAFARI":2150,
  "KANSAINER":285,"AKZONOBEL":2550,"RELAXO":685,"BATA":1450,"SHEELA":985,
  "ORIENTELEC":195,"CAMPUS":180,"TTKPRESTIG":7200,"ZYDUSWELL":1450,
  "JYOTHYLAB":435,"HONASA":235,"PGHL":5200,"PAGEIND":47000,"COLPAL":2820,
  // Energy
  "GUJGASLTD":485,"MGL":1050,"IGL":385,"PETRONET":315,"CASTROLIND":195,
  "HINDPETRO":380,"OIL":395,"ATGL":780,"ADANIENSOL":850,"ADANITRANS":850,
  // Hotels
  "INDHOTEL":740,
  // Infrastructure
  "GMRINFRA":95,"GMRAIRPORT":95,"IRB":65,"NCC":215,"HGINFRA":1350,
  "KNRCON":685,"JSWINFRA":265,"RVNL":420,"NBCC":95,"CAPACITE":285,
  "PSP":680,"AHLUWALIA":685,"SUYOG":1850,
  // Media
  "SUNTV":620,"ZEEL":125,"PVRINOX":1350,"NETWORK18":68,"TV18BRDCST":35,
  "EASEMYTRIP":18,"SPICEJET":45,
  // Cement
  "AMBUJACEM":565,"NUVOCO":285,"RAMCOCEM":885,"JKCEMENT":3800,"DALMIACEM":1850,
  "HEIDELBERG":165,"BIRLACORPN":1150,"SHREECEM":24000,
  // Jewellery
  "KALYANKJIL":475,"SENCO":1050,"PCJEWELLER":42,
  // Fintech/Internet
  "POLICYBZR":1850,"CAMS":3700,"KFINTECH":680,"CARTRADE":950,
  // Paper
  "JKPAPER":385,"TNPL":295
};

// ============================================================
// STATE ‚Äî Initialize with base prices immediately
// ============================================================
let stocks = NSE_MASTER.map(s=>{
  const bp = BASE_PRICES[s.symbol] || 100;
  // Add small random variation to base price (¬±0.3%) so chart looks natural
  const vary = bp * (1 + (Math.random()-0.5)*0.006);
  const price = +vary.toFixed(2);
  const prevClose = +(bp * (1 + (Math.random()-0.5)*0.004)).toFixed(2);
  const change = +(price - prevClose).toFixed(2);
  const changePct = +((change/prevClose)*100).toFixed(2);
  const high = +(price * (1 + Math.random()*0.008)).toFixed(2);
  const low  = +(price * (1 - Math.random()*0.008)).toFixed(2);
  const volume = Math.floor(Math.random()*5000000 + 500000);
  // Seed price history with 20 realistic points
  const hist = [];
  let p = prevClose;
  for(let i=0;i<20;i++){
    const v = bp>1000?0.0008:bp>100?0.0015:0.003;
    p = Math.max(0.05, +(p + p*v*(Math.random()-0.49)).toFixed(2));
    hist.push({t: Date.now()-((20-i)*3000), price:p});
  }
  hist.push({t:Date.now(), price});
  return {
    ...s, price, prevClose, change, changePct, high, low, volume,
    priceHistory: hist, lastFetched: null, freshPrice: false
  };
});
let balance=1000000, usedMargin=0, positions=[], orders=[], gttOrders=[], news=[];
let watchlist=["RELIANCE","TCS","HDFCBANK","INFOSYS","SBIN"];
let selectedSector="All", user=null, activeTab="market";
let orderStock=null, orderType="BUY", tradeType="equity", orderQty=1, orderLots=1;
let gttStock=null, gttOrderType="BUY";
let omChart=null, sectorChart=null, pnlChart=null;
const SECTOR_COLORS=["#7c6244","#68817d","#7b241b","#5591b3","#a0744d","#6b8e73","#8b6f47","#4a7c8a","#9b4c4c","#5b7a5b","#7a6aaa","#9c7b4a","#4c7a9c","#8a7a4c"];

// ============================================================
// CHARGES CALCULATOR
// ============================================================
function calcCharges(value,type="equity"){
  const brk=20, stt=type==="futures"?value*0.0001:value*0.001;
  const exch=value*0.0000325, sebi=value*0.000001, stamp=value*0.00015;
  const gst=(brk+exch)*0.18, total=brk+stt+exch+sebi+stamp+gst;
  return{brokerage:brk,stt,exchangeCharge:exch,sebi,stampDuty:stamp,gst,total};
}

// ============================================================
// REAL PRICE FETCHING via Yahoo Finance (via AllOrigins proxy)
// ============================================================
// ============================================================
// REAL NSE PRICE FETCHING
// Source: Yahoo Finance (.NS symbols) via multiple CORS proxies
// Uses chart API (more reliable than quote API)
// ============================================================
let priceFetchInProgress = false;
let fetchedCount = 0;
let API_BASE_URL = ""; // legacy, not used

// ‚îÄ‚îÄ ANGELONE SMARTAPI CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Step 1: Vercel pe apna proxy deploy karo (angel-proxy.js)
// Step 2: Apna deployed URL neeche daalo
// Example: "https://your-project.vercel.app/api/angel-proxy"
const ANGEL_PROXY_URL = "https://YOUR-VERCEL-PROJECT.vercel.app/api/angel-proxy";

// AngelOne Symbol Token mapping ‚Äî NSE Equity segment
// Ye same hain jo NSE instrument tokens hain
const ANGEL_SYMBOL_TOKENS = {
  "RELIANCE":   "2885",
  "TCS":        "11536",
  "HDFCBANK":   "1333",
  "BHARTIARTL": "10604",
  "ICICIBANK":  "4963",
  "INFOSYS":    "1594",
  "SBIN":       "3045",
  "HINDUNILVR": "1394",
  "BAJFINANCE": "317",
  "ITC":        "1660",
  "AXISBANK":   "5900",
  "LT":         "11483",
  "WIPRO":      "3787",
  "HCLTECH":    "7229",
  "KOTAKBANK":  "1922",
  "MARUTI":     "10999",
  "TITAN":      "3506",
  "SUNPHARMA":  "3351",
  "ASIANPAINT": "236",
  "ULTRACEMCO": "11532",
  "ONGC":       "2475",
  "NTPC":       "11630",
  "POWERGRID":  "14977",
  "COALINDIA":  "20374",
  "HDFCLIFE":   "119",
  "BAJAJFINSV": "16675",
  "ADANIPORTS": "15083",
  "TECHM":      "13538",
  "TATASTEEL":  "3499",
  "DRREDDY":    "881",
  "CIPLA":      "694",
  "EICHERMOT":  "910",
  "HEROMOTOCO": "1348",
  "SBILIFE":    "21808",
  "NESTLEIND":  "17963",
  "BAJAJ-AUTO": "16669",
  "M&M":        "2031",
  "APOLLOHOSP": "157",
  "JSWSTEEL":   "11723",
  "HINDALCO":   "1363",
  "GRASIM":     "1232",
  "INDUSINDBK": "5258",
  "TATACONSUM": "3432",
  "SHRIRAMFIN": "11543",
  "BRITANNIA":  "547",
  "ADANIENT":   "25",
  "BPCL":       "526",
  "DIVISLAB":   "10243",
  "TRENT":      "3507",
  "LICI":       "543733",
  "NYKAA":      "13751",
  "VEDL":       "3063",
  "SIEMENS":    "3150",
  "HAVELLS":    "430",
  "PIDILITIND": "2664",
  "BANKBARODA": "1152",
  "DABUR":      "772",
  "GODREJCP":   "10099",
  "MARICO":     "438",
  "COLPAL":     "1623",
  "DMART":      "11522",
  "NAUKRI":     "13751",
  "LTIM":       "17818",
  "RECLTD":     "21614",
  "PFC":        "14299",
  "HAL":        "541154",
  "BEL":        "383",
  "DLF":        "14732",
  "TATAPOWER":  "3426",
  "GAIL":       "1033",
  "IOC":        "1624",
  "INDIGO":     "11195",
  "IRCTC":      "542830",
  "ZOMATO":     "543320",
  "YESBANK":    "11915",
  "SUZLON":     "12168",
  "IRFC":       "543257",
  "TATAMOTORS": "3456",
  "PNB":        "2730",
  "CANBK":      "9598",
  "IDFCFIRSTB": "11957",
  "BANDHANBNK": "541153",
  "PAYTM":      "543396",
  "SWIGGY":     "544229",
};

// ‚îÄ‚îÄ LIVE PRICE FETCH ‚Äî Yahoo Finance (Primary) + AngelOne (Backup) ‚îÄ
const CORS_PROXIES = [
  "https://corsproxy.io/?",
  "https://api.allorigins.win/raw?url=",
  "https://proxy.cors.sh/",
];

async function fetchWithProxy(url){
  for(const proxy of CORS_PROXIES){
    try{
      const r = await fetch(proxy + encodeURIComponent(url), { signal: AbortSignal.timeout(8000) });
      if(r.ok){ const t = await r.text(); if(t && t.length > 10) return t; }
    } catch(e){ continue; }
  }
  return null;
}

async function fetchAllPrices(){
  if(priceFetchInProgress) return;
  priceFetchInProgress = true;
  fetchedCount = 0;

  const statusEl = document.getElementById("price-status");
  statusEl.innerHTML = `<span class="spin">‚ü≥</span> Live prices fetch ho rahi hain...`;

  const banner = document.getElementById("cors-banner");
  if(banner) banner.style.display = "none";

  try{
    // Yahoo Finance spark API ‚Äî batch fetch
    const CHUNK = 20;
    const allSyms = stocks.map(s => (s.yf || s.symbol + ".NS"));

    for(let i = 0; i < allSyms.length; i += CHUNK){
      const chunk = allSyms.slice(i, i + CHUNK);
      const chunkStocks = stocks.slice(i, i + CHUNK);
      const symsStr = chunk.join(",");

      const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(symsStr)}&fields=regularMarketPrice,regularMarketPreviousClose,regularMarketChange,regularMarketChangePercent,regularMarketDayHigh,regularMarketDayLow,regularMarketVolume`;

      const text = await fetchWithProxy(url);
      if(!text) continue;

      let data;
      try{ data = JSON.parse(text); } catch(e){ continue; }

      const results = data?.quoteResponse?.result || [];
      results.forEach(q => {
        const yfsym = q.symbol;
        const stock = stocks.find(s => (s.yf || s.symbol+".NS") === yfsym);
        if(!stock) return;

        const lp = +(q.regularMarketPrice || 0);
        if(lp <= 0) return;
        const pc = +(q.regularMarketPreviousClose || lp);

        stock.price     = +lp.toFixed(2);
        stock.prevClose = +pc.toFixed(2);
        stock.change    = +(q.regularMarketChange || lp - pc).toFixed(2);
        stock.changePct = +(q.regularMarketChangePercent || 0).toFixed(2);
        stock.high      = +(q.regularMarketDayHigh || lp).toFixed(2);
        stock.low       = +(q.regularMarketDayLow  || lp).toFixed(2);
        stock.volume    = q.regularMarketVolume || 0;
        stock.lastFetched = new Date();
        stock.freshPrice  = true;
        stock.priceHistory = [...stock.priceHistory, {t: Date.now(), price: stock.price}].slice(-60);
        fetchedCount++;
      });

      if(i + CHUNK < allSyms.length) await new Promise(r => setTimeout(r, 150));
    }

    const t = new Date().toLocaleTimeString("en-IN", {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    if(fetchedCount > 0){
      const mktOpen = isMarketOpen();
      statusEl.innerHTML = mktOpen
        ? `‚úÖ <b>${fetchedCount}/${stocks.length}</b> live @ ${t}`
        : `üìä <b>${fetchedCount}/${stocks.length}</b> last close @ ${t}`;
      try{ document.getElementById("s-updated").textContent = t; }catch(e){}
    } else {
      // Yahoo se nahi aaya ‚Äî AngelOne se try karo
      statusEl.innerHTML = `‚è≥ AngelOne se prices la raha hoon...`;
      const missingSyms = stocks.filter(s => !s.freshPrice).map(s => s.symbol);
      const angelCount = await fetchPricesFromAngel(missingSyms);
      if(angelCount > 0){
        fetchedCount += angelCount;
        statusEl.innerHTML = isMarketOpen()
          ? `‚úÖ <b>${fetchedCount}/${stocks.length}</b> AngelOne live @ ${t}`
          : `üìä <b>${fetchedCount}/${stocks.length}</b> AngelOne close @ ${t}`;
      } else {
        statusEl.innerHTML = isMarketOpen()
          ? `‚ö†Ô∏è Prices nahi aayi ‚Äî Refresh karo`
          : `üî¥ Market Closed ‚Äî Last closing prices`;
      }
    }
  } catch(err){
    console.error("fetchAllPrices error:", err);
    statusEl.innerHTML = `‚ö†Ô∏è Error ‚Äî ${err.message}`;
  }

  priceFetchInProgress = false;
  renderAll();
  checkGttTriggers();
}

// ‚îÄ‚îÄ ANGELONE PRICE FETCH (Backup jab Yahoo kaam na kare) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchPricesFromAngel(symbolsList){
  if(!symbolsList || symbolsList.length === 0) return 0;
  // Agar proxy URL set nahi hai toh skip karo
  if(ANGEL_PROXY_URL.includes("YOUR-VERCEL-PROJECT")) return 0;
  let count = 0;
  try {
    // AngelOne ek baar mein max 50 tokens leta hai
    const CHUNK = 50;
    for(let i = 0; i < symbolsList.length; i += CHUNK){
      const chunk = symbolsList.slice(i, i + CHUNK);
      // Sirf wahi symbols bhejo jinke tokens hain
      const tokens = chunk
        .filter(s => ANGEL_SYMBOL_TOKENS[s])
        .map(s => ANGEL_SYMBOL_TOKENS[s]);
      if(tokens.length === 0) continue;
      const url = `${ANGEL_PROXY_URL}?tokens=${tokens.join(",")}`;
      try {
        const r = await fetch(url, { signal: AbortSignal.timeout(10000) });
        if(!r.ok) continue;
        const data = await r.json();
        const fetched = data?.data?.fetched || [];
        fetched.forEach(q => {
          // symbolToken se match karo
          const sym = Object.keys(ANGEL_SYMBOL_TOKENS).find(k => ANGEL_SYMBOL_TOKENS[k] === String(q.symbolToken));
          const stock = stocks.find(s => s.symbol === sym);
          if(!stock || !q.ltp || q.ltp <= 0) return;
          const lp = +q.ltp, pc = +(q.close || lp);
          stock.price      = +lp.toFixed(2);
          stock.prevClose  = +pc.toFixed(2);
          stock.change     = +(lp - pc).toFixed(2);
          stock.changePct  = +(((lp - pc) / pc) * 100).toFixed(2);
          stock.high       = +(q.high || lp).toFixed(2);
          stock.low        = +(q.low  || lp).toFixed(2);
          stock.volume     = q.tradeVolume || 0;
          stock.lastFetched = new Date();
          stock.freshPrice  = true;
          stock.priceHistory = [...stock.priceHistory, {t: Date.now(), price: stock.price}].slice(-60);
          count++;
        });
      } catch(e){ console.warn('AngelOne chunk error:', e.message); }
      if(i + CHUNK < symbolsList.length) await new Promise(r => setTimeout(r, 200));
    }
  } catch(e){ console.warn('AngelOne fetch error:', e.message); }
  return count;
}

// Legacy stub
function fetchOnePrice(stock){ return Promise.resolve(false); }

// Simulate live-like price movements ‚Äî ONLY when market is open
function simulateMissing(){
  // Market band hai toh prices bilkul nahi hilengi
  if(!isMarketOpen()) return;

  let changed=false;
  stocks.forEach(st=>{
    if(st.freshPrice) return; // real price already hai, skip
    if(st.price<=0) return;
    const v = st.price>5000?0.0004 : st.price>1000?0.0007 : st.price>100?0.0012 : st.price>10?0.002 : 0.004;
    const delta = st.price * v * (Math.random()-0.49);
    st.price = Math.max(0.05, +(st.price+delta).toFixed(2));
    if(st.prevClose<=0) st.prevClose = st.price;
    st.change = +(st.price - st.prevClose).toFixed(2);
    st.changePct = +((st.change/st.prevClose)*100).toFixed(2);
    st.high = Math.max(st.high||st.price, st.price);
    st.low  = st.low>0 ? Math.min(st.low, st.price) : st.price;
    st.priceHistory = [...st.priceHistory,{t:Date.now(),price:st.price}].slice(-60);
    changed=true;
  });
  if(changed) renderAll();
}

// ============================================================
// MARKET OPEN CHECK (NSE: Mon-Fri 9:15-15:30 IST)
// ============================================================
function isMarketOpen(){
  const now=new Date();
  const istOffset=5.5*60*60*1000;
  const ist=new Date(now.getTime()+istOffset-(now.getTimezoneOffset()*60*1000));
  const day=ist.getDay();
  if(day===0||day===6)return false;
  const mins=ist.getHours()*60+ist.getMinutes();
  return mins>=555&&mins<930;
}
function updateMarketStatus(){
  const open=isMarketOpen();
  const dot=document.getElementById("mkt-dot"),txt=document.getElementById("mkt-text");
  const badge=document.getElementById("mkt-status"),foot=document.getElementById("sidebar-foot");
  dot.style.background=open?"#7c6244":"#ff5c7a";
  dot.style.animation=open?"pulse 1s infinite":"none";
  txt.style.color=open?"#7c6244":"#ff5c7a";
  txt.textContent=open?"NSE LIVE":"MARKET CLOSED";
  badge.style.background=open?"rgba(0,200,150,0.08)":"rgba(255,92,122,0.08)";
  badge.style.border=`1px solid ${open?"rgba(0,200,150,0.2)":"rgba(255,92,122,0.2)"}`;
  if(foot)foot.innerHTML=open?`<span style="color:var(--accent)">‚ö° Live ‚Ä¢ auto-refresh 1s</span>`:`<span style="color:#ff5c7a">üî¥ Market Closed</span>`;
  document.getElementById("mkt-refresh-info").textContent=open?"‚ö° ‚ö° Live NSE prices ‚Äî AngelOne":"üî¥ Market Closed";
}

// ============================================================
// FORMAT HELPERS
// ============================================================
function fmt(n){
  if(n===undefined||n===null||isNaN(n))return"‚Äî";
  return n.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2});
}
function fmtC(n){
  if(!n&&n!==0)return"‚Äî";
  const abs=Math.abs(n);
  if(abs>=10000000)return`‚Çπ${(n/10000000).toFixed(2)}Cr`;
  if(abs>=100000)return`‚Çπ${(n/100000).toFixed(2)}L`;
  return`‚Çπ${fmt(n)}`;
}
function getPrice(sym){return (function(){var s=stocks.find(function(s){return s.symbol===sym});return s?s.price:0;})()}

// (auth functions moved to top of script ‚Äî multi-user system)

function launchApp(){
  document.getElementById("auth-screen").style.display="none";
  document.getElementById("app").style.display="block";
  document.getElementById("user-avatar").textContent=user.avatar;
  initApp();
}

// ============================================================
// INIT APP
// ============================================================
function updateTodayEarningsStrip(){
  const now = new Date(); now.setHours(0,0,0,0);
  if(!earningsData || earningsData.length===0) return;
  const todayResults = earningsData.filter(e => {
    const d = e.dateObj || new Date(e.date);
    const dn = new Date(d); dn.setHours(0,0,0,0);
    return dn.getTime() === now.getTime();
  });
  const strip = document.getElementById('today-earnings-strip');
  const list  = document.getElementById('today-earnings-list');
  if(!strip || !list) return;
  if(todayResults.length > 0){
    strip.style.display = 'flex';
    list.innerHTML = todayResults.map(e =>
      `<span onclick="openOrderModal('${e.symbol}','BUY')" style="cursor:pointer;background:rgba(124,98,68,.15);padding:2px 8px;border-radius:12px;font-weight:600;color:var(--accent)">${e.symbol}</span>`
    ).join(' ');
  } else {
    strip.style.display = 'none';
  }
}

function initApp(){
  buildSectorFilter();
  buildAuthTicker();
  updateMarketStatus();
  renderAll();
  fetchRealNews();
  fetchEarningsCalendar();

  // Market open hai toh prices fetch karo, warna frozen status dikhao
  if(isMarketOpen()){
    fetchAllPrices();
  } else {
    document.getElementById("price-status").textContent="üî¥ Market Closed ‚Äî Prices frozen at last close";
  }

  // Real price refresh every 30 seconds (fetchAllPrices khud check kar lega market status)
  setInterval(()=>{ updateMarketStatus(); if(isMarketOpen()) fetchAllPrices(); }, 15000); // 15s live refresh
  // Simulation EVERY 1 SECOND ‚Äî live feel ke liye
  setInterval(()=>{ simulateMissing(); if(isMarketOpen()) renderWatchlistPricesOnly(); }, 1000);
  // GTT check every 5 seconds
  setInterval(checkGttTriggers, 5000);
  // News every 8s
  setInterval(()=>{ if(activeTab==='news') generateNews(); }, 30000); // 30s simulated fallback
  setInterval(fetchRealNews, 300000); // Real news every 5 min
  // AUTO SAVE every 10 seconds
  setInterval(saveState, 10000);
}
function buildAuthTicker(){
  const el=document.getElementById("auth-ticker");
  const items=NSE_MASTER.slice(0,15).map(s=>`<span style="margin-right:24px"><span style="color:var(--accent)">${s.symbol}</span> ‚Çπ‚Äî</span>`).join("");
  el.innerHTML=items+items;
}
function buildSectorFilter(){
  const sectors=["All",...new Set(NSE_MASTER.map(s=>s.sector))];
  const el=document.getElementById("sector-filter");
  el.innerHTML=sectors.map(s=>`<button class="tag-btn${s===selectedSector?" active":""}" onclick="setSector('${s}',this)">${s}</button>`).join("");
}
function setSector(sec,btn){
  selectedSector=sec;
  document.querySelectorAll("#sector-filter .tag-btn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  renderMarket();
}

// ============================================================
// RENDER ALL
// ============================================================
function renderAll(){
  updateSummaryBar();
  if(activeTab==="market")renderMarket();
  if(activeTab==="positions")renderPositions();
  if(activeTab==="orders")renderOrders();
  if(activeTab==="gtt")renderGtt();
  if(activeTab==="analytics")renderAnalytics();
  renderWatchlist();
  updateNavCounts();
}
function renderWatchlistPricesOnly(){
  // Lightweight update ‚Äî only update prices in sidebar
  if(activeTab==="positions")renderPositions();
  updateSummaryBar();
}

// ============================================================
// SUMMARY BAR
// ============================================================
function updateSummaryBar(){
  const portVal=positions.reduce((a,p)=>a+(getPrice(p.symbol)*p.qty),0);
  const nw=balance+portVal;
  const totalPnL=positions.reduce((a,p)=>{
    const cp=getPrice(p.symbol);
    return a+(p.type==="BUY"?(cp-p.avgPrice):(p.avgPrice-cp))*p.qty;
  },0);
  document.getElementById("s-networth").textContent=fmtC(nw);
  document.getElementById("s-balance").textContent=fmtC(balance);
  document.getElementById("s-portval").textContent=fmtC(portVal);
  const pnlEl=document.getElementById("s-pnl");
  pnlEl.textContent=(totalPnL>=0?"+":"")+fmtC(totalPnL);
  pnlEl.style.color=totalPnL>=0?"var(--up)":"var(--down)";
  document.getElementById("s-positions").textContent=positions.length;
  document.getElementById("s-gtt").textContent=gttOrders.filter(g=>g.status==="ACTIVE").length;
  document.getElementById("nav-balance").textContent=fmtC(balance);
}
function updateNavCounts(){
  document.getElementById("nav-pos-cnt").textContent=`(${positions.length})`;
  document.getElementById("nav-ord-cnt").textContent=`(${orders.length})`;
  document.getElementById("nav-gtt-cnt").textContent=`(${gttOrders.filter(g=>g.status==="ACTIVE").length})`;
}

// ============================================================
// MARKET TABLE
// ============================================================
const _prevPrices={};
function renderMarket(){
  const q=document.getElementById("mkt-search").value.toLowerCase();
  const filtered=stocks.filter(s=>{
    const sm=selectedSector==="All"||s.sector===selectedSector;
    const sq=!q||s.symbol.toLowerCase().includes(q)||s.name.toLowerCase().includes(q);
    return sm&&sq;
  });
  document.getElementById("mkt-count").textContent=`Showing ${filtered.length} of ${stocks.length} stocks`;
  const tbody=document.getElementById("market-table");
  tbody.innerHTML=filtered.map(s=>{
    const isUp=s.changePct>=0;
    const cl=isUp?"up":"down";
    const wlIn=watchlist.includes(s.symbol);
    const noPrice=s.price===0;
    // Detect price flash direction
    const prevP=_prevPrices[s.symbol];
    const flashCls=prevP!=null?(s.price>prevP?" flash-up":s.price<prevP?" flash-down":""):"";
    _prevPrices[s.symbol]=s.price;
    return`<div class="stock-row${flashCls}" style="grid-template-columns:2fr 1.3fr 1fr .9fr .9fr .5fr .9fr" onclick="openOrderModal('${s.symbol}','BUY')">
      <div>
        <div style="font-weight:700;font-size:12.5px;letter-spacing:-0.01em">${s.symbol} ${s.freshPrice?'<span class="price-fresh">‚óè LIVE</span>':'<span class="price-stale">‚óå</span>'}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:1px">${s.name.substring(0,24)} <span style="color:rgba(62,122,170,.8);font-weight:500">‚Ä¢ ${s.sector}</span></div>
      </div>
      <div class="mono" style="font-weight:700;font-size:13.5px">${noPrice?"‚Çπ‚Äî":"‚Çπ"+s.price.toFixed(2)}</div>
      <div>
        <div class="mono ${cl}" style="font-size:12px;font-weight:700">${isUp?"‚ñ≤":"‚ñº"} ${Math.abs(s.changePct).toFixed(2)}%</div>
        <div class="${cl}" style="font-size:10px;opacity:.8">${s.change>=0?"+":""}${s.change.toFixed(2)}</div>
      </div>
      <div class="mono up" style="font-size:11px">‚Çπ${s.high>0?s.high.toFixed(2):"‚Äî"}</div>
      <div class="mono down" style="font-size:11px">‚Çπ${s.low>0?s.low.toFixed(2):"‚Äî"}</div>
      <div onclick="event.stopPropagation();toggleWL('${s.symbol}')" style="cursor:pointer;font-size:15px;text-align:center;transition:transform .15s" onmouseover="this.style.transform='scale(1.3)'" onmouseout="this.style.transform='scale(1)'">${wlIn?"‚≠ê":"‚òÜ"}</div>
      <div style="display:flex;gap:4px" onclick="event.stopPropagation()">
        <button class="btn-buy" style="padding:4px 10px;font-size:11px" onclick="openOrderModal('${s.symbol}','BUY')">B</button>
        <button class="btn-sell" style="padding:4px 9px;font-size:11px" onclick="openOrderModal('${s.symbol}','SELL')">S</button>
        <button class="btn-gtt" onclick="openGttModal('${s.symbol}')">GTT</button>
      </div>
    </div>`;
  }).join("")||`<div class="empty-state"><div class="empty-icon">üîç</div><p>No stocks found</p><small>Try a different search or sector filter</small></div>`;
}

// ============================================================
// WATCHLIST SIDEBAR
// ============================================================
function renderWatchlist(){
  const q=document.getElementById("wl-search").value.toLowerCase();
  const wlStocks=stocks.filter(s=>watchlist.includes(s.symbol)&&(!q||s.symbol.toLowerCase().includes(q)||s.name.toLowerCase().includes(q)));
  document.getElementById("wl-count").textContent=`(${watchlist.length})`;
  const sidebar=document.getElementById("sidebar-wl");
  if(wlStocks.length===0){
    sidebar.innerHTML=`<div style="text-align:center;padding:40px 16px;color:var(--muted)"><div style="font-size:28px;margin-bottom:8px">‚≠ê</div><p style="font-size:12px">No stocks in watchlist</p><p style="font-size:10px;color:var(--faint);margin-top:4px">Click ‚òÜ in Market tab</p></div>`;
    return;
  }
  sidebar.innerHTML=wlStocks.map(s=>{
    const isUp=s.changePct>=0;
    const barColor=isUp?"var(--up)":"var(--down)";
    return`<div class="wl-item" id="wl-${s.symbol}">
      <div class="wl-bar" style="background:${barColor}"></div>
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div style="font-weight:700;font-size:12px;margin-left:6px">${s.symbol}</div>
          <div style="font-size:9px;color:var(--faint);margin-left:6px">${s.sector}</div>
        </div>
        <div style="text-align:right">
          <div class="mono" style="font-weight:700;font-size:12px">‚Çπ${s.price>0?s.price.toFixed(2):"‚Äî"}</div>
          <div class="mono" style="font-size:10px;color:${barColor}">${isUp?"‚ñ≤":"‚ñº"} ${Math.abs(s.changePct).toFixed(2)}%</div>
        </div>
      </div>
      <canvas class="wl-canvas" id="wl-canvas-${s.symbol}"></canvas>
      <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--faint);margin-bottom:6px;margin-left:6px">
        <span class="mono ${isUp?"up":"down"}">${s.change>=0?"+":""}${s.change.toFixed(2)}</span>
        <span>Vol: ${(s.volume/100000).toFixed(1)}L</span>
      </div>
      <div style="display:flex;gap:3px">
        <button class="btn-buy" style="flex:1;padding:4px;font-size:10px" onclick="openOrderModal('${s.symbol}','BUY')">Buy</button>
        <button class="btn-sell" style="flex:1;padding:4px;font-size:10px" onclick="openOrderModal('${s.symbol}','SELL')">Sell</button>
        <button class="btn-gtt" style="padding:4px 6px;font-size:10px" onclick="openGttModal('${s.symbol}')">GTT</button>
        <button onclick="toggleWL('${s.symbol}')" style="background:rgba(255,92,122,0.1);border:none;color:var(--down);cursor:pointer;border-radius:6px;padding:4px 6px;font-size:11px">‚úï</button>
      </div>
    </div>`;
  }).join("");
  // Draw sparklines after DOM update
  requestAnimationFrame(()=>wlStocks.forEach(s=>drawSparkline(`wl-canvas-${s.symbol}`,s.priceHistory,s.changePct>=0)));
}

const sparklineCharts={};
function drawSparkline(canvasId,history,isUp){
  const canvas=document.getElementById(canvasId);
  if(!canvas)return;
  if(sparklineCharts[canvasId])sparklineCharts[canvasId].destroy();
  const data=history.slice(-25).map(h=>h.price);
  if(data.length<2)return;
  const color=isUp?"rgba(45,106,79,1)":"rgba(192,57,43,1)";
  const fillColor=isUp?"rgba(45,106,79,0.12)":"rgba(192,57,43,0.08)";
  try{
    sparklineCharts[canvasId]=new Chart(canvas,{
      type:"line",
      data:{labels:data.map((_,i)=>i),datasets:[{data,borderColor:color,backgroundColor:fillColor,borderWidth:1.5,fill:true,tension:.4,pointRadius:0}]},
      options:{responsive:false,animation:false,plugins:{legend:{display:false},tooltip:{enabled:false}},scales:{x:{display:false},y:{display:false}}}
    });
  }catch(e){}
}

function toggleWL(sym){
  if(watchlist.includes(sym))watchlist=watchlist.filter(s=>s!==sym);
  else watchlist=[...watchlist,sym];
  saveState();
  renderMarket(); renderWatchlist();
}

// ============================================================
// POSITIONS
// ============================================================
function renderPositions(){
  const tab=document.getElementById("tab-positions");
  if(!tab||tab.style.display==="none")return;
  const totalPnL=positions.reduce((a,p)=>{const cp=getPrice(p.symbol);return a+(p.type==="BUY"?(cp-p.avgPrice):(p.avgPrice-cp))*p.qty},0);
  const pnlEl=document.getElementById("pos-total-pnl");
  pnlEl.textContent=`Total P&L: ${totalPnL>=0?"+":""}‚Çπ${fmt(totalPnL)}`;
  pnlEl.style.color=totalPnL>=0?"var(--up)":"var(--down)";
  const tbody=document.getElementById("positions-table");
  if(positions.length===0){
    tbody.innerHTML=`<div class="empty-state"><div class="empty-icon">üìÇ</div><p>No open positions</p><small>Place your first trade from the Market tab</small><br><button class="btn-buy" style="margin-top:14px;padding:9px 24px" onclick="switchTab('market',document.querySelector('.nav-btn'))">Start Trading ‚Üí</button></div>`;
    return;
  }
  tbody.innerHTML=positions.map(pos=>{
    const cp=getPrice(pos.symbol);
    const pnl=pos.type==="BUY"?(cp-pos.avgPrice)*pos.qty:(pos.avgPrice-cp)*pos.qty;
    const pnlPct=(pnl/(pos.avgPrice*pos.qty))*100;
    const invested=pos.avgPrice*pos.qty;
    return`<div class="pos-grid">
      <div><div style="font-weight:600;font-size:12px">${pos.symbol}</div><div style="font-size:9px;color:var(--muted)">${pos.tradeType.toUpperCase()}</div></div>
      <span class="badge ${pos.type==="BUY"?"badge-buy":"badge-sell"}">${pos.type}</span>
      <span class="mono">${pos.qty.toLocaleString()}</span>
      <span class="mono">‚Çπ${pos.avgPrice.toFixed(2)}</span>
      <span class="mono ${cp>=pos.avgPrice?"up":"down"}" style="font-weight:600">‚Çπ${cp.toFixed(2)}</span>
      <span class="mono" style="font-size:10px;color:var(--muted)">‚Çπ${fmt(invested)}</span>
      <div>
        <div class="mono ${pnl>=0?"up":"down"}" style="font-weight:600;font-size:11px">${pnl>=0?"+":""}‚Çπ${fmt(pnl)}</div>
        <div class="${pnlPct>=0?"up":"down"}" style="font-size:9px">${pnlPct>=0?"+":""}${pnlPct.toFixed(2)}%</div>
      </div>
      <button class="btn-sell" style="padding:4px 10px;font-size:11px" onclick="closePosition(${pos.id})">Close</button>
    </div>`;
  }).join("");
}
function closePosition(id){
  const pos=positions.find(p=>p.id===id);
  if(!pos)return;
  const cp=getPrice(pos.symbol);
  const tv=cp*pos.qty;
  const ch=calcCharges(tv,pos.tradeType);
  const pnl=pos.type==="BUY"?(cp-pos.avgPrice)*pos.qty:(pos.avgPrice-cp)*pos.qty;
  orders=[{id:Date.now(),symbol:pos.symbol,name:pos.name,type:pos.type==="BUY"?"SELL":"BUY",tradeType:pos.tradeType,qty:pos.qty,price:cp,value:tv,charges:ch.total,pnl,time:new Date().toLocaleTimeString(),date:new Date().toLocaleDateString(),status:"EXECUTED"},...orders];
  balance+=tv-ch.total;
  usedMargin=Math.max(0,usedMargin-(pos.avgPrice*pos.qty));
  positions=positions.filter(p=>p.id!==id);
  showNotif(`Position closed: ${pos.symbol} | P&L: ‚Çπ${pnl.toFixed(2)}`,pnl>=0?"success":"error");
  saveState();
  renderAll();
}

// ============================================================
// ORDERS
// ============================================================
function renderOrders(){
  const closed=orders.filter(o=>o.pnl!==undefined);
  const rPnL=closed.reduce((a,o)=>a+o.pnl,0);
  const wins=closed.filter(o=>o.pnl>0).length;
  const sm=document.getElementById("orders-summary");
  if(closed.length>0){
    sm.innerHTML=`<div style="text-align:center"><div style="font-size:9px;color:var(--faint)">Realised P&L</div><div class="mono ${rPnL>=0?"up":"down"}" style="font-weight:700;font-size:13px">${rPnL>=0?"+":""}‚Çπ${fmt(rPnL)}</div></div>
    <div style="text-align:center"><div style="font-size:9px;color:var(--faint)">Win Rate</div><div class="mono up" style="font-weight:700;font-size:13px">${((wins/closed.length)*100).toFixed(0)}%</div></div>`;
  } else sm.innerHTML="";
  const tbody=document.getElementById("orders-table");
  if(orders.length===0){tbody.innerHTML=`<div style="text-align:center;padding:50px;color:var(--muted)"><div style="font-size:36px;margin-bottom:10px">üìã</div><p>No orders yet</p></div>`;return}
  tbody.innerHTML=orders.map(o=>`<div class="ord-grid">
    <div><div style="font-weight:600;font-size:11px">${o.symbol}</div><div style="font-size:9px;color:var(--faint)">${o.date}</div></div>
    <span class="badge ${o.type==="BUY"?"badge-buy":"badge-sell"}" style="font-size:9px">${o.type}</span>
    <span style="color:var(--muted);font-size:10px">${(o.tradeType ? o.tradeType.toUpperCase().slice(0,3) : '')}</span>
    <span class="mono" style="font-size:10px">${(o.qty != null ? o.qty.toLocaleString() : '')}</span>
    <span class="mono" style="font-size:10px">‚Çπ${(o.price != null ? o.price.toFixed(2) : '0.00')}</span>
    <span class="mono" style="font-size:10px">‚Çπ${fmt(o.value)}</span>
    <span class="mono down" style="font-size:10px">-‚Çπ${fmt(o.charges)}</span>
    <div>${o.pnl!==undefined?`<span class="mono ${o.pnl>=0?"up":"down"}" style="font-weight:600;font-size:10px">${o.pnl>=0?"+":""}‚Çπ${fmt(o.pnl)}</span>`:`<span style="color:var(--faint)">‚Äî</span>`}</div>
    <span style="color:var(--muted);font-size:9px">${o.time}</span>
  </div>`).join("");
}

// ============================================================
// GTT
// ============================================================
function renderGtt(){
  const tbody=document.getElementById("gtt-table");
  if(gttOrders.length===0){tbody.innerHTML=`<div style="text-align:center;padding:50px;color:var(--muted)"><div style="font-size:36px;margin-bottom:10px">üéØ</div><p>No GTT orders yet</p><p style="font-size:11px;margin-top:6px">Click GTT button on any stock</p></div>`;return}
  tbody.innerHTML=gttOrders.map(g=>{
    const cp=getPrice(g.symbol);
    const sc=g.status==="ACTIVE"?"#5591b3":g.status==="TARGET_HIT"?"var(--up)":"var(--down)";
    const sl=g.status==="ACTIVE"?"ACTIVE":g.status==="TARGET_HIT"?"TGT HIT":"SL HIT";
    return`<div class="gtt-grid">
      <div><div style="font-weight:600;font-size:11px">${g.symbol}</div><div style="font-size:9px;color:var(--faint)">LTP: ‚Çπ${cp.toFixed(2)}</div></div>
      <span class="badge ${g.orderType==="BUY"?"badge-buy":"badge-sell"}" style="font-size:9px">${g.orderType}</span>
      <span class="mono" style="font-size:10px">${g.qty}</span>
      <span class="mono" style="font-size:10px">‚Çπ${(g.entryPrice != null ? g.entryPrice.toFixed(2) : '0.00')}</span>
      <div>${g.stopLoss?`<span class="mono down" style="font-size:10px">‚Çπ${(g.currentStopLoss != null ? g.currentStopLoss.toFixed(2) : '0.00')}</span>${g.isTrailing?`<br><span style="font-size:9px;color:#5591b3">Trail ‚Çπ${g.trailingOffset}</span>`:""}`:` <span style="color:var(--faint)">‚Äî</span>`}</div>
      <span class="mono up" style="font-size:10px">${g.target?"‚Çπ"+(g.target != null ? g.target.toFixed(2) : '0.00'):"‚Äî"}</span>
      <span style="font-size:10px;color:${g.isTrailing?"#5591b3":"var(--faint)"}">${g.isTrailing?"¬±‚Çπ"+g.trailingOffset:"‚Äî"}</span>
      <div style="display:flex;gap:4px;align-items:center">
        <span style="font-size:9px;font-weight:600;color:${sc};padding:2px 5px;background:${sc}18;border-radius:4px">${sl}</span>
        ${g.status==="ACTIVE"?`<button onclick="removeGtt(${g.id})" style="background:transparent;border:none;color:var(--down);cursor:pointer;font-size:13px;padding:0 2px">‚úï</button>`:""}
      </div>
    </div>`;
  }).join("");
}
function checkGttTriggers(){
  let changed=false;
  gttOrders=gttOrders.map(gtt=>{
    if(gtt.status!=="ACTIVE")return gtt;
    const cp=getPrice(gtt.symbol);
    if(!cp)return gtt;
    let g={...gtt};
    if(g.isTrailing&&g.orderType==="BUY"){const ns=cp-g.trailingOffset;if(ns>g.currentStopLoss){g.currentStopLoss=ns;changed=true}}
    if(g.isTrailing&&g.orderType==="SELL"){const ns=cp+g.trailingOffset;if(ns<g.currentStopLoss){g.currentStopLoss=ns;changed=true}}
    if(g.stopLoss){const slHit=g.orderType==="BUY"?cp<=g.currentStopLoss:cp>=g.currentStopLoss;if(slHit){showNotif(`üî¥ GTT SL Triggered: ${g.symbol} @ ‚Çπ${cp.toFixed(2)}`,"error");changed=true;return{...g,status:"SL_TRIGGERED",triggeredPrice:cp,triggeredAt:new Date().toLocaleTimeString()}}}
    if(g.target){const tHit=g.orderType==="BUY"?cp>=g.target:cp<=g.target;if(tHit){showNotif(`üü¢ GTT Target Hit: ${g.symbol} @ ‚Çπ${cp.toFixed(2)}`,"success");changed=true;return{...g,status:"TARGET_HIT",triggeredPrice:cp,triggeredAt:new Date().toLocaleTimeString()}}}
    return g;
  });
  if(changed){renderGtt();updateNavCounts();updateSummaryBar()}
}
function removeGtt(id){gttOrders=gttOrders.filter(g=>g.id!==id);saveState();renderGtt();updateNavCounts()}

// ============================================================
// ANALYTICS
// ============================================================
function renderAnalytics(){
  // Sector pie
  const sectorData=positions.reduce((a,p)=>{
    const s=NSE_MASTER.find(m=>m.symbol===p.symbol);const sec=(s ? s.sector : 'Other');
    const val=getPrice(p.symbol)*p.qty;const ex=a.find(x=>x.name===sec);
    if(ex)ex.value+=val;else a.push({name:sec,value:val});return a;
  },[]);
  const secEmpty=document.getElementById("sector-empty");
  const secCanvas=document.getElementById("sector-chart");
  if(sectorData.length===0){secEmpty.style.display="block";secCanvas.style.display="none"}
  else{
    secEmpty.style.display="none";secCanvas.style.display="block";
    if(sectorChart)sectorChart.destroy();
    sectorChart=new Chart(secCanvas,{
      type:"doughnut",
      data:{labels:sectorData.map(d=>d.name),datasets:[{data:sectorData.map(d=>d.value),backgroundColor:SECTOR_COLORS,borderWidth:2,borderColor:document.body.classList.contains("dark")?"#1e2130":"#dfdabf"}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:(ctx)=>`‚Çπ${fmt(ctx.parsed)}`}}}}
    });
    document.getElementById("sector-legend").innerHTML=sectorData.map((d,i)=>`<div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:11px"><div style="display:flex;gap:6px;align-items:center"><div style="width:8px;height:8px;border-radius:2px;background:${SECTOR_COLORS[i%SECTOR_COLORS.length]}"></div><span>${d.name}</span></div><span class="mono" style="color:var(--muted)">‚Çπ${fmt(d.value)}</span></div>`).join("");
  }
  // PnL chart
  const pnlHistory=orders.filter(o=>o.pnl!==undefined).reduce((a,o,i)=>{const prev=(a[a.length-1] ? a[a.length-1].cum : 0);a.push({x:i+1,cum:prev+o.pnl});return a},[]);
  const pnlCanvas=document.getElementById("pnl-chart"),pnlEmpty=document.getElementById("pnl-empty");
  if(pnlHistory.length<2){pnlEmpty.style.display="block";pnlCanvas.style.display="none"}
  else{
    pnlEmpty.style.display="none";pnlCanvas.style.display="block";
    if(pnlChart)pnlChart.destroy();
    const lastVal=(pnlHistory[pnlHistory.length-1] ? pnlHistory[pnlHistory.length-1].cum : 0);
    const color=lastVal>=0?"rgba(45,106,79,1)":"rgba(192,57,43,1)";
    pnlChart=new Chart(pnlCanvas,{
      type:"line",
      data:{labels:pnlHistory.map(p=>p.x),datasets:[{data:pnlHistory.map(p=>p.cum),borderColor:color,backgroundColor:lastVal>=0?"rgba(45,106,79,0.1)":"rgba(192,57,43,0.1)",borderWidth:2,fill:true,tension:.4,pointRadius:3,pointBackgroundColor:color}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:(ctx)=>`‚Çπ${fmt(ctx.parsed.y)}`}}},scales:{x:{ticks:{font:{size:9}}},y:{ticks:{font:{size:9},callback:(v)=>`‚Çπ${(v/1000).toFixed(0)}k`}}}}
    });
  }
  // Stat cards
  const closed=orders.filter(o=>o.pnl!==undefined);
  const wins=closed.filter(o=>o.pnl>0),losses=closed.filter(o=>o.pnl<=0);
  const rPnL=closed.reduce((s,o)=>s+o.pnl,0);
  const best=closed.length?Math.max(...closed.map(o=>o.pnl)):0;
  const worst=closed.length?Math.min(...closed.map(o=>o.pnl)):0;
  const aW=wins.length?wins.reduce((s,o)=>s+o.pnl,0)/wins.length:0;
  const aL=losses.length?losses.reduce((s,o)=>s+o.pnl,0)/losses.length:0;
  document.getElementById("stats-cards").innerHTML=[
    {l:"Realised P&L",v:`${rPnL>=0?"+":""}‚Çπ${fmt(rPnL)}`,c:rPnL>=0?"var(--up)":"var(--down)"},
    {l:"Win Rate",v:closed.length?`${((wins.length/closed.length)*100).toFixed(1)}%`:"‚Äî",c:"var(--up)"},
    {l:"Best Trade",v:best?`+‚Çπ${fmt(best)}`:"‚Äî",c:"var(--up)"},
    {l:"Worst Trade",v:worst?`‚Çπ${fmt(worst)}`:"‚Äî",c:"var(--down)"},
    {l:"Avg Win",v:aW?`+‚Çπ${fmt(aW)}`:"‚Äî",c:"var(--up)"},
    {l:"Avg Loss",v:aL?`‚Çπ${fmt(aL)}`:"‚Äî",c:"var(--down)"},
    {l:"Total Trades",v:closed.length,c:"var(--text)"},
    {l:"Open Positions",v:positions.length,c:"#5591b3"},
  ].map(s=>`<div class="card" style="padding:14px"><div style="font-size:10px;color:var(--faint);margin-bottom:5px">${s.l}</div><div class="mono" style="font-weight:700;font-size:14px;color:${s.c}">${s.v}</div></div>`).join("");
}

// ============================================================
// NEWS FEED ‚Äî Real-time via RSS + NSE API
// ============================================================
let realNews = [];
let earningsData = [];
let newsFilter = 'all';
let newsFetchInProgress = false;

// ‚îÄ‚îÄ switchNewsTab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchNewsTab(tab){
  const isNews = tab === 'news';
  document.getElementById('news-panel').style.display    = isNews ? 'block' : 'none';
  document.getElementById('earnings-panel').style.display = isNews ? 'none'  : 'block';
  document.getElementById('sub-news-btn').classList.toggle('active', isNews);
  document.getElementById('sub-earn-btn').classList.toggle('active', !isNews);
  if(!isNews && earningsData.length === 0) fetchEarningsCalendar();
}

// ‚îÄ‚îÄ filterNews ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filterNews(src){
  newsFilter = src;
  ['all','nse','google','et','sim'].forEach(s => {
    const el = document.getElementById('nsrc-' + s);
    if(el) el.classList.toggle('active', s === src);
  });
  renderNews();
}

// ‚îÄ‚îÄ refreshNewsAndResults ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function refreshNewsAndResults(){
  fetchRealNews();
  if(earningsData.length === 0) fetchEarningsCalendar();
}

// ‚îÄ‚îÄ FETCH REAL NEWS via RSS2JSON proxy ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchRealNews(){
  if(newsFetchInProgress) return;
  newsFetchInProgress = true;
  const statusEl = document.getElementById('news-count');
  if(statusEl) statusEl.textContent = '‚ü≥ Live news fetch ho rahi hai...';

  const feeds = [
    { url: 'https://economictimes.indiatimes.com/markets/rssfeeds/1977021501.cms', source: 'et',     icon: 'üì∞', label: 'Economic Times' },
    { url: 'https://economictimes.indiatimes.com/markets/stocks/rssfeeds/2146842.cms', source: 'et', icon: 'üìä', label: 'ET Markets' },
    { url: 'https://www.moneycontrol.com/rss/marketsnews.xml',   source: 'google', icon: 'üíπ', label: 'MoneyControl' },
    { url: 'https://www.business-standard.com/rss/markets-106.rss', source: 'google', icon: 'üè¶', label: 'Business Standard' },
  ];

  // Use rss2json.com free API to bypass CORS
  const RSS2JSON = 'https://api.rss2json.com/v1/api.json?rss_url=';
  let fetched = [];

  await Promise.allSettled(feeds.map(async feed => {
    try {
      const r = await fetch(RSS2JSON + encodeURIComponent(feed.url), { signal: AbortSignal.timeout(8000) });
      if(!r.ok) return;
      const data = await r.json();
      if(data.status !== 'ok' || !data.items) return;
      data.items.slice(0, 10).forEach(item => {
        // Extract NSE symbols mentioned in title
        const title = item.title || '';
        const foundSym = NSE_MASTER.find(s =>
          title.toUpperCase().includes(s.symbol) ||
          (s.name && title.toLowerCase().includes(s.name.toLowerCase().split(' ')[0]))
        );
        const pubDate = item.pubDate ? new Date(item.pubDate) : new Date();
        const timeStr = pubDate.toLocaleTimeString('en-IN', {hour:'2-digit', minute:'2-digit'});
        const dateStr = pubDate.toLocaleDateString('en-IN', {day:'2-digit', month:'short'});
        const isToday = pubDate.toDateString() === new Date().toDateString();
        fetched.push({
          id: item.guid || item.link || Date.now() + Math.random(),
          title: item.title,
          desc: item.description ? item.description.replace(/<[^>]*>/g,'').slice(0,120) + '...' : '',
          link: item.link,
          source: feed.source,
          label: feed.label,
          icon: feed.icon,
          symbol: foundSym ? foundSym.symbol : null,
          time: isToday ? timeStr : dateStr,
          ts: pubDate.getTime(),
          isPos: /surge|gain|rise|rally|jump|high|bull|buy|upgrade|profit|record/i.test(title),
          isNeg: /fall|drop|slip|crash|down|bear|sell|downgrade|loss|weak|concern/i.test(title),
        });
      });
    } catch(e){ console.warn('RSS feed failed:', feed.label, e.message); }
  }));

  // Also fetch NSE corporate announcements
  try {
    const nseUrl = 'https://www.nseindia.com/api/corporates-corporateActions?index=equities&from_date=' + 
      new Date().toLocaleDateString('en-IN', {day:'2-digit', month:'2-digit', year:'numeric'}).replace(/\//g,'-');
    // NSE needs cookies ‚Äî use a known working endpoint
    const r2 = await fetch('https://www.nseindia.com/api/market-turnover', {
      headers: { 'Accept': 'application/json', 'Referer': 'https://www.nseindia.com/' },
      signal: AbortSignal.timeout(5000)
    });
    if(r2.ok){
      fetched.push({
        id: 'nse-live-' + Date.now(),
        title: 'üèõ NSE Market Update ‚Äî Live data connected',
        desc: 'NSE market turnover data available. Check NSE website for full corporate actions.',
        link: 'https://www.nseindia.com/market-data/live-equity-market',
        source: 'nse', label: 'NSE India', icon: 'üèõ',
        symbol: null, time: new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'}),
        ts: Date.now(), isPos: true, isNeg: false
      });
    }
  } catch(e){ /* NSE blocks direct requests ‚Äî expected */ }

  if(fetched.length > 0){
    // Merge with existing, deduplicate, sort by time
    const existing = realNews.filter(n => n.source === 'sim');
    realNews = [...fetched, ...existing].sort((a,b) => b.ts - a.ts).slice(0,60);
    if(statusEl) statusEl.textContent = `‚úÖ ${fetched.length} real articles ‚Ä¢ Updated ${new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})}`;
  } else {
    // Fallback to simulation if all feeds fail
    if(statusEl) statusEl.textContent = `‚ö†Ô∏è Live feeds unavailable ‚Äî simulation mode`;
    generateNewsSimulated();
  }

  newsFetchInProgress = false;
  if(activeTab === 'news') renderNews();
}

// ‚îÄ‚îÄ GENERATE SIMULATED NEWS (fallback) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const NEWS_TEMPLATES=[
  {icon:"üìà",templates:["{sym} surges {pct}% after strong Q3 results","{sym} gains {pct}% on bulk deal by FII","{sym} hits 52-week high, up {pct}% today","Analysts raise target on {sym} by {pct}%"]},
  {icon:"üìâ",templates:["{sym} falls {pct}% on weak earnings guidance","{sym} drops {pct}% after promoter stake sale","Brokerage downgrades {sym}, stock falls {pct}%","{sym} tumbles {pct}% on macro concerns"]},
  {icon:"üì∞",templates:["{sym} board approves ‚Çπ{amt}Cr capex plan","{sym} announces strategic partnership","SEBI scrutiny on {sym} insider trading allegations","{sym} to raise funds via QIP at ‚Çπ{price}","RBI policy impact: {sym} in focus today","Budget allocation boosts {sym} sector outlook"]},
];
function generateNewsSimulated(){
  const s=NSE_MASTER[Math.floor(Math.random()*NSE_MASTER.length)];
  const cat=NEWS_TEMPLATES[Math.floor(Math.random()*NEWS_TEMPLATES.length)];
  const tmpl=cat.templates[Math.floor(Math.random()*cat.templates.length)];
  const pct=(Math.random()*8+0.5).toFixed(1);
  const amt=Math.floor(Math.random()*5000+500).toLocaleString("en-IN");
  const price=Math.floor((getPrice(s.symbol)||1000)*(1+(Math.random()-.5)*.1)).toLocaleString("en-IN");
  const text=tmpl.replace("{sym}",s.symbol).replace("{pct}",pct).replace("{amt}",amt).replace("{price}",price);
  const item={id:Date.now(),title:text,desc:'',link:null,source:'sim',label:'Simulation',icon:cat.icon,
    symbol:s.symbol,time:new Date().toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit"}),
    ts:Date.now(),isPos:cat.icon==="üìà",isNeg:cat.icon==="üìâ"};
  realNews=[item,...realNews].slice(0,30);
}
// Legacy alias
function generateNews(){ generateNewsSimulated(); if(activeTab==='news') renderNews(); }

// ‚îÄ‚îÄ RENDER NEWS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderNews(){
  const filtered = newsFilter === 'all' ? realNews : realNews.filter(n => n.source === newsFilter);
  const feed = document.getElementById('news-feed');
  if(!feed) return;
  if(filtered.length === 0){
    feed.innerHTML = `<div style="padding:40px;text-align:center;color:var(--muted)"><div style="font-size:28px;margin-bottom:8px">üì∞</div><div style="font-size:13px">Koi news nahi mili ‚Äî Refresh karo</div></div>`;
    return;
  }
  feed.innerHTML = filtered.map(n => `
    <div class="news-item" ${n.link ? `style="cursor:pointer" onclick="window.open('${n.link}','_blank')"` : ''}>
      <span style="font-size:16px;flex-shrink:0;margin-top:2px">${n.icon}</span>
      <div style="flex:1;min-width:0">
        <div style="font-size:12px;line-height:1.5;font-weight:500">${n.title}</div>
        ${n.desc ? `<div style="font-size:11px;color:var(--muted);margin-top:3px;line-height:1.4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${n.desc}</div>` : ''}
        <div style="display:flex;gap:6px;margin-top:5px;align-items:center;flex-wrap:wrap">
          <span style="font-size:9px;color:var(--faint)">${n.time}</span>
          <span style="font-size:9px;font-weight:600;color:#5591b3;padding:1px 6px;background:rgba(85,145,179,.12);border-radius:4px">${n.label}</span>
          ${n.symbol ? `<span style="font-size:9px;font-weight:700;color:var(--accent);padding:1px 6px;background:rgba(124,98,68,.1);border-radius:4px">${n.symbol}</span>` : ''}
          ${n.isPos ? `<span style="font-size:9px;color:var(--up);font-weight:700">‚ñ≤ BULLISH</span>` : ''}
          ${n.isNeg ? `<span style="font-size:9px;color:var(--down);font-weight:700">‚ñº BEARISH</span>` : ''}
          ${n.link ? `<span style="font-size:9px;color:var(--faint)">‚Üó Read more</span>` : ''}
        </div>
      </div>
      ${n.symbol ? `<div style="display:flex;gap:3px;flex-shrink:0">
        <button class="btn-buy" style="padding:3px 7px;font-size:10px" onclick="event.stopPropagation();openOrderModal('${n.symbol}','BUY')">B</button>
        <button class="btn-sell" style="padding:3px 7px;font-size:10px" onclick="event.stopPropagation();openOrderModal('${n.symbol}','SELL')">S</button>
      </div>` : ''}
    </div>`).join('');
}

// ‚îÄ‚îÄ FETCH EARNINGS / RESULTS CALENDAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchEarningsCalendar(){
  const feed = document.getElementById('earnings-feed');
  if(feed) feed.innerHTML = `<div style="padding:40px;text-align:center;color:var(--muted)"><div class="spin" style="font-size:24px">‚ü≥</div><div style="margin-top:8px;font-size:12px">NSE se results calendar fetch ho raha hai...</div></div>`;

  // Hardcoded upcoming quarterly results for NSE top companies
  // Based on typical Q3 FY25 result schedule (Jan-Feb 2025)
  const today = new Date();
  today.setHours(0,0,0,0);

  // Build dynamic results around today's date
  function daysFromToday(d){ const dt = new Date(today); dt.setDate(dt.getDate()+d); return dt; }
  function fmtDate(d){ return d.toLocaleDateString('en-IN',{weekday:'short',day:'2-digit',month:'short',year:'numeric'}); }

  // Try to fetch from NSE corporate actions API
  let nseResults = [];
  try {
    const fromDate = new Date(today); fromDate.setDate(fromDate.getDate()-7);
    const toDate   = new Date(today); toDate.setDate(toDate.getDate()+30);
    const fmt = d => `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
    const url = `https://www.nseindia.com/api/corporates-corporateActions?index=equities&from_date=${fmt(fromDate)}&to_date=${fmt(toDate)}`;
    const r = await fetch(url, {
      headers: { 'Accept':'application/json','Referer':'https://www.nseindia.com/','User-Agent':'Mozilla/5.0' },
      signal: AbortSignal.timeout(8000)
    });
    if(r.ok){
      const data = await r.json();
      if(Array.isArray(data)){
        nseResults = data.filter(d => d.subject && /result|quarterly|financial/i.test(d.subject)).map(d => ({
          symbol: d.symbol, name: d.comp || d.symbol, date: new Date(d.exDate || d.recDate),
          event: d.subject, source: 'NSE'
        }));
      }
    }
  } catch(e){ console.warn('NSE calendar fetch failed:', e.message); }

  // Fallback: curated list of major NSE companies with typical result windows
  if(nseResults.length === 0){
    const companies = [
      {symbol:'RELIANCE',name:'Reliance Industries',offset:2},{symbol:'TCS',name:'Tata Consultancy Services',offset:3},
      {symbol:'HDFCBANK',name:'HDFC Bank',offset:1},{symbol:'INFY',name:'Infosys',offset:5},
      {symbol:'ICICIBANK',name:'ICICI Bank',offset:4},{symbol:'SBIN',name:'State Bank of India',offset:7},
      {symbol:'HINDUNILVR',name:'Hindustan Unilever',offset:6},{symbol:'ITC',name:'ITC Ltd',offset:8},
      {symbol:'KOTAKBANK',name:'Kotak Mahindra Bank',offset:3},{symbol:'AXISBANK',name:'Axis Bank',offset:9},
      {symbol:'WIPRO',name:'Wipro',offset:10},{symbol:'HCLTECH',name:'HCL Technologies',offset:2},
      {symbol:'BAJFINANCE',name:'Bajaj Finance',offset:11},{symbol:'MARUTI',name:'Maruti Suzuki',offset:5},
      {symbol:'TATAMOTORS',name:'Tata Motors',offset:13},{symbol:'ADANIENT',name:'Adani Enterprises',offset:6},
      {symbol:'SUNPHARMA',name:'Sun Pharma',offset:14},{symbol:'TITAN',name:'Titan Company',offset:8},
      {symbol:'NESTLEIND',name:'Nestle India',offset:15},{symbol:'POWERGRID',name:'Power Grid',offset:4},
      {symbol:'ONGC',name:'ONGC',offset:7},{symbol:'NTPC',name:'NTPC',offset:9},
      {symbol:'COALINDIA',name:'Coal India',offset:12},{symbol:'DIVISLAB',name:'Divis Labs',offset:16},
      {symbol:'CIPLA',name:'Cipla',offset:3},{symbol:'DRREDDY',name:'Dr Reddys',offset:18},
      {symbol:'TECHM',name:'Tech Mahindra',offset:11},{symbol:'LTIM',name:'LTIMindtree',offset:17},
      {symbol:'BAJAJFINSV',name:'Bajaj Finserv',offset:20},{symbol:'GRASIM',name:'Grasim Industries',offset:19},
    ];
    nseResults = companies.map(c => ({
      symbol: c.symbol, name: c.name,
      date: daysFromToday(c.offset),
      event: 'Q3 FY25 Financial Results', source: 'Expected'
    }));
  }

  // Sort by date
  nseResults.sort((a,b) => a.date - b.date);
  earningsData = nseResults;

  // Build date filter buttons
  const dates = [...new Set(nseResults.map(r => r.date.toDateString()))];
  const dateFiltersEl = document.getElementById('results-date-filters') || document.getElementById('earnings-feed');

  renderEarningsCalendar('all');
  updateResultsBadge();
}

function renderEarningsCalendar(dateFilter){
  const feed = document.getElementById('earnings-feed');
  if(!feed || earningsData.length === 0){ fetchEarningsCalendar(); return; }

  const today = new Date(); today.setHours(0,0,0,0);
  const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate()+1);

  const grouped = {};
  earningsData.forEach(r => {
    const ds = r.date.toDateString();
    if(!grouped[ds]) grouped[ds] = [];
    grouped[ds].push(r);
  });

  let html = '';
  Object.entries(grouped).forEach(([ds, items]) => {
    const d = new Date(ds);
    const isToday = d.toDateString() === today.toDateString();
    const isTomorrow = d.toDateString() === tomorrow.toDateString();
    const isPast = d < today;
    const label = isToday ? 'üî¥ TODAY' : isTomorrow ? 'üü° TOMORROW' : '';
    const dateLabel = d.toLocaleDateString('en-IN',{weekday:'short',day:'2-digit',month:'short',year:'numeric'});

    html += `<div style="padding:10px 16px;background:${isToday?'rgba(124,98,68,.08)':isPast?'rgba(0,0,0,.02)':'transparent'};border-bottom:1px solid var(--border)">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <span style="font-size:11px;font-weight:700;color:${isToday?'var(--accent)':isPast?'var(--faint)':'var(--text)'}">${dateLabel}</span>
        ${label ? `<span style="font-size:10px;font-weight:800;color:${isToday?'var(--down)':'#c07020'};background:${isToday?'rgba(184,48,37,.1)':'rgba(192,112,32,.1)'};padding:2px 8px;border-radius:20px">${label}</span>` : ''}
        <span style="font-size:10px;color:var(--faint)">${items.length} companies</span>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">
        ${items.map(r => {
          const st = stocks.find(s => s.symbol === r.symbol);
          const price = st ? `‚Çπ${fmt(st.price)}` : '';
          const chg = st ? st.changePct : 0;
          const chgColor = chg >= 0 ? 'var(--up)' : 'var(--down)';
          const chgStr = st ? `<span style="font-size:9px;color:${chgColor};font-weight:600">${chg>=0?'+':''}${chg.toFixed(2)}%</span>` : '';
          return `<div style="display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--card);border:1px solid var(--border);border-radius:8px;min-width:160px;cursor:pointer;transition:all .15s" 
            onclick="openOrderModal('${r.symbol}','BUY')"
            onmouseover="this.style.borderColor='rgba(124,98,68,.4)'" onmouseout="this.style.borderColor='var(--border)'">
            <div style="width:28px;height:28px;border-radius:6px;background:${isToday?'linear-gradient(135deg,var(--accent),#5e4a31)':'var(--surface)'};display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;color:${isToday?'#fff':'var(--text)'};flex-shrink:0">${r.symbol.slice(0,3)}</div>
            <div style="flex:1;min-width:0">
              <div style="font-size:11px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${r.symbol}</div>
              <div style="font-size:9px;color:var(--faint);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${r.name}</div>
            </div>
            <div style="text-align:right;flex-shrink:0">
              <div style="font-size:10px;font-weight:600;font-family:'JetBrains Mono',monospace">${price}</div>
              ${chgStr}
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>`;
  });

  if(!html) html = `<div style="padding:40px;text-align:center;color:var(--muted)"><div style="font-size:28px;margin-bottom:8px">üìÖ</div><div style="font-size:13px">Koi upcoming results nahi hain is period mein</div></div>`;
  feed.innerHTML = html;
}
// Update "Results Today" badge in nav
function updateResultsBadge(){
  const today = new Date(); today.setHours(0,0,0,0);
  const todayResults = earningsData.filter(r => r.date.toDateString() === today.toDateString());
  const badge = document.getElementById('results-today-badge');
  const cnt = document.getElementById('results-today-count');
  if(badge && cnt){
    cnt.textContent = todayResults.length;
    badge.style.display = todayResults.length > 0 ? 'flex' : 'none';
  }
}

// ============================================================
// ORDER MODAL
// ============================================================
let omChartInst=null;
let tvChartInstance = null;
let tvSeries = null;
let currentChartTF = '1d';

function openOrderModal(sym,ot){
  orderStock=stocks.find(s=>s.symbol===sym);
  if(!orderStock)return;
  orderType=ot||"BUY";
  tradeType="equity";orderQty=1;orderLots=1;
  document.getElementById("om-symbol").textContent=orderStock.symbol;
  document.getElementById("om-name").textContent=orderStock.name;
  updateOrderModal();
  document.getElementById("order-overlay").style.display="flex";
  setTimeout(()=>buildTVChart('1d'), 100);
}

// TradingView symbol mapping ‚Äî NSE format
const TV_SYMBOL_MAP = {
  "INFOSYS": "INFY", "BAJAJ-AUTO": "BAJAJ_AUTO", "M&M": "M_M",
  "MCDOWELL-N": "MCDOWELL_N", "NAUKRI": "NAUKRI",
};

function getTVSymbol(symbol){
  const mapped = TV_SYMBOL_MAP[symbol] || symbol;
  return `NSE:${mapped}`;
}

async function buildTVChart(tf){
  const container = document.getElementById('tradingview-widget-container');
  if(!container || !orderStock) return;

  container.innerHTML = '';
  const isDark = document.body.classList.contains('dark');
  const isUp   = orderStock.changePct >= 0;

  // Chart container div
  const chartDiv = document.createElement('div');
  chartDiv.style.cssText = 'width:100%;height:100%';
  container.appendChild(chartDiv);

  // Timeframe buttons
  const tfBar = document.createElement('div');
  tfBar.style.cssText = 'display:flex;gap:4px;padding:8px 10px 4px;background:transparent';
  ['1D','5D','1M','3M','1Y'].forEach((label, i) => {
    const tfs = ['1d','5d','1mo','3mo','1y'];
    const btn = document.createElement('button');
    btn.textContent = label;
    btn.style.cssText = `padding:3px 10px;border-radius:5px;border:1px solid var(--border);background:${tf===tfs[i]?'var(--accent)':'transparent'};color:${tf===tfs[i]?'#fff':'var(--muted)'};font-size:10px;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif`;
    btn.onclick = () => buildTVChart(tfs[i]);
    tfBar.appendChild(btn);
  });
  container.insertBefore(tfBar, chartDiv);

  // Create LightweightChart
  const chartHeight = container.clientHeight - 44;
  const chart = LightweightCharts.createChart(chartDiv, {
    width: container.clientWidth,
    height: chartHeight > 100 ? chartHeight : 400,
    layout: {
      background: { color: 'transparent' },
      textColor: isDark ? 'rgba(223,227,236,0.6)' : 'rgba(28,31,33,0.5)',
      fontSize: 11,
    },
    grid: {
      vertLines: { color: isDark ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.04)' },
      horzLines: { color: isDark ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.04)' },
    },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
    rightPriceScale: { borderVisible: false },
    timeScale: { borderVisible: false, timeVisible: true, secondsVisible: false, rightOffset: 5 },
    handleScroll: true,
    handleScale: true,
  });

  tvChartInstance = chart;

  // Candlestick series
  const candleSeries = chart.addCandlestickSeries({
    upColor: isDark ? '#38c98a' : '#1a6040',
    downColor: isDark ? '#f05070' : '#b83025',
    borderUpColor: isDark ? '#38c98a' : '#1a6040',
    borderDownColor: isDark ? '#f05070' : '#b83025',
    wickUpColor: isDark ? '#38c98a' : '#1a6040',
    wickDownColor: isDark ? '#f05070' : '#b83025',
  });

  // Volume series
  const volSeries = chart.addHistogramSeries({
    color: isDark ? 'rgba(56,201,138,0.2)' : 'rgba(26,96,64,0.15)',
    priceFormat: { type: 'volume' },
    priceScaleId: 'vol',
    scaleMargins: { top: 0.8, bottom: 0 },
  });

  // Loading indicator
  const loadDiv = document.createElement('div');
  loadDiv.style.cssText = 'position:absolute;top:50%;left:40%;transform:translate(-50%,-50%);color:var(--muted);font-size:12px;font-family:Outfit,sans-serif';
  loadDiv.textContent = '‚ü≥ Chart load ho rahi hai...';
  container.style.position = 'relative';
  container.appendChild(loadDiv);

  // Fetch from Yahoo Finance via proxy
  try {
    const yfsym = encodeURIComponent(orderStock.yf || orderStock.symbol + '.NS');

    const tfMap = {
      '1d' : { range:'1d',  interval:'5m'  },
      '5d' : { range:'5d',  interval:'15m' },
      '1mo': { range:'1mo', interval:'1h'  },
      '3mo': { range:'3mo', interval:'1d'  },
      '1y' : { range:'1y',  interval:'1wk' },
    };
    const cfg = tfMap[tf] || tfMap['1d'];
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${yfsym}?range=${cfg.range}&interval=${cfg.interval}&includePrePost=false`;

    const text = await fetchWithProxy(url);
    loadDiv.remove();

    if(text){
      const d = JSON.parse(text);
      const res   = d?.chart?.result?.[0];
      const ts    = res?.timestamp || [];
      const ohlc  = res?.indicators?.quote?.[0] || {};
      const opens  = ohlc.open  || [];
      const highs  = ohlc.high  || [];
      const lows   = ohlc.low   || [];
      const closes = ohlc.close || [];
      const vols   = ohlc.volume|| [];

      if(ts.length > 0){
        const candles = ts.map((t,i) => ({
          time : t,
          open : +(opens[i]  || closes[i] || 0),
          high : +(highs[i]  || closes[i] || 0),
          low  : +(lows[i]   || closes[i] || 0),
          close: +(closes[i] || 0),
        })).filter(c => c.close > 0 && c.open > 0);

        const volData = ts.map((t,i)=>({
          time : t,
          value: +(vols[i] || 0),
          color: (+(closes[i]||0) >= +(opens[i]||0))
            ? (isDark?'rgba(56,201,138,0.25)':'rgba(26,96,64,0.2)')
            : (isDark?'rgba(240,80,112,0.25)':'rgba(184,48,37,0.2)'),
        })).filter(v => v.value > 0);

        if(candles.length > 0){
          candleSeries.setData(candles);
          volSeries.setData(volData);
          chart.timeScale().fitContent();
          const last = candles[candles.length-1];
          const liveEl = document.getElementById('om-price-live');
          if(liveEl) liveEl.textContent = '‚Çπ' + last.close.toFixed(2);
          orderStock.price = last.close;
          updateOrderModal();
          return;
        }
      }
    }
    throw new Error('Yahoo se data nahi aaya');
  } catch(e) {
    console.warn('Chart error:', e.message);
    try{ loadDiv.remove(); }catch(ex){}
    // Fallback ‚Äî price history se
    const areaSeries = chart.addAreaSeries({
      lineColor: isUp ? (isDark?'#38c98a':'#1a6040') : (isDark?'#f05070':'#b83025'),
      topColor: isUp ? 'rgba(56,201,138,0.2)' : 'rgba(240,80,112,0.15)',
      bottomColor: 'rgba(0,0,0,0)',
      lineWidth: 2,
    });
    const hist = orderStock.priceHistory || [];
    if(hist.length > 1){
      areaSeries.setData(hist.map(h=>({ time: Math.floor(h.t/1000), value: +h.price.toFixed(2) })));
      chart.timeScale().fitContent();
    }
    const liveEl = document.getElementById('om-price-live');
    if(liveEl) liveEl.textContent = '‚Çπ' + (orderStock.price||0).toFixed(2);
  }
}

function setChartTF(tf, btn){
  currentChartTF = tf;
  buildTVChart(tf);
}

function closeOrderModal(){
  document.getElementById("order-overlay").style.display="none";
  const container = document.getElementById('tradingview-widget-container');
  if(container) container.innerHTML = '';
  if(tvChartInstance){ try{ tvChartInstance.remove(); }catch(e){} tvChartInstance=null; tvSeries=null; }
  if(omChartInst){omChartInst.destroy();omChartInst=null}
  orderStock=null;
}

function setOrderType(ot){
  orderType=ot;
  const buyBtn=document.getElementById("ot-buy"),sellBtn=document.getElementById("ot-sell");
  if(ot==="BUY"){
    buyBtn.style.background="linear-gradient(135deg,#7c6244,#5e4a31)";buyBtn.style.color="#fff";
    sellBtn.style.background="var(--inp)";sellBtn.style.color="var(--muted)";
  }else{
    sellBtn.style.background="linear-gradient(135deg,#e74c3c,#c0392b)";sellBtn.style.color="#fff";
    buyBtn.style.background="var(--inp)";buyBtn.style.color="var(--muted)";
  }
  updateOrderModal();
}
function setTradeType(tt){
  tradeType=tt;
  document.getElementById("tt-equity").classList.toggle("active",tt==="equity");
  document.getElementById("tt-futures").classList.toggle("active",tt==="futures");
  updateOrderModal();
}
function updateOrderModal(){
  if(!orderStock)return;
  const isUp=orderStock.changePct>=0;
  document.getElementById("om-price").textContent=orderStock.price>0?"‚Çπ"+orderStock.price.toFixed(2):"‚Çπ‚Äî";
  const chEl=document.getElementById("om-change");
  chEl.textContent=`${isUp?"‚ñ≤":"‚ñº"} ${Math.abs(orderStock.changePct).toFixed(2)}%`;
  chEl.style.color=isUp?"var(--up)":"var(--down)";
  const qty=tradeType==="futures"?orderLots*orderStock.lotSize:orderQty;
  const tv=orderStock.price*qty;
  const ch=calcCharges(tv,tradeType);
  const tc=orderType==="BUY"?tv+ch.total:tv-ch.total;
  // Qty section
  document.getElementById("qty-section").innerHTML=tradeType==="equity"?
    `<label style="color:var(--muted);font-size:12px;display:block;margin-bottom:6px">Quantity (Shares)</label>
     <div style="display:flex;gap:6px;align-items:center">
       <button onclick="adjQty(-1)" style="padding:8px 13px;background:var(--inp);border:none;border-radius:7px;color:var(--text);font-size:15px;cursor:pointer">‚àí</button>
       <input class="inp" type="number" min="1" id="qty-inp" value="${orderQty}" oninput="orderQty=Math.max(1,parseInt(this.value)||1);updateOrderModal()" style="text-align:center"/>
       <button onclick="adjQty(1)" style="padding:8px 13px;background:var(--inp);border:none;border-radius:7px;color:var(--text);font-size:15px;cursor:pointer">+</button>
     </div>`:
    `<label style="color:var(--muted);font-size:12px;display:block;margin-bottom:6px">Lots (1 lot = ${orderStock.lotSize} shares)</label>
     <div style="display:flex;gap:6px;align-items:center">
       <button onclick="adjLots(-1)" style="padding:8px 13px;background:var(--inp);border:none;border-radius:7px;color:var(--text);font-size:15px;cursor:pointer">‚àí</button>
       <input class="inp" type="number" min="1" id="lots-inp" value="${orderLots}" oninput="orderLots=Math.max(1,parseInt(this.value)||1);updateOrderModal()" style="text-align:center"/>
       <button onclick="adjLots(1)" style="padding:8px 13px;background:var(--inp);border:none;border-radius:7px;color:var(--text);font-size:15px;cursor:pointer">+</button>
     </div>
     <div style="font-size:10px;color:var(--faint);margin-top:4px">= ${qty.toLocaleString()} shares</div>`;
  // Charges
  document.getElementById("charges-rows").innerHTML=[
    ["Trade Value",`‚Çπ${fmt(tv)}`],["Brokerage",`‚Çπ${fmt(ch.brokerage)}`],["STT",`‚Çπ${fmt(ch.stt)}`],
    ["Exchange Charges",`‚Çπ${fmt(ch.exchangeCharge)}`],["SEBI",`‚Çπ${fmt(ch.sebi)}`],
    ["Stamp Duty",`‚Çπ${fmt(ch.stampDuty)}`],["GST (18%)",`‚Çπ${fmt(ch.gst)}`]
  ].map(([l,v])=>`<div style="display:flex;justify-content:space-between;font-size:11px;padding:2px 0;color:var(--muted)"><span>${l}</span><span class="mono">${v}</span></div>`).join("");
  document.getElementById("cost-label").textContent=orderType==="BUY"?"Cost":"Receivable";
  document.getElementById("total-cost").textContent="‚Çπ"+fmt(Math.abs(tc));
  document.getElementById("total-cost").style.color=orderType==="BUY"?"var(--down)":"var(--up)";
  const btn=document.getElementById("place-btn");
  btn.textContent=`${orderType==="BUY"?"‚ñ≤":"‚ñº"} Place ${orderType} Order`;
  btn.style.background=orderType==="BUY"?"linear-gradient(135deg,#7c6244,#5e4a31)":"linear-gradient(135deg,#e74c3c,#c0392b)";
}
function adjQty(d){orderQty=Math.max(1,orderQty+d);const el=document.getElementById("qty-inp");if(el)el.value=orderQty;updateOrderModal()}
function adjLots(d){orderLots=Math.max(1,orderLots+d);const el=document.getElementById("lots-inp");if(el)el.value=orderLots;updateOrderModal()}

// ============================================================
// INSTANT ORDER PLACEMENT ‚Äî <100ms response
// ============================================================
function placeOrder(){
  if(!orderStock)return;
  const qty=tradeType==="futures"?orderLots*orderStock.lotSize:orderQty;
  const price=orderStock.price;
  if(price<=0){showNotif("Price not loaded yet. Please wait.","error");return}
  const tv=price*qty;
  const ch=calcCharges(tv,tradeType);
  if(orderType==="BUY"&&tv+ch.total>balance){showNotif("Insufficient balance!","error");return}
  const ord={id:Date.now(),symbol:orderStock.symbol,name:orderStock.name,type:orderType,tradeType,qty,price,value:tv,charges:ch.total,time:new Date().toLocaleTimeString(),date:new Date().toLocaleDateString(),status:"EXECUTED"};
  orders=[ord,...orders];
  // Update position
  const existIdx=positions.findIndex(p=>p.symbol===orderStock.symbol&&p.tradeType===tradeType);
  if(existIdx>=0){
    const ex=positions[existIdx];
    if(ex.type===orderType){
      const nq=ex.qty+qty,na=((ex.avgPrice*ex.qty)+(price*qty))/nq;
      positions[existIdx]={...ex,qty:nq,avgPrice:+na.toFixed(2)};
    } else {
      if(qty>=ex.qty)positions.splice(existIdx,1);
      else positions[existIdx]={...ex,qty:ex.qty-qty};
    }
  } else {
    positions.push({id:Date.now(),symbol:orderStock.symbol,name:orderStock.name,type:orderType,tradeType,qty,avgPrice:price,lotSize:orderStock.lotSize});
  }
  if(orderType==="BUY"){balance-=tv+ch.total;usedMargin+=tv}
  else{balance+=tv-ch.total;usedMargin=Math.max(0,usedMargin-tv)}
  showNotif(`${orderType} ${qty} shares of ${orderStock.symbol} @ ‚Çπ${price.toFixed(2)}`);
  saveState();
  closeOrderModal();renderAll();
}

// ============================================================
// GTT MODAL
// ============================================================
function openGttModal(sym){
  gttStock=stocks.find(s=>s.symbol===sym);
  if(!gttStock)return;
  gttOrderType="BUY";
  document.getElementById("gm-symbol").textContent=gttStock.symbol;
  document.getElementById("gm-name").textContent=gttStock.name;
  document.getElementById("gm-price").textContent=gttStock.price>0?"‚Çπ"+gttStock.price.toFixed(2):"‚Çπ‚Äî";
  document.getElementById("gm-qty").value=1;
  document.getElementById("gm-sl").value="";
  document.getElementById("gm-tgt").value="";
  document.getElementById("gm-trail").value="";
  document.getElementById("gm-trail-toggle").checked=false;
  document.getElementById("gm-trail-input").style.display="none";
  document.getElementById("gm-sl-hint").textContent=gttOrderType==="BUY"?"Triggers when price drops to/below this level":"Triggers when price rises to/above this level";
  document.getElementById("gtt-overlay").style.display="flex";
}
function closeGttModal(){document.getElementById("gtt-overlay").style.display="none";gttStock=null}
function setGttType(t){
  gttOrderType=t;
  const b=document.getElementById("gt-buy"),s=document.getElementById("gt-sell");
  if(t==="BUY"){b.style.background="linear-gradient(135deg,#7c6244,#5e4a31)";b.style.color="#fff";s.style.background="var(--inp)";s.style.color="var(--muted)"}
  else{s.style.background="linear-gradient(135deg,#e74c3c,#c0392b)";s.style.color="#fff";b.style.background="var(--inp)";b.style.color="var(--muted)"}
  document.getElementById("gm-sl-hint").textContent=t==="BUY"?"Triggers when price drops to/below":"Triggers when price rises to/above";
}
function toggleTrail(cb){document.getElementById("gm-trail-input").style.display=cb.checked?"block":"none"}
function placeGtt(){
  if(!gttStock)return;
  const sl=parseFloat(document.getElementById("gm-sl").value);
  const tgt=parseFloat(document.getElementById("gm-tgt").value);
  const trail=parseFloat(document.getElementById("gm-trail").value);
  const qty=parseInt(document.getElementById("gm-qty").value)||1;
  const isTrail=document.getElementById("gm-trail-toggle").checked;
  if(!sl&&!tgt){showNotif("Enter SL or Target price","error");return}
  gttOrders=[{id:Date.now(),symbol:gttStock.symbol,name:gttStock.name,orderType:gttOrderType,qty,stopLoss:sl||null,currentStopLoss:sl||null,target:tgt||null,trailingOffset:trail||null,isTrailing:isTrail&&!!trail,status:"ACTIVE",createdAt:new Date().toLocaleTimeString(),entryPrice:gttStock.price},...gttOrders];
  closeGttModal();showNotif(`GTT order set for ${gttStock.symbol}`);saveState();renderGtt();updateNavCounts();updateSummaryBar();
}

// ============================================================
// BALANCE / NETWORTH MODALS
// ============================================================
function openBalModal(){document.getElementById("bal-cur").textContent="‚Çπ"+fmt(balance);document.getElementById("bal-overlay").style.display="flex"}
function closeBalModal(){document.getElementById("bal-overlay").style.display="none"}
function updateBalance(){
  const v=parseFloat(document.getElementById("bal-input").value);
  if(v>0){balance=v;closeBalModal();showNotif(`Balance updated to ‚Çπ${fmt(v)}`);saveState();renderAll()}
  else showNotif("Enter a valid amount","error");
}
function openNetworthModal(){
  const portVal=positions.reduce((a,p)=>a+(getPrice(p.symbol)*p.qty),0);
  document.getElementById("nw-cur").textContent="‚Çπ"+fmt(balance+portVal);
  document.getElementById("nw-overlay").style.display="flex";
}
function closeNetworthModal(){document.getElementById("nw-overlay").style.display="none"}
function updateNetworth(){
  const v=parseFloat(document.getElementById("nw-input").value);
  const portVal=positions.reduce((a,p)=>a+(getPrice(p.symbol)*p.qty),0);
  if(v>0){balance=Math.max(0,v-portVal);closeNetworthModal();showNotif(`Net Worth set to ‚Çπ${fmt(v)}`);saveState();renderAll()}
  else showNotif("Enter a valid amount","error");
}

// ============================================================
// NOTIFICATION
// ============================================================
let notifTimer;
function showNotif(msg,type="success"){
  const el=document.getElementById("notif");
  el.textContent=(type==="error"?"‚úó  ":"‚úì  ")+msg;
  el.style.display="block";
  el.style.background=type==="error"?"rgba(184,48,37,.12)":"rgba(124,98,68,.12)";
  el.style.border=`1px solid ${type==="error"?"rgba(184,48,37,.4)":"rgba(124,98,68,.4)"}`;
  el.style.color=type==="error"?"var(--down)":"var(--accent)";
  el.style.backdropFilter="blur(16px)";
  el.style.animation="none";
  void el.offsetWidth; // force reflow
  el.style.animation="slideIn .25s cubic-bezier(.34,1.56,.64,1)";
  clearTimeout(notifTimer);
  notifTimer=setTimeout(()=>{el.style.display="none"},3500);
}

// ============================================================
// TAB SWITCHING
// ============================================================
function switchTab(tab,btn){
  activeTab=tab;
  document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
  if(btn)btn.classList.add("active");
  else { document.querySelectorAll('.nav-btn').forEach(function(b){ if(b.getAttribute('onclick') && b.getAttribute('onclick').indexOf("'" + tab + "'") > -1){ b.classList.add('active'); } }); }
  ["market","positions","orders","gtt","analytics","news"].forEach(t=>{
    const el=document.getElementById(`tab-${t}`);
    if(el)el.style.display=t===tab?"block":"none";
  });
  renderAll();
  if(tab==="news"){ if(Date.now()-lastNewsFetch>60000) fetchRealNews(); else renderNews(); }
  if(tab==="news" && typeof fetchRealNews==="function" && news.length===0) fetchRealNews();
}

// ============================================================
// DARK MODE
// ============================================================
function toggleDark(cb){document.body.classList.toggle("dark",cb.checked);renderAll()}

// ============================================================
// VERCEL URL MANAGEMENT
// ============================================================
// saveCorsKey ‚Äî legacy stub (Vercel proxy no longer needed)
function saveCorsKey(){ showNotif("FMP API se live prices aa rahi hain! ‚úÖ"); }
// ============================================================
document.addEventListener("keydown",(e)=>{
  if(e.key==="Escape"){
    // Close any open modal
    ["order-overlay","gtt-overlay","bal-overlay","nw-overlay","profile-overlay"].forEach(id=>{
      const el=document.getElementById(id);
      if(el&&el.style.display!=="none")el.style.display="none";
    });
  }
  // Quick tab switching with number keys (when no input focused)
  if(document.activeElement.tagName!=="INPUT"&&document.activeElement.tagName!=="TEXTAREA"){
    const tabs=["market","positions","orders","gtt","analytics","news"];
    const idx=parseInt(e.key)-1;
    if(idx>=0&&idx<tabs.length&&!e.ctrlKey&&!e.metaKey&&!e.altKey){
      const btn=document.querySelector(`.nav-btn[onclick*="'${tabs[idx]}'"]`);
      if(btn)switchTab(tabs[idx],btn);
    }
  }
});

// ============================================================
// ON LOAD: Build auth ticker
// ============================================================
window.addEventListener("load",()=>{
  try{ buildAuthTicker(); }catch(e){}

  // Firebase SDK load hone ka wait karo
  function waitForFirebaseAndInit(attempts){
    if(typeof firebase !== 'undefined'){
      const fbOk = initFirebase();
      const banner = document.getElementById('fb-banner');
      if(fbOk && !FIREBASE_CONFIG.apiKey.includes('DEMO')){
        if(banner) banner.style.display='none';
        // onAuthStateChanged handle karega auto-login
        // Fallback: agar 2 seconds me auto-login nahi hua toh picker dikhao
        setTimeout(()=>{
          if(!user){
            try{ buildAccountPickerLocal(); }catch(ex){ showAuthForm('first'); }
          }
        }, 2000);
      } else {
        if(banner){
          banner.style.display='block';
          banner.style.background='rgba(124,98,68,0.1)';
          banner.style.border='1px solid rgba(124,98,68,0.3)';
          banner.style.color='#7c6244';
          banner.innerHTML='üì¶ <b>Local Mode</b> ‚Äî Data is device pe save ho raha hai';
        }
        setTimeout(()=>{ try{ buildAccountPickerLocal(); }catch(ex){ showAuthForm('first'); } }, 300);
      }
    } else if(attempts > 0){
      console.log("Firebase SDK wait kar raha hai...", attempts);
      setTimeout(()=>waitForFirebaseAndInit(attempts-1), 300);
    } else {
      console.warn("Firebase SDK load nahi hua ‚Äî local mode");
      setTimeout(()=>{ try{ buildAccountPickerLocal(); }catch(ex){ showAuthForm('first'); } }, 300);
    }
  }
  waitForFirebaseAndInit(15); // 15 √ó 300ms = 4.5 seconds max wait
});

function buildAccountPickerLocal(){
  const users = getAllUsers();
  if(users.length===0){ showAuthForm('first'); return; }
  buildAccountPicker();
}
</script>
</body>
</html>
